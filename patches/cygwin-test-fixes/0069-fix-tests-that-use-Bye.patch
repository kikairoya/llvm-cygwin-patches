From 4ca21c1d177259c4cfddfe62d8abb579ee1cfd12 Mon Sep 17 00:00:00 2001
From: kikairoya <kikairoya@gmail.com>
Date: Sat, 27 Dec 2025 09:44:20 +0900
Subject: [PATCH 69/70] fix tests that use Bye

---
 clang/test/CodeGen/codegen-plugins.c      | 2 +-
 clang/test/CodeGen/pass-plugins.c         | 2 +-
 clang/test/lit.cfg.py                     | 3 +++
 llvm/examples/Bye/CMakeLists.txt          | 2 +-
 llvm/examples/IRTransforms/CMakeLists.txt | 2 +-
 llvm/test/CMakeLists.txt                  | 2 +-
 llvm/test/Feature/codegen-plugin.ll       | 2 +-
 7 files changed, 9 insertions(+), 6 deletions(-)

diff --git a/clang/test/CodeGen/codegen-plugins.c b/clang/test/CodeGen/codegen-plugins.c
index 1506563f4929536bde8e4d70b6bd6a7d628634de..3f53999c03bdea6f2f033345673054767ce13cb7 100644
--- a/clang/test/CodeGen/codegen-plugins.c
+++ b/clang/test/CodeGen/codegen-plugins.c
@@ -3,7 +3,7 @@
 // RUN: %clang_cc1 -emit-llvm < %s -fpass-plugin=%llvmshlibdir/Bye%pluginext -mllvm -last-words | FileCheck %s --check-prefix=CHECK-LLVM
 // RUN: not %clang_cc1 -emit-obj < %s -fpass-plugin=%llvmshlibdir/Bye%pluginext -mllvm -last-words 2>&1 | FileCheck %s --check-prefix=CHECK-ERR
 // REQUIRES: plugins, llvm-examples
-// UNSUPPORTED: target={{.*windows.*}}
+// UNSUPPORTED: (system-windows || system-cygwin) && !llvm-dylib
 // Plugins are currently broken on AIX, at least in the CI.
 // XFAIL: target={{.*}}-aix{{.*}}
 // CHECK-INACTIVE-NOT: Bye
diff --git a/clang/test/CodeGen/pass-plugins.c b/clang/test/CodeGen/pass-plugins.c
index a87e36c7c725c87c602f9a5c912f37e7721aaecb..e19334502a2f3710b3493d38c84e69864063d7a2 100644
--- a/clang/test/CodeGen/pass-plugins.c
+++ b/clang/test/CodeGen/pass-plugins.c
@@ -1,7 +1,7 @@
 // RUN: %clang_cc1 -S < %s -fpass-plugin=%llvmshlibdir/Bye%pluginext -O2 2>&1 | FileCheck %s --check-prefix=CHECK-INACTIVE
 // RUN: %clang_cc1 -S < %s -fpass-plugin=%llvmshlibdir/Bye%pluginext -O2 -mllvm -wave-goodbye 2>&1 | FileCheck %s --check-prefix=CHECK-ACTIVE
 // REQUIRES: plugins, llvm-examples
-// UNSUPPORTED: target={{.*windows.*}}
+// UNSUPPORTED: (system-windows || system-cygwin) && !llvm-dylib
 // Plugins are currently broken on AIX, at least in the CI.
 // XFAIL: target={{.*}}-aix{{.*}}
 // CHECK-INACTIVE-NOT: Bye
diff --git a/clang/test/lit.cfg.py b/clang/test/lit.cfg.py
index d468ff49a7320cb748ad6d1505cca48a405630c5..e33a487c9b6b75942c0deb1c674755cb76253607 100644
--- a/clang/test/lit.cfg.py
+++ b/clang/test/lit.cfg.py
@@ -281,6 +281,9 @@ if "aarch64" in config.host_arch:
 if not (config.build_shared_libs or config.link_llvm_dylib or config.link_clang_dylib):
     config.available_features.add("static-libs")
 
+if config.link_llvm_dylib:
+    config.available_features.add("llvm-dylib")
+
 # Plugins (loadable modules)
 if config.has_plugins and config.llvm_plugin_ext:
     config.available_features.add("plugins")
diff --git a/llvm/examples/Bye/CMakeLists.txt b/llvm/examples/Bye/CMakeLists.txt
index 7dd04f903323d3bff94686eb266f7fb24456a7bf..0af18b2d73c41d94bb2512c9dff712667a5cd9df 100644
--- a/llvm/examples/Bye/CMakeLists.txt
+++ b/llvm/examples/Bye/CMakeLists.txt
@@ -6,7 +6,7 @@ endif()
 # but expects them to exist in the process loading the plugin. This doesn't
 # work with DLLs on Windows (where a shared library can't have undefined
 # references), so just skip this example on Windows.
-if (NOT WIN32 AND NOT CYGWIN)
+if (NOT (WIN32 OR CYGWIN) OR LLVM_LINK_LLVM_DYLIB)
   add_llvm_pass_plugin(Bye
     Bye.cpp
     DEPENDS
diff --git a/llvm/examples/IRTransforms/CMakeLists.txt b/llvm/examples/IRTransforms/CMakeLists.txt
index 3941d5f7d49f24cfa3618fcbe6684bc3b61a7d21..31a8e24f768dde81610e54701e69008acd09b3e2 100644
--- a/llvm/examples/IRTransforms/CMakeLists.txt
+++ b/llvm/examples/IRTransforms/CMakeLists.txt
@@ -6,7 +6,7 @@ endif()
 # but expects them to exist in the process loading the plugin. This doesn't
 # work with DLLs on Windows (where a shared library can't have undefined
 # references), so just skip this example on Windows.
-if (NOT WIN32 AND NOT CYGWIN)
+if (NOT (WIN32 OR CYGWIN) OR LLVM_LINK_LLVM_DYLIB)
   add_llvm_pass_plugin(ExampleIRTransforms
     SimplifyCFG.cpp
     DEPENDS
diff --git a/llvm/test/CMakeLists.txt b/llvm/test/CMakeLists.txt
index 77fbbe28ca56d28dbedc5108fee880b4d34c6a99..c52d23ba9ecf21b344af527d4251a78936982128 100644
--- a/llvm/test/CMakeLists.txt
+++ b/llvm/test/CMakeLists.txt
@@ -205,7 +205,7 @@ if(LLVM_INCLUDE_EXAMPLES)
       LLJITWithRemoteDebugging
       )
   endif()
-  if (NOT WIN32 AND NOT CYGWIN)
+  if (NOT (WIN32 OR CYGWIN) OR LLVM_LINK_LLVM_DYLIB)
     list(APPEND LLVM_TEST_DEPENDS
       Bye
       ExampleIRTransforms
diff --git a/llvm/test/Feature/codegen-plugin.ll b/llvm/test/Feature/codegen-plugin.ll
index cd36ef14d8ec3311a5ad43f3b1c7448d5ff8c9e1..38d8210e62fc286a3fdc4edd38f96882fb4452b7 100644
--- a/llvm/test/Feature/codegen-plugin.ll
+++ b/llvm/test/Feature/codegen-plugin.ll
@@ -3,7 +3,7 @@
 ; RUN: llc < %s %loadnewpmbye -last-words | FileCheck %s --check-prefix=CHECK-ACTIVE
 ; RUN: not llc < %s %loadnewpmbye -last-words -filetype=obj 2>&1 | FileCheck %s --check-prefix=CHECK-ERR
 ; REQUIRES: plugins, examples
-; UNSUPPORTED: target={{.*windows.*}}
+; UNSUPPORTED: (system-windows || system-cygwin) && !llvm-dylib
 ; Plugins are currently broken on AIX, at least in the CI.
 ; XFAIL: target={{.*}}-aix{{.*}}
 ; CHECK-ASM: somefunk:
-- 
2.52.0

