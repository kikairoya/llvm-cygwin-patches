From 981fe16fdb6e1e7e93fecd60abf66651f3accfb7 Mon Sep 17 00:00:00 2001
From: kikairoya <kikairoya@gmail.com>
Date: Sun, 25 May 2025 14:11:29 +0900
Subject: [PATCH 27/42] [compiler-rt][Test][Cygwin] Make test runnable for
 Cygwin target

---
 compiler-rt/test/CMakeLists.txt                   |  2 +-
 compiler-rt/test/builtins/Unit/lit.cfg.py         | 11 +++++++++++
 compiler-rt/test/lit.common.cfg.py                |  2 +-
 compiler-rt/test/profile/Windows/lit.local.cfg.py |  2 +-
 compiler-rt/test/profile/lit.cfg.py               |  1 +
 5 files changed, 15 insertions(+), 3 deletions(-)

diff --git a/compiler-rt/test/CMakeLists.txt b/compiler-rt/test/CMakeLists.txt
index c1b4caf15fff446b1780c411a4df368cdf310dc2..97452818ef523c5f25738a312be47da69741d75f 100644
--- a/compiler-rt/test/CMakeLists.txt
+++ b/compiler-rt/test/CMakeLists.txt
@@ -79,7 +79,7 @@ if(COMPILER_RT_CAN_EXECUTE_TESTS)
   if(COMPILER_RT_BUILD_BUILTINS OR COMPILER_RT_TEST_EXTERNAL_BUILTINS)
     add_subdirectory(builtins)
   endif()
-  if(COMPILER_RT_BUILD_SANITIZERS)
+  if(COMPILER_RT_BUILD_SANITIZERS AND COMPILER_RT_HAS_SANITIZER_COMMON)
     compiler_rt_test_runtime(interception)
 
     compiler_rt_test_runtime(lsan)
diff --git a/compiler-rt/test/builtins/Unit/lit.cfg.py b/compiler-rt/test/builtins/Unit/lit.cfg.py
index 59da054848f3ca307629ad27516bdac288c7bc35..820ddf2e61426a59d53c7dab69213bbdef1f45d6 100644
--- a/compiler-rt/test/builtins/Unit/lit.cfg.py
+++ b/compiler-rt/test/builtins/Unit/lit.cfg.py
@@ -97,6 +97,17 @@ elif config.target_os == "Windows":
             + " -lmingw32 -lmoldname -lmingwex -lmsvcrt -ladvapi32 -lshell32 -luser32 -lkernel32 ",
         )
     )
+elif config.target_os == "CYGWIN":
+    base_lib = os.path.join(
+        config.compiler_rt_libdir, "libclang_rt.builtins%s.a" % config.target_suffix
+    )
+    config.substitutions.append(
+        (
+            "%librt ",
+            base_lib
+            + " -lcygwin -ladvapi32 -lshell32 -luser32 -lkernel32 -lcygwin ",
+        )
+    )
 else:
     base_lib = os.path.join(
         config.compiler_rt_libdir, "libclang_rt.builtins%s.a" % config.target_suffix
diff --git a/compiler-rt/test/lit.common.cfg.py b/compiler-rt/test/lit.common.cfg.py
index 407537e53fd886a4f92b5140278e88e834824755..e0664ee5334525c9b2a419dbf4681de8b19e1e93 100644
--- a/compiler-rt/test/lit.common.cfg.py
+++ b/compiler-rt/test/lit.common.cfg.py
@@ -78,7 +78,7 @@ def find_compiler_libdir():
 
 
 def push_dynamic_library_lookup_path(config, new_path):
-    if platform.system() == "Windows":
+    if platform.system() == "Windows" or platform.sys.platform == 'cygwin':
         dynamic_library_lookup_var = "PATH"
     elif platform.system() == "Darwin":
         dynamic_library_lookup_var = "DYLD_LIBRARY_PATH"
diff --git a/compiler-rt/test/profile/Windows/lit.local.cfg.py b/compiler-rt/test/profile/Windows/lit.local.cfg.py
index b622e072bcbfbc28554b5bd44c178de15b016823..2b64b52bf7f1ecb3187ef74ba228056eda52ebe3 100644
--- a/compiler-rt/test/profile/Windows/lit.local.cfg.py
+++ b/compiler-rt/test/profile/Windows/lit.local.cfg.py
@@ -6,5 +6,5 @@ def getRoot(config):
 
 root = getRoot(config)
 
-if root.target_os not in ["Windows"]:
+if root.target_os not in ["Windows", "CYGWIN"]:
     config.unsupported = True
diff --git a/compiler-rt/test/profile/lit.cfg.py b/compiler-rt/test/profile/lit.cfg.py
index df7f11e2b286b60c7c99ff88b267ffb4cb4d54a2..9b128ed44b19dc64dae41881c3829252d26c72b2 100644
--- a/compiler-rt/test/profile/lit.cfg.py
+++ b/compiler-rt/test/profile/lit.cfg.py
@@ -163,6 +163,7 @@ if config.target_os not in [
     "SunOS",
     "AIX",
     "Haiku",
+    "CYGWIN",
 ]:
     config.unsupported = True
 
-- 
2.52.0

