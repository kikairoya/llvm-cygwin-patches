From e18055e989abf5cf9aa5445dd6e6a4a37c6c2711 Mon Sep 17 00:00:00 2001
From: kikairoya <kikairoya@gmail.com>
Date: Fri, 5 Dec 2025 19:56:11 +0900
Subject: [PATCH 66/66] [Plugin][unittest] Disable unittests for plugin when
 BUILD_SHARED_LIBS on Windows

---
 llvm/unittests/Analysis/PluginInlineAdvisorAnalysisTest.cpp | 4 +++-
 llvm/unittests/Analysis/PluginInlineOrderAnalysisTest.cpp   | 4 +++-
 2 files changed, 6 insertions(+), 2 deletions(-)

diff --git a/llvm/unittests/Analysis/PluginInlineAdvisorAnalysisTest.cpp b/llvm/unittests/Analysis/PluginInlineAdvisorAnalysisTest.cpp
index 0218543e9e6cbbaa1f02f973479a09da2ce1c8cd..90f388d4e91d9193dabec9835547e2c10c5cad00 100644
--- a/llvm/unittests/Analysis/PluginInlineAdvisorAnalysisTest.cpp
+++ b/llvm/unittests/Analysis/PluginInlineAdvisorAnalysisTest.cpp
@@ -245,7 +245,9 @@ define i32 @fib_check(){
 // check that loading a plugin works
 // the plugin being loaded acts identically to the default inliner
 TEST(PluginInlineAdvisorTest, PluginLoad) {
-#if !defined(LLVM_ENABLE_PLUGINS)
+#if !defined(LLVM_ENABLE_PLUGINS) ||                                           \
+    ((defined(_WIN32) || defined(__CYGWIN__)) &&                               \
+     defined(LLVM_BUILD_SHARED_LIBS))
   // Skip the test if plugins are disabled.
   GTEST_SKIP();
 #endif
diff --git a/llvm/unittests/Analysis/PluginInlineOrderAnalysisTest.cpp b/llvm/unittests/Analysis/PluginInlineOrderAnalysisTest.cpp
index cb2d23c9bad9af0595b30bc2fe817b3537b95e43..e59f88b5a9ad05138e51d3b34cfae1959527d699 100644
--- a/llvm/unittests/Analysis/PluginInlineOrderAnalysisTest.cpp
+++ b/llvm/unittests/Analysis/PluginInlineOrderAnalysisTest.cpp
@@ -223,7 +223,9 @@ define i32 @fib_check(){
 // The custom order drops any functions named "foo" so all tests
 // should contain at least one function named foo.
 TEST(PluginInlineOrderTest, NoInlineFoo) {
-#if !defined(LLVM_ENABLE_PLUGINS)
+#if !defined(LLVM_ENABLE_PLUGINS) ||                                           \
+    ((defined(_WIN32) || defined(__CYGWIN__)) &&                               \
+     defined(LLVM_BUILD_SHARED_LIBS))
   // Skip the test if plugins are disabled.
   GTEST_SKIP();
 #endif
-- 
2.52.0

