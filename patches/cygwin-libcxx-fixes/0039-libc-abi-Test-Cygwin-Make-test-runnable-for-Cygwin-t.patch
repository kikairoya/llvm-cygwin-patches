From 44eca7836537fd5d88e98b990caf35e9f79a6835 Mon Sep 17 00:00:00 2001
From: kikairoya <kikairoya@gmail.com>
Date: Sun, 25 May 2025 14:11:29 +0900
Subject: [PATCH 39/46] [libc++abi][Test][Cygwin] Make test runnable for Cygwin
 target

---
 libcxxabi/CMakeLists.txt                      |  2 ++
 .../test/configs/llvm-libc++abi-cygwin.cfg.in | 25 +++++++++++++++++++
 2 files changed, 27 insertions(+)
 create mode 100644 libcxxabi/test/configs/llvm-libc++abi-cygwin.cfg.in

diff --git a/libcxxabi/CMakeLists.txt b/libcxxabi/CMakeLists.txt
index 3069c0b066db6bde8fad24b673bb8bf1a5f5b863..807aa894aa3d6dce9f85fafe3cb7b90ed74044aa 100644
--- a/libcxxabi/CMakeLists.txt
+++ b/libcxxabi/CMakeLists.txt
@@ -148,6 +148,8 @@ option(LIBCXXABI_HERMETIC_STATIC_LIBRARY
 
 if(MINGW)
   set(LIBCXXABI_DEFAULT_TEST_CONFIG "llvm-libc++abi-mingw.cfg.in")
+elseif(CYGWIN)
+  set(LIBCXXABI_DEFAULT_TEST_CONFIG "llvm-libc++abi-cygwin.cfg.in")
 elseif(WIN32) # clang-cl
   if (LIBCXXABI_ENABLE_SHARED)
     set(LIBCXXABI_DEFAULT_TEST_CONFIG "llvm-libc++abi-shared-clangcl.cfg.in")
diff --git a/libcxxabi/test/configs/llvm-libc++abi-cygwin.cfg.in b/libcxxabi/test/configs/llvm-libc++abi-cygwin.cfg.in
new file mode 100644
index 0000000000000000000000000000000000000000..938d627fa42d779ca01f5b62bc9a6dbe33b92a5b
--- /dev/null
+++ b/libcxxabi/test/configs/llvm-libc++abi-cygwin.cfg.in
@@ -0,0 +1,25 @@
+# This testing configuration handles running the test suite against LLVM's libc++abi
+# using a static library merged into libc++ with Cygwin.
+
+lit_config.load_config(config, '@CMAKE_CURRENT_BINARY_DIR@/cmake-bridge.cfg')
+
+config.substitutions.append(('%{flags}', ''))
+config.substitutions.append(('%{compile_flags}',
+    '-nostdinc++ -I %{include} -I %{cxx-include} -I %{cxx-target-include} %{maybe-include-libunwind} -I %{libcxx}/test/support -I %{libcxx}/src -D_LIBCPP_ENABLE_CXX17_REMOVED_UNEXPECTED_FUNCTIONS'
+))
+config.substitutions.append(('%{link_flags}',
+    '-nostdlib++ -L %{lib} -lc++'
+))
+config.substitutions.append(('%{exec}',
+    '%{executor} --execdir %{temp} --prepend_env PATH=%{install-prefix}/bin -- '
+))
+
+import os, site
+site.addsitedir(os.path.join('@LIBCXXABI_LIBCXX_PATH@', 'utils'))
+import libcxx.test.params, libcxx.test.config
+libcxx.test.config.configure(
+    libcxx.test.params.DEFAULT_PARAMETERS,
+    libcxx.test.features.DEFAULT_FEATURES,
+    config,
+    lit_config
+)
-- 
2.52.0

