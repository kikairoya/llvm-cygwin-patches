From 50fa0ddc125d7663137714f02de3ec2a867e465a Mon Sep 17 00:00:00 2001
From: kikairoya <kikairoya@gmail.com>
Date: Mon, 5 May 2025 08:28:22 +0900
Subject: [PATCH 10/36] (Draft)[Clang-Tidy][Test][Cygwin] Make plugin tests
 buildable and pass

---
 clang-tools-extra/clang-tidy/CMakeLists.txt   |  7 ++++-
 clang-tools-extra/test/CMakeLists.txt         | 31 +++++++++++--------
 .../InlineAdvisorPlugin/CMakeLists.txt        |  4 ++-
 .../Analysis/InlineOrderPlugin/CMakeLists.txt |  4 ++-
 4 files changed, 30 insertions(+), 16 deletions(-)

diff --git a/clang-tools-extra/clang-tidy/CMakeLists.txt b/clang-tools-extra/clang-tidy/CMakeLists.txt
index 153356245cfd..f2b0175a0e5b 100644
--- a/clang-tools-extra/clang-tidy/CMakeLists.txt
+++ b/clang-tools-extra/clang-tidy/CMakeLists.txt
@@ -8,7 +8,12 @@ configure_file(
   ${CMAKE_CURRENT_BINARY_DIR}/clang-tidy-config.h)
 include_directories(BEFORE ${CMAKE_CURRENT_BINARY_DIR})
 
-add_clang_library(clangTidy STATIC
+set(linktype STATIC)
+if ((WIN32 OR CYGWIN) AND CLANG_LINK_CLANG_DYLIB)
+  set(linktype SHARED)
+endif()
+
+add_clang_library(clangTidy ${linktype}
   ClangTidy.cpp
   ClangTidyCheck.cpp
   ClangTidyModule.cpp
diff --git a/clang-tools-extra/test/CMakeLists.txt b/clang-tools-extra/test/CMakeLists.txt
index 78447e7a00db..d02ad97d15a3 100644
--- a/clang-tools-extra/test/CMakeLists.txt
+++ b/clang-tools-extra/test/CMakeLists.txt
@@ -63,21 +63,26 @@ foreach(dep ${LLVM_UTILS_DEPS})
   endif()
 endforeach()
 
-if (NOT WIN32 OR NOT LLVM_LINK_LLVM_DYLIB)
+if (NOT (WIN32 OR CYGWIN) OR CLANG_PLUGIN_SUPPORT)
   llvm_add_library(
-      CTTestTidyModule
-      MODULE clang-tidy/CTTestTidyModule.cpp
-      PLUGIN_TOOL clang-tidy)
-endif()
+    CTTestTidyModule
+    MODULE clang-tidy/CTTestTidyModule.cpp
+    PLUGIN_TOOL clang-tidy)
+
+  list(APPEND CLANG_TOOLS_TEST_DEPS CTTestTidyModule)
+  target_include_directories(CTTestTidyModule PUBLIC BEFORE "${CLANG_TOOLS_SOURCE_DIR}")
 
-if(TARGET CTTestTidyModule)
-    list(APPEND CLANG_TOOLS_TEST_DEPS CTTestTidyModule)
-    target_include_directories(CTTestTidyModule PUBLIC BEFORE "${CLANG_TOOLS_SOURCE_DIR}")
-    if(CLANG_PLUGIN_SUPPORT AND (WIN32 OR CYGWIN))
-      set(LLVM_LINK_COMPONENTS
-        Support
-      )
-    endif()
+  if ((WIN32 OR CYGWIN) AND NOT LLVM_EXPORT_SYMBOLS_FOR_PLUGINS)
+    target_link_libraries(CTTestTidyModule PRIVATE clangTidy)
+    clang_target_link_libraries(CTTestTidyModule
+      PRIVATE
+      clangAST
+      clangASTMatchers
+      clangBasic
+      clangTooling
+      clangToolingCore
+    )
+  endif()
 endif()
 
 add_lit_testsuite(check-clang-extra "Running clang-tools-extra/test"
diff --git a/llvm/unittests/Analysis/InlineAdvisorPlugin/CMakeLists.txt b/llvm/unittests/Analysis/InlineAdvisorPlugin/CMakeLists.txt
index d9da627ad52e..f72ea29346c5 100644
--- a/llvm/unittests/Analysis/InlineAdvisorPlugin/CMakeLists.txt
+++ b/llvm/unittests/Analysis/InlineAdvisorPlugin/CMakeLists.txt
@@ -3,7 +3,9 @@
 # doesn't work with DLLs on Windows (where a shared library can't have undefined
 # references), so just skip this testcase on Windows.
 if ((NOT WIN32 AND NOT CYGWIN) OR LLVM_BUILD_LLVM_DYLIB)
-  unset(LLVM_LINK_COMPONENTS)
+  if (NOT WIN32 AND NOT CYGWIN)
+    unset(LLVM_LINK_COMPONENTS)
+  endif()
   add_llvm_library(InlineAdvisorPlugin MODULE BUILDTREE_ONLY
     InlineAdvisorPlugin.cpp
     )
diff --git a/llvm/unittests/Analysis/InlineOrderPlugin/CMakeLists.txt b/llvm/unittests/Analysis/InlineOrderPlugin/CMakeLists.txt
index 941e18efc1a5..8666c5912f3f 100644
--- a/llvm/unittests/Analysis/InlineOrderPlugin/CMakeLists.txt
+++ b/llvm/unittests/Analysis/InlineOrderPlugin/CMakeLists.txt
@@ -3,7 +3,9 @@
 # doesn't work with DLLs on Windows (where a shared library can't have undefined
 # references), so just skip this testcase on Windows.
 if ((NOT WIN32 AND NOT CYGWIN) OR LLVM_BUILD_LLVM_DYLIB)
-  unset(LLVM_LINK_COMPONENTS)
+  if (NOT WIN32 AND NOT CYGWIN)
+    unset(LLVM_LINK_COMPONENTS)
+  endif()
   add_llvm_library(InlineOrderPlugin MODULE BUILDTREE_ONLY
     InlineOrderPlugin.cpp
     )
-- 
2.51.2

