From e07f1c6b2df2b93208318ee0952e91fa15085e2a Mon Sep 17 00:00:00 2001
From: kikairoya <kikairoya@gmail.com>
Date: Sun, 2 Nov 2025 12:42:37 +0900
Subject: [PATCH 44/58] fix -fno-dllexport-inlines

---
 clang/lib/Sema/SemaDecl.cpp                   | 30 +++++++++++++++++++
 .../dllexport-no-dllexport-inlines.cpp        |  6 ++--
 2 files changed, 33 insertions(+), 3 deletions(-)

diff --git a/clang/lib/Sema/SemaDecl.cpp b/clang/lib/Sema/SemaDecl.cpp
index ae779d6830d9b44d7125f6261fc3d0e2917c678a..5f8d4e1620bf4cf9945048bf843fbc818563d402 100644
--- a/clang/lib/Sema/SemaDecl.cpp
+++ b/clang/lib/Sema/SemaDecl.cpp
@@ -3964,6 +3964,36 @@ bool Sema::MergeFunctionDecl(FunctionDecl *New, NamedDecl *&OldD, Scope *S,
     UndefinedButUsed.insert(std::make_pair(Old->getCanonicalDecl(),
                                            SourceLocation()));
 
+  if ((!Context.getTargetInfo().shouldDLLImportComdatSymbols() ||
+       !getLangOpts().DllExportInlines) &&
+      !Old->isInlined() && New->isInlined()) {
+    if (auto *MD = dyn_cast<CXXMethodDecl>(Old); MD) {
+      auto *Class = MD->getParent();
+      assert(Class && "MD->getParent() != nullptr");
+      auto *ClassAttr = getDLLAttr(Class);
+      auto *OldAttr = getDLLAttr(Old);
+      auto *NewAttr = getDLLAttr(New);
+      TemplateSpecializationKind TSK = Class->getTemplateSpecializationKind();
+      if (ClassAttr && !NewAttr && OldAttr && OldAttr->isInherited() &&
+          TSK != TSK_ExplicitInstantiationDeclaration &&
+          TSK != TSK_ExplicitInstantiationDefinition) {
+        if (Context.getTargetInfo().shouldDLLImportComdatSymbols()) {
+          InheritableAttr *NewAttr = nullptr;
+          if (ClassAttr->getKind() == attr::DLLExport) {
+            NewAttr = ::new (getASTContext())
+                DLLExportStaticLocalAttr(getASTContext(), *ClassAttr);
+          } else {
+            NewAttr = ::new (getASTContext())
+                DLLImportStaticLocalAttr(getASTContext(), *ClassAttr);
+          }
+          NewAttr->setInherited(true);
+          MD->addAttr(NewAttr);
+        }
+        MD->dropAttrs<DLLImportAttr, DLLExportAttr>();
+      }
+    }
+  }
+
   // If this redeclaration makes it newly gnu_inline, we don't want to warn
   // about it.
   if (New->hasAttr<GNUInlineAttr>() &&
diff --git a/clang/test/CodeGenCXX/dllexport-no-dllexport-inlines.cpp b/clang/test/CodeGenCXX/dllexport-no-dllexport-inlines.cpp
index 15ec6798563acc642d542075fea64db44a850fae..d97ca55c8689c2835f09157d5aacfa40232f449d 100644
--- a/clang/test/CodeGenCXX/dllexport-no-dllexport-inlines.cpp
+++ b/clang/test/CodeGenCXX/dllexport-no-dllexport-inlines.cpp
@@ -49,13 +49,13 @@ struct __declspec(dllexport) ExportedClass {
   // MINGW-DAG: define linkonce_odr dso_local noundef i32 @_ZN13ExportedClass39InlineOutclassDefFuncWithStaticVariableEv
   inline int InlineOutclassDefFuncWithStaticVariable();
 
-  // NOEXPORTINLINE-DAG: define weak_odr dso_local dllexport void @"?InlineLaterOutclassDefFunc@ExportedClass@@QEAAXXZ
+  // NOEXPORTINLINE-DAG: define linkonce_odr dso_local void @"?InlineLaterOutclassDefFunc@ExportedClass@@QEAAXXZ
   // EXPORTINLINE-DAG: define weak_odr dso_local dllexport void @"?InlineLaterOutclassDefFunc@ExportedClass@@QEAAXXZ
-  // MINGW-DAG: define weak_odr dso_local dllexport void @_ZN13ExportedClass26InlineLaterOutclassDefFuncEv
+  // MINGW-DAG: define linkonce_odr dso_local void @_ZN13ExportedClass26InlineLaterOutclassDefFuncEv
   void InlineLaterOutclassDefFunc();
 
   // CHECK-DAG: define weak_odr dso_local dllexport noundef i32 @"?InlineLaterOutclassDefFuncWithStaticVariable@ExportedClass@@QEAAHXZ"
-  // MINGW-DAG: define weak_odr dso_local dllexport noundef i32 @_ZN13ExportedClass44InlineLaterOutclassDefFuncWithStaticVariableEv
+  // MINGW-DAG: define linkonce_odr dso_local noundef i32 @_ZN13ExportedClass44InlineLaterOutclassDefFuncWithStaticVariableEv
   int InlineLaterOutclassDefFuncWithStaticVariable();
 
   // CHECK-DAG: define dso_local dllexport void @"?OutoflineDefFunc@ExportedClass@@QEAAXXZ"
-- 
2.52.0

