From 4a5e22bfd9ba1ef09a20462cfa81e53eb3512ada Mon Sep 17 00:00:00 2001
From: kikairoya <kikairoya@gmail.com>
Date: Mon, 5 May 2025 08:28:22 +0900
Subject: [PATCH 14/37] (Draft)[Clang-Tidy][Test][Cygwin] Make plugin tests
 buildable and pass

---
 clang-tools-extra/test/CMakeLists.txt                      | 2 +-
 llvm/unittests/Analysis/InlineAdvisorPlugin/CMakeLists.txt | 4 +++-
 llvm/unittests/Analysis/InlineOrderPlugin/CMakeLists.txt   | 4 +++-
 3 files changed, 7 insertions(+), 3 deletions(-)

diff --git a/clang-tools-extra/test/CMakeLists.txt b/clang-tools-extra/test/CMakeLists.txt
index a70d2ef2d92f..f4b041afeb25 100644
--- a/clang-tools-extra/test/CMakeLists.txt
+++ b/clang-tools-extra/test/CMakeLists.txt
@@ -63,7 +63,7 @@ foreach(dep ${LLVM_UTILS_DEPS})
   endif()
 endforeach()
 
-if (NOT WIN32 OR NOT LLVM_LINK_LLVM_DYLIB)
+if (NOT (WIN32 OR CYGWIN) OR LLVM_EXPORT_SYMBOLS_FOR_PLUGINS)
   llvm_add_library(
       CTTestTidyModule
       MODULE clang-tidy/CTTestTidyModule.cpp
diff --git a/llvm/unittests/Analysis/InlineAdvisorPlugin/CMakeLists.txt b/llvm/unittests/Analysis/InlineAdvisorPlugin/CMakeLists.txt
index d9da627ad52e..f72ea29346c5 100644
--- a/llvm/unittests/Analysis/InlineAdvisorPlugin/CMakeLists.txt
+++ b/llvm/unittests/Analysis/InlineAdvisorPlugin/CMakeLists.txt
@@ -3,7 +3,9 @@
 # doesn't work with DLLs on Windows (where a shared library can't have undefined
 # references), so just skip this testcase on Windows.
 if ((NOT WIN32 AND NOT CYGWIN) OR LLVM_BUILD_LLVM_DYLIB)
-  unset(LLVM_LINK_COMPONENTS)
+  if (NOT WIN32 AND NOT CYGWIN)
+    unset(LLVM_LINK_COMPONENTS)
+  endif()
   add_llvm_library(InlineAdvisorPlugin MODULE BUILDTREE_ONLY
     InlineAdvisorPlugin.cpp
     )
diff --git a/llvm/unittests/Analysis/InlineOrderPlugin/CMakeLists.txt b/llvm/unittests/Analysis/InlineOrderPlugin/CMakeLists.txt
index 941e18efc1a5..8666c5912f3f 100644
--- a/llvm/unittests/Analysis/InlineOrderPlugin/CMakeLists.txt
+++ b/llvm/unittests/Analysis/InlineOrderPlugin/CMakeLists.txt
@@ -3,7 +3,9 @@
 # doesn't work with DLLs on Windows (where a shared library can't have undefined
 # references), so just skip this testcase on Windows.
 if ((NOT WIN32 AND NOT CYGWIN) OR LLVM_BUILD_LLVM_DYLIB)
-  unset(LLVM_LINK_COMPONENTS)
+  if (NOT WIN32 AND NOT CYGWIN)
+    unset(LLVM_LINK_COMPONENTS)
+  endif()
   add_llvm_library(InlineOrderPlugin MODULE BUILDTREE_ONLY
     InlineOrderPlugin.cpp
     )
-- 
2.51.0

