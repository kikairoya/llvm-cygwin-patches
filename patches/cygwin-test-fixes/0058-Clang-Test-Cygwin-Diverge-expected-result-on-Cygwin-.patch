From 3303a9619ffdca52a87742c15c98842c1a25600d Mon Sep 17 00:00:00 2001
From: kikairoya <kikairoya@gmail.com>
Date: Sat, 11 Oct 2025 17:38:33 +0900
Subject: [PATCH 58/64] [Clang][Test][Cygwin] Diverge expected result on Cygwin
 host

---
 clang/test/CodeGen/2007-06-18-SextAttrAggregate.c |  2 +-
 clang/test/Driver/DTLTO/dtlto.c                   | 10 ++++++----
 clang/test/Driver/DTLTO/ps5-dtlto.c               | 13 ++++++++-----
 clang/test/Driver/HLSL/metal-converter.hlsl       |  4 ++++
 clang/test/Driver/clang-offload-bundler.c         |  2 +-
 clang/test/Driver/dxc_dxv_path.hlsl               |  4 ++++
 clang/test/Driver/env.c                           |  4 ++--
 clang/test/Driver/hip-version.hip                 |  1 +
 clang/test/Driver/linker-wrapper-hip-no-rdc.c     |  3 +++
 clang/test/Driver/linux-ld.c                      |  2 +-
 clang/test/Driver/loongarch-toolchain.c           |  2 +-
 clang/test/Driver/mingw-sysroot.cpp               |  2 +-
 clang/test/Driver/riscv32-toolchain.c             |  2 +-
 clang/test/Driver/riscv64-toolchain.c             |  2 +-
 clang/test/Modules/inferred-framework-case.m      |  2 +-
 clang/test/lit.cfg.py                             |  5 +++--
 16 files changed, 39 insertions(+), 21 deletions(-)

diff --git a/clang/test/CodeGen/2007-06-18-SextAttrAggregate.c b/clang/test/CodeGen/2007-06-18-SextAttrAggregate.c
index ccfdc1a1c6cfa9417c28e6abccafb08d9fe42d0e..5567ec1ab0e43c83ec6f5da8bea7d8b1d7da07d6 100644
--- a/clang/test/CodeGen/2007-06-18-SextAttrAggregate.c
+++ b/clang/test/CodeGen/2007-06-18-SextAttrAggregate.c
@@ -1,5 +1,5 @@
 // RUN: %clang_cc1 -no-enable-noundef-analysis %s -o - -emit-llvm | FileCheck %s
-// XFAIL: target={{(aarch64|arm64).*}}, target=x86_64-pc-windows-msvc, target=x86_64-{{(pc|w64)}}-windows-gnu, target=x86_64-pc-windows-cygnus
+// XFAIL: target={{(aarch64|arm64).*}}, target=x86_64{{.*-(win|mingw|cyg).*}}
 
 // PR1513
 
diff --git a/clang/test/Driver/DTLTO/dtlto.c b/clang/test/Driver/DTLTO/dtlto.c
index 5fbf7889e790b86d02addc7c564c69b0c70d2aa9..2520e1770ec7cf77007f0ab1005d2dafca552253 100644
--- a/clang/test/Driver/DTLTO/dtlto.c
+++ b/clang/test/Driver/DTLTO/dtlto.c
@@ -7,9 +7,10 @@
 // RUN: %clang -flto=thin %s -### -fuse-ld=lld --target=x86_64-linux-gnu \
 // RUN:   -Xthinlto-distributor=a1 -Xthinlto-distributor=a2,a3 \
 // RUN:   -fthinlto-distributor=d.exe -Werror >>%t_forward.log 2>&1
-// RUN: FileCheck %s --input-file=%t_forward.log --check-prefix=FORWARD
+// RUN: FileCheck %s --input-file=%t_forward.log --check-prefix=FORWARD \
+// RUN:   -DEXEEXT=%if system-cygwin %{.exe%}
 
-// FORWARD:      clang-name:[[CLANG:.*]]
+// FORWARD:      clang-name:[[CLANG:.*]][[EXEEXT]]
 // FORWARD-NEXT: prepend-arg:[[PREPEND_ARG:.*]]
 // FORWARD:      ld.lld
 // FORWARD-SAME: "--thinlto-distributor=d.exe"
@@ -36,9 +37,10 @@
 // RUN: %clang -flto=thin %s -### -fuse-ld=lld --target=x86_64-linux-gnu \
 // RUN:   -fthinlto-distributor=d.exe -Werror >>%t_default.log 2>&1
 // RUN: FileCheck %s --input-file=%t_default.log --check-prefix=DEFAULT \
-// RUN:   --implicit-check-not=distributor --implicit-check-not=remote-compiler
+// RUN:   --implicit-check-not=distributor --implicit-check-not=remote-compiler \
+// RUN:   -DEXEEXT=%if system-cygwin %{.exe%}
 
-// DEFAULT:      clang-name:[[CLANG:.*]]
+// DEFAULT:      clang-name:[[CLANG:.*]][[EXEEXT]]
 // DEFAULT-NEXT: prepend-arg:[[PREPEND_ARG:.*]]
 // DEFAULT:      ld.lld
 // DEFAULT-SAME: "--thinlto-distributor=d.exe"
diff --git a/clang/test/Driver/DTLTO/ps5-dtlto.c b/clang/test/Driver/DTLTO/ps5-dtlto.c
index b59fb485120004481806a0d712d8d990136bde7f..f9608fffd7edb7d78f6317e831c451a7ecdf2f45 100644
--- a/clang/test/Driver/DTLTO/ps5-dtlto.c
+++ b/clang/test/Driver/DTLTO/ps5-dtlto.c
@@ -7,9 +7,10 @@
 // RUN: %clang -flto=thin %s -### --target=x86_64-sie-ps5 \
 // RUN:   -Xthinlto-distributor=a1 -Xthinlto-distributor=a2,a3 \
 // RUN:   -fthinlto-distributor=d.exe -Werror >>%t_forward.log 2>&1
-// RUN: FileCheck %s --input-file=%t_forward.log --check-prefix=FORWARD
+// RUN: FileCheck %s --input-file=%t_forward.log --check-prefix=FORWARD \
+// RUN:   -DEXEEXT=%if system-cygwin %{.exe%}
 
-// FORWARD:      clang-name:[[CLANG:.*]]
+// FORWARD:      clang-name:[[CLANG:.*]][[EXEEXT]]
 // FORWARD-NEXT: prepend-arg:[[PREPEND_ARG:.*]]
 // FORWARD:      prospero-lld
 // FORWARD-SAME: "--thinlto-distributor=d.exe"
@@ -36,9 +37,10 @@
 // RUN: %clang -flto=thin %s -### --target=x86_64-sie-ps5 \
 // RUN:   -fthinlto-distributor=d.exe -Werror >>%t_default.log 2>&1
 // RUN: FileCheck %s --input-file=%t_default.log --check-prefix=DEFAULT \
-// RUN:   --implicit-check-not=distributor --implicit-check-not=remote-compiler
+// RUN:   --implicit-check-not=distributor --implicit-check-not=remote-compiler \
+// RUN:   -DEXEEXT=%if system-cygwin %{.exe%}
 
-// DEFAULT:      clang-name:[[CLANG:.*]]
+// DEFAULT:      clang-name:[[CLANG:.*]][[EXEEXT]]
 // DEFAULT-NEXT: prepend-arg:[[PREPEND_ARG:.*]]
 // DEFAULT:      prospero-lld
 // DEFAULT-SAME: "--thinlto-distributor=d.exe"
@@ -51,4 +53,5 @@
 // RUN: %clang %s -### --target=x86_64-sie-ps5 \
 // RUN:   -fthinlto-distributor=d.exe -Werror >>%t_noflto.log 2>&1
 // RUN: FileCheck %s --input-file=%t_noflto.log --check-prefix=DEFAULT \
-// RUN:   --implicit-check-not=distributor --implicit-check-not=remote-compiler
+// RUN:   --implicit-check-not=distributor --implicit-check-not=remote-compiler \
+// RUN:   -DEXEEXT=%if system-cygwin %{.exe%}
diff --git a/clang/test/Driver/HLSL/metal-converter.hlsl b/clang/test/Driver/HLSL/metal-converter.hlsl
index 5c139c62e826bff7194eb781e2e5a5a9290e9a32..f90406723dc669012c24697746805b2b866bd7ed 100644
--- a/clang/test/Driver/HLSL/metal-converter.hlsl
+++ b/clang/test/Driver/HLSL/metal-converter.hlsl
@@ -1,3 +1,7 @@
+// Windows (including Cygwin) cannot set PATH empty
+// UNSUPPORTED: system-cygwin
+// REQUIRES: !system-windows || static-libs
+
 // RUN: mkdir -p %t.dir
 // RUN: echo "dxv" > %t.dir/dxv && chmod 754 %t.dir/dxv
 
diff --git a/clang/test/Driver/clang-offload-bundler.c b/clang/test/Driver/clang-offload-bundler.c
index 6466e1870dc98e38426d3e6bde3479bc82cdbeab..70ac8b0e6a3c620b9032cd5c54b78b978fcd4097 100644
--- a/clang/test/Driver/clang-offload-bundler.c
+++ b/clang/test/Driver/clang-offload-bundler.c
@@ -1,5 +1,5 @@
 // REQUIRES: x86-registered-target
-// UNSUPPORTED: target={{.*}}-macosx{{.*}}, target={{.*}}-darwin{{.*}}, target={{.*}}-aix{{.*}}, target={{.*}}-zos{{.*}}
+// UNSUPPORTED: target={{.*}}-macosx{{.*}}, target={{.*}}-darwin{{.*}}, target={{.*}}-aix{{.*}}, target={{.*}}-zos{{.*}}, target={{.*}}-cyg{{.*}}
 
 //
 // Generate all the types of files we can bundle.
diff --git a/clang/test/Driver/dxc_dxv_path.hlsl b/clang/test/Driver/dxc_dxv_path.hlsl
index eab135c9ef3e800434f03ab73e4c5f39632b1819..78ab207e9c3e8c724a1c1b2e58e58ac07fc22c6f 100644
--- a/clang/test/Driver/dxc_dxv_path.hlsl
+++ b/clang/test/Driver/dxc_dxv_path.hlsl
@@ -1,3 +1,7 @@
+// Windows (including Cygwin) cannot set PATH empty
+// UNSUPPORTED: system-cygwin
+// REQUIRES: !system-windows || static-libs
+
 // RUN: mkdir -p %t.dir
 // RUN: env PATH="" %clang_dxc -I test -Tlib_6_3 -Fo %t.dir/a.dxo  -### %s 2>&1 | FileCheck %s
 
diff --git a/clang/test/Driver/env.c b/clang/test/Driver/env.c
index d1267c02178889940d0a8d909a71bc6e0b68049c..ab17513e5de22f963b04f56563c76451ef0632bc 100644
--- a/clang/test/Driver/env.c
+++ b/clang/test/Driver/env.c
@@ -1,6 +1,6 @@
-// Some assertions in this test use Linux style (/) file paths.
+// Some assertions in this test use Linux style (/) file paths and drop $PATH.
 // TODO: Use LIBPATH on AIX
-// UNSUPPORTED: system-windows, system-aix
+// UNSUPPORTED: system-windows, system-cygwin, system-aix
 
 // RUN: bash -c env | grep LD_LIBRARY_PATH | sed -ne 's/^.*=//p' | tr -d '\n' > %t.ld_library_path
 // The PATH variable is heavily used when trying to find a linker.
diff --git a/clang/test/Driver/hip-version.hip b/clang/test/Driver/hip-version.hip
index ccefedf816d457452717e9418ce9723046e2e674..76dfa4078c4b1fcbd09cf1012bc19bcc01467a82 100644
--- a/clang/test/Driver/hip-version.hip
+++ b/clang/test/Driver/hip-version.hip
@@ -1,6 +1,7 @@
 // REQUIRES: x86-registered-target
 // REQUIRES: amdgpu-registered-target
 // UNSUPPORTED: target={{.*}}-aix{{.*}}
+// UNSUPPORTED: system-cygwin
 
 // RUN: %clang -v --rocm-path=%S/Inputs/rocm 2>&1 \
 // RUN:   | FileCheck -check-prefixes=FOUND %s
diff --git a/clang/test/Driver/linker-wrapper-hip-no-rdc.c b/clang/test/Driver/linker-wrapper-hip-no-rdc.c
index addbec5fae6130dbffc487c5172444c3dad73630..ee4d1871d6f06f1306f9138e0df2b2b9be739141 100644
--- a/clang/test/Driver/linker-wrapper-hip-no-rdc.c
+++ b/clang/test/Driver/linker-wrapper-hip-no-rdc.c
@@ -1,6 +1,9 @@
 // REQUIRES: amdgpu-registered-target
 // REQUIRES: lld
 
+// clang-linker-wrapper doesn't work when LLD_DEFAULT_LD_LLD_IS_MINGW=ON
+// UNSUPPORTED: system-cygwin
+
 // Test HIP non-RDC linker wrapper behavior with new offload driver.
 // The linker wrapper should output .hipfb files directly without using -r option.
 
diff --git a/clang/test/Driver/linux-ld.c b/clang/test/Driver/linux-ld.c
index be3293cdc253e4b8c3a725df714525eb4195e1ba..835c9d12ce74523f9be51136094faee6900f1b11 100644
--- a/clang/test/Driver/linux-ld.c
+++ b/clang/test/Driver/linux-ld.c
@@ -1,4 +1,4 @@
-// UNSUPPORTED: system-windows
+// UNSUPPORTED: system-windows, system-cygwin
 // General tests that ld invocations on Linux targets sane. Note that we use
 // sysroot to make these tests independent of the host system.
 //
diff --git a/clang/test/Driver/loongarch-toolchain.c b/clang/test/Driver/loongarch-toolchain.c
index cfd53152b7e6ed932b9ee7a316fe17666385b485..7fea4bb1455f3916f0d8881f2d5ea3af9229c83f 100644
--- a/clang/test/Driver/loongarch-toolchain.c
+++ b/clang/test/Driver/loongarch-toolchain.c
@@ -1,4 +1,4 @@
-// UNSUPPORTED: system-windows
+// UNSUPPORTED: system-windows, system-cygwin
 /// A basic clang -cc1 command-line, and simple environment check.
 
 // RUN: %clang %s -### --target=loongarch32 2>&1 | FileCheck --check-prefix=CC1 %s -DTRIPLE=loongarch32
diff --git a/clang/test/Driver/mingw-sysroot.cpp b/clang/test/Driver/mingw-sysroot.cpp
index 8e46d23c1782dc7bfebc4e0d4c5054696cf3074b..b52c7796b5c47b0baf3774b7d4c1cfe6f4286366 100644
--- a/clang/test/Driver/mingw-sysroot.cpp
+++ b/clang/test/Driver/mingw-sysroot.cpp
@@ -1,4 +1,4 @@
-// UNSUPPORTED: system-windows
+// UNSUPPORTED: system-windows, system-cygwin
 
 // RUN: rm -rf %t.dir/testroot-gcc
 // RUN: mkdir -p %t.dir/testroot-gcc/bin
diff --git a/clang/test/Driver/riscv32-toolchain.c b/clang/test/Driver/riscv32-toolchain.c
index 04acf1e7edbe0b8f188154384c51747a8c3c73b4..c538990e0791740e53cb5caadf4f71f39a5332e6 100644
--- a/clang/test/Driver/riscv32-toolchain.c
+++ b/clang/test/Driver/riscv32-toolchain.c
@@ -1,4 +1,4 @@
-// UNSUPPORTED: system-windows
+// UNSUPPORTED: system-windows, system-cygwin
 // A basic clang -cc1 command-line, and simple environment check.
 
 // RUN: %clang -### %s --target=riscv32 \
diff --git a/clang/test/Driver/riscv64-toolchain.c b/clang/test/Driver/riscv64-toolchain.c
index 378f3d9db7bad25c7072315ae0bf4b68d23481b4..1f3f7a2791822705525cde4d08bbdb9fb165a65f 100644
--- a/clang/test/Driver/riscv64-toolchain.c
+++ b/clang/test/Driver/riscv64-toolchain.c
@@ -1,4 +1,4 @@
-// UNSUPPORTED: system-windows
+// UNSUPPORTED: system-windows, system-cygwin
 // A basic clang -cc1 command-line, and simple environment check.
 
 // RUN: %clang -### %s --target=riscv64 \
diff --git a/clang/test/Modules/inferred-framework-case.m b/clang/test/Modules/inferred-framework-case.m
index 64828b5cdd86827664016db622a73261406535b8..172df10d8084af8f52dfaaf23c1f8f3e2d93da76 100644
--- a/clang/test/Modules/inferred-framework-case.m
+++ b/clang/test/Modules/inferred-framework-case.m
@@ -1,7 +1,7 @@
 // RUN: rm -rf %t
 // RUN: %clang_cc1 -fmodules-cache-path=%t -fmodules -fimplicit-module-maps -F %S/Inputs %s -verify -DA
 // FIXME: PR20299 - getCanonicalName() is not implemented on Windows.
-// UNSUPPORTED: system-windows
+// UNSUPPORTED: system-windows, system-cygwin
 
 @import MOdule; // expected-error{{module 'MOdule' not found}}
 @import Module;
diff --git a/clang/test/lit.cfg.py b/clang/test/lit.cfg.py
index 52b275c09547599597dcb501de5c3174cf91bb73..5d5c37f1f3f413fd4a3ed326da1cf38023f875a9 100644
--- a/clang/test/lit.cfg.py
+++ b/clang/test/lit.cfg.py
@@ -294,7 +294,8 @@ if config.clang_default_cxx_stdlib != "":
     )
 
 # As of 2011.08, crash-recovery tests still do not pass on FreeBSD.
-if platform.system() not in ["FreeBSD"]:
+# Cygwin has instability about crashing
+if platform.system() not in ["FreeBSD"] and sys.platform not in ["cygwin"]:
     config.available_features.add("crash-recovery")
 
 # ANSI escape sequences in non-dumb terminal
@@ -348,7 +349,7 @@ if re.match(r"^arm64(e)?-apple-(macos|darwin)", config.target_triple):
 
 # [PR18856] Depends to remove opened file. On win32, a file could be removed
 # only if all handles were closed.
-if platform.system() not in ["Windows"]:
+if platform.system() not in ["Windows"] and sys.platform not in ["cygwin"]:
     config.available_features.add("can-remove-opened-file")
 
 # Features
-- 
2.52.0

