From 3f34345e81e8cf8d80e6cdc09a6f9caac9af806e Mon Sep 17 00:00:00 2001
From: kikairoya <kikairoya@gmail.com>
Date: Mon, 15 Dec 2025 06:45:05 +0900
Subject: [PATCH 13/19] make CTTestTidyModule work on Windows

---
 clang-tools-extra/clang-tidy/ClangTidy.cpp |  2 +-
 clang-tools-extra/test/CMakeLists.txt      | 11 ++-----
 llvm/include/llvm/Support/Registry.h       | 35 +++++++++++-----------
 3 files changed, 21 insertions(+), 27 deletions(-)

diff --git a/clang-tools-extra/clang-tidy/ClangTidy.cpp b/clang-tools-extra/clang-tidy/ClangTidy.cpp
index da2b4e577c9ed7ddba433f4b6423cb9288be46de..0ccd85ea50f2806b3925dab6c74fccf434dff014 100644
--- a/clang-tools-extra/clang-tidy/ClangTidy.cpp
+++ b/clang-tools-extra/clang-tidy/ClangTidy.cpp
@@ -49,7 +49,7 @@ using namespace clang::driver;
 using namespace clang::tooling;
 using namespace llvm;
 
-LLVM_INSTANTIATE_REGISTRY(clang::tidy::ClangTidyModuleRegistry)
+template class llvm::Registry<clang::tidy::ClangTidyModule>;
 
 namespace clang::tidy {
 
diff --git a/clang-tools-extra/test/CMakeLists.txt b/clang-tools-extra/test/CMakeLists.txt
index 78447e7a00db872342fb46a55caf213fa01cce6b..bd46d9ef1cbbb3d485adf60c9112e99fbcaa2f38 100644
--- a/clang-tools-extra/test/CMakeLists.txt
+++ b/clang-tools-extra/test/CMakeLists.txt
@@ -63,21 +63,14 @@ foreach(dep ${LLVM_UTILS_DEPS})
   endif()
 endforeach()
 
-if (NOT WIN32 OR NOT LLVM_LINK_LLVM_DYLIB)
+if (CLANG_PLUGIN_SUPPORT AND
+    (NOT (WIN32 OR CYGWIN) OR BUILD_SHARED_LIBS OR CLANG_LINK_CLANG_DYLIB))
   llvm_add_library(
       CTTestTidyModule
       MODULE clang-tidy/CTTestTidyModule.cpp
       PLUGIN_TOOL clang-tidy)
-endif()
-
-if(TARGET CTTestTidyModule)
     list(APPEND CLANG_TOOLS_TEST_DEPS CTTestTidyModule)
     target_include_directories(CTTestTidyModule PUBLIC BEFORE "${CLANG_TOOLS_SOURCE_DIR}")
-    if(CLANG_PLUGIN_SUPPORT AND (WIN32 OR CYGWIN))
-      set(LLVM_LINK_COMPONENTS
-        Support
-      )
-    endif()
 endif()
 
 add_lit_testsuite(check-clang-extra "Running clang-tools-extra/test"
diff --git a/llvm/include/llvm/Support/Registry.h b/llvm/include/llvm/Support/Registry.h
index 01f785a8fd633079237dfd49a8b5272cbac7ff12..8d9707edc8c9efe2e0c5a369543ae5f9157c7b22 100644
--- a/llvm/include/llvm/Support/Registry.h
+++ b/llvm/include/llvm/Support/Registry.h
@@ -56,8 +56,8 @@ private:
   // declaration causing error C2487 "member of dll interface class may not
   // be declared with dll interface".
   // https://developercommunity.visualstudio.com/t/c2487-in-dllexport-class-with-static-members/69878
-  static inline node *Head = nullptr;
-  static inline node *Tail = nullptr;
+  static node *Head;
+  static node *Tail;
 
 public:
   /// Node in linked list of entries.
@@ -80,13 +80,7 @@ public:
   /// add a node to the executable's registry. Therefore it's not defined here
   /// to avoid it being instantiated in the plugin and is instead defined in
   /// the executable (see LLVM_INSTANTIATE_REGISTRY below).
-  static void add_node(node *N) {
-    if (Tail)
-      Tail->Next = N;
-    else
-      Head = N;
-    Tail = N;
-  }
+  static void add_node(node *N);
 
   /// Iterators for registry entries.
   ///
@@ -137,19 +131,26 @@ public:
   };
 };
 
+// Not to inline these members, otherwise dylib builds on Cygwin/MinGW will be broken.
+template<typename T>
+typename Registry<T>::node *Registry<T>::Head = nullptr;
+template<typename T>
+typename Registry<T>::node *Registry<T>::Tail = nullptr;
+template<typename T>
+void Registry<T>::add_node(node *N) {
+  if (Tail)
+    Tail->Next = N;
+  else
+    Head = N;
+  Tail = N;
+}
+
 } // end namespace llvm
 
-#ifdef _WIN32
 /// Instantiate a registry class.
 #define LLVM_INSTANTIATE_REGISTRY(REGISTRY_CLASS)                              \
   namespace llvm {                                                             \
-  template class LLVM_ABI_EXPORT Registry<REGISTRY_CLASS::type>;               \
-  }
-#else
-#define LLVM_INSTANTIATE_REGISTRY(REGISTRY_CLASS)                              \
-  namespace llvm {                                                             \
-  template class Registry<REGISTRY_CLASS::type>;                               \
+  template class LLVM_ALWAYS_EXPORT Registry<REGISTRY_CLASS::type>;            \
   }
-#endif
 
 #endif // LLVM_SUPPORT_REGISTRY_H
-- 
2.52.0

