From c0b90cbebbc79f08b3e4d0eae9a89c0d9a0dfc92 Mon Sep 17 00:00:00 2001
From: kikairoya <kikairoya@gmail.com>
Date: Fri, 5 Dec 2025 19:59:32 +0900
Subject: [PATCH 03/19] [LLVM][Clang] Prevent symbol dup for Any::TypeId<T>

---
 clang/include/clang/Analysis/FlowSensitive/NoopLattice.h       | 3 +++
 .../lib/Analysis/FlowSensitive/TypeErasedDataflowAnalysis.cpp  | 3 +++
 llvm/include/llvm/CodeGen/MachineFunction.h                    | 3 +++
 llvm/lib/CodeGen/MachineFunction.cpp                           | 2 ++
 4 files changed, 11 insertions(+)

diff --git a/clang/include/clang/Analysis/FlowSensitive/NoopLattice.h b/clang/include/clang/Analysis/FlowSensitive/NoopLattice.h
index 96c695473b67a198280fdde4f38d4593212cb09a..acc549c97213edcff24f194a9d6acec306d3ede1 100644
--- a/clang/include/clang/Analysis/FlowSensitive/NoopLattice.h
+++ b/clang/include/clang/Analysis/FlowSensitive/NoopLattice.h
@@ -13,6 +13,7 @@
 #ifndef LLVM_CLANG_ANALYSIS_FLOWSENSITIVE_NOOP_LATTICE_H
 #define LLVM_CLANG_ANALYSIS_FLOWSENSITIVE_NOOP_LATTICE_H
 
+#include "clang/Analysis/FlowSensitive/CachedConstAccessorsLattice.h"
 #include "clang/Analysis/FlowSensitive/DataflowLattice.h"
 #include "clang/Support/Compiler.h"
 #include "llvm/ADT/Any.h"
@@ -47,6 +48,8 @@ namespace llvm {
 // CLANG_LINK_CLANG_DYLIB
 extern template struct CLANG_TEMPLATE_ABI
     Any::TypeId<clang::dataflow::NoopLattice>;
+extern template struct CLANG_TEMPLATE_ABI Any::TypeId<
+    clang::dataflow::CachedConstAccessorsLattice<clang::dataflow::NoopLattice>>;
 } // namespace llvm
 
 #endif // LLVM_CLANG_ANALYSIS_FLOWSENSITIVE_NOOP_LATTICE_H
diff --git a/clang/lib/Analysis/FlowSensitive/TypeErasedDataflowAnalysis.cpp b/clang/lib/Analysis/FlowSensitive/TypeErasedDataflowAnalysis.cpp
index 1113bbe7f4d9ce06544cb02697c1f9d0144208b4..8f5dc464726e2eceea70c69d83b1bdd0dff35e09 100644
--- a/clang/lib/Analysis/FlowSensitive/TypeErasedDataflowAnalysis.cpp
+++ b/clang/lib/Analysis/FlowSensitive/TypeErasedDataflowAnalysis.cpp
@@ -23,6 +23,7 @@
 #include "clang/AST/StmtVisitor.h"
 #include "clang/Analysis/Analyses/PostOrderCFGView.h"
 #include "clang/Analysis/CFG.h"
+#include "clang/Analysis/FlowSensitive/CachedConstAccessorsLattice.h"
 #include "clang/Analysis/FlowSensitive/DataflowEnvironment.h"
 #include "clang/Analysis/FlowSensitive/DataflowLattice.h"
 #include "clang/Analysis/FlowSensitive/DataflowWorklist.h"
@@ -49,6 +50,8 @@ namespace llvm {
 // of creating one in the test executable. when building with
 // CLANG_LINK_CLANG_DYLIB
 template struct CLANG_EXPORT_TEMPLATE Any::TypeId<clang::dataflow::NoopLattice>;
+template struct CLANG_EXPORT_TEMPLATE Any::TypeId<
+    clang::dataflow::CachedConstAccessorsLattice<clang::dataflow::NoopLattice>>;
 } // namespace llvm
 
 namespace clang {
diff --git a/llvm/include/llvm/CodeGen/MachineFunction.h b/llvm/include/llvm/CodeGen/MachineFunction.h
index 08ffdb2cb469d41bd18a9380c66055e3b7a67cfb..0f0b2d0da2dadc67abb0257170dd2c6dcca4e120 100644
--- a/llvm/include/llvm/CodeGen/MachineFunction.h
+++ b/llvm/include/llvm/CodeGen/MachineFunction.h
@@ -17,6 +17,7 @@
 #ifndef LLVM_CODEGEN_MACHINEFUNCTION_H
 #define LLVM_CODEGEN_MACHINEFUNCTION_H
 
+#include "llvm/ADT/Any.h"
 #include "llvm/ADT/ArrayRef.h"
 #include "llvm/ADT/DenseMap.h"
 #include "llvm/ADT/GraphTraits.h"
@@ -1481,6 +1482,8 @@ public:
   }
 };
 
+extern template struct LLVM_TEMPLATE_ABI Any::TypeId<const MachineFunction *>;
+
 //===--------------------------------------------------------------------===//
 // GraphTraits specializations for function basic block graphs (CFGs)
 //===--------------------------------------------------------------------===//
diff --git a/llvm/lib/CodeGen/MachineFunction.cpp b/llvm/lib/CodeGen/MachineFunction.cpp
index 8d7694537e07d88cd024fdd6de2586dd36fe2190..a371e2e818ba8362df1801d561c488cc2b87b13b 100644
--- a/llvm/lib/CodeGen/MachineFunction.cpp
+++ b/llvm/lib/CodeGen/MachineFunction.cpp
@@ -1322,6 +1322,8 @@ void MachineFunction::setUseDebugInstrRef(bool Use) {
 // Use one million as a high / reserved number.
 const unsigned MachineFunction::DebugOperandMemNumber = 1000000;
 
+template struct LLVM_EXPORT_TEMPLATE Any::TypeId<const MachineFunction *>;
+
 /// \}
 
 //===----------------------------------------------------------------------===//
-- 
2.52.0

