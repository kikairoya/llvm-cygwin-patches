From 2f831e743d350df5b81c91117841c0f4a676ad9e Mon Sep 17 00:00:00 2001
From: kikairoya <kikairoya@gmail.com>
Date: Thu, 6 Nov 2025 21:21:48 +0900
Subject: [PATCH 48/49] fix jobserver unittest

---
 llvm/lib/Support/Jobserver.cpp           | 7 ++++---
 llvm/unittests/Support/JobserverTest.cpp | 1 +
 2 files changed, 5 insertions(+), 3 deletions(-)

diff --git a/llvm/lib/Support/Jobserver.cpp b/llvm/lib/Support/Jobserver.cpp
index 9f726eb37506f75d383827bd9a3ec6899f024aa6..895e040e8c17b79f95b5a9201ac853f2f1b180c7 100644
--- a/llvm/lib/Support/Jobserver.cpp
+++ b/llvm/lib/Support/Jobserver.cpp
@@ -246,12 +246,13 @@ JobserverClient *JobserverClient::getInstance() {
   return GJobserver;
 }
 
-/// For testing purposes only. This function resets the singleton instance by
-/// destroying the existing client and re-initializing the `std::once_flag`.
+/// For testing purposes only. This function resets the reference to the
+/// existing singleton client and re-initializing the `std::once_flag`.
+/// Note that the instance shouldn't be destroyed since it might be
+/// still referenced by `ThreadPoolExecutor`.
 /// This allows tests to simulate the first-time initialization of the
 /// jobserver client multiple times.
 void JobserverClient::resetForTesting() {
-  delete GJobserver;
   GJobserver = nullptr;
   // Re-construct the std::once_flag in place to reset the singleton state.
   new (&GJobserverOnceFlag) std::once_flag();
diff --git a/llvm/unittests/Support/JobserverTest.cpp b/llvm/unittests/Support/JobserverTest.cpp
index d27445897db0a610c6bfce850a7dd5b58757563f..fc0e5143c2c357f0bda0858efa32556205d68fa6 100644
--- a/llvm/unittests/Support/JobserverTest.cpp
+++ b/llvm/unittests/Support/JobserverTest.cpp
@@ -249,6 +249,7 @@ protected:
     TheFifo.reset();
     // Restore the original strategy to ensure subsequent tests are unaffected.
     parallel::strategy = SavedStrategy;
+    JobserverClient::resetForTesting();
   }
 
   // Starts a background thread that emulates `make`. It populates the FIFO
-- 
2.51.2

