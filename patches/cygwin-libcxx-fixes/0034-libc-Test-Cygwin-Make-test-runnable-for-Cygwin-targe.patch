From c6fe38260dc6dafc244adaea75d26a832b8fc71b Mon Sep 17 00:00:00 2001
From: kikairoya <kikairoya@gmail.com>
Date: Sun, 25 May 2025 14:11:29 +0900
Subject: [PATCH 34/42] [libc++][Test][Cygwin] Make test runnable for Cygwin
 target

---
 libcxx/CMakeLists.txt                         |  4 ++-
 libcxx/test/configs/llvm-libc++-cygwin.cfg.in | 25 +++++++++++++++++++
 .../clang/clang_modules_include.gen.py        |  1 +
 .../test/libcxx/system_reserved_names.gen.py  |  6 ++++-
 libcxx/utils/libcxx/test/features/platform.py |  1 +
 5 files changed, 35 insertions(+), 2 deletions(-)
 create mode 100644 libcxx/test/configs/llvm-libc++-cygwin.cfg.in

diff --git a/libcxx/CMakeLists.txt b/libcxx/CMakeLists.txt
index fb42cb6ccdd577ac3645502cfaf969443807e1ec..05fecf9e5f19f98ad1abda8bad26f720d8ec84ba 100644
--- a/libcxx/CMakeLists.txt
+++ b/libcxx/CMakeLists.txt
@@ -148,6 +148,8 @@ if (CMAKE_CXX_COMPILER_ID STREQUAL "GNU")
   set(LIBCXX_DEFAULT_TEST_CONFIG "llvm-libc++-shared-gcc.cfg.in")
 elseif(MINGW)
   set(LIBCXX_DEFAULT_TEST_CONFIG "llvm-libc++-mingw.cfg.in")
+elseif(CYGWIN)
+  set(LIBCXX_DEFAULT_TEST_CONFIG "llvm-libc++-cygwin.cfg.in")
 elseif(WIN32) # clang-cl
   if (LIBCXX_ENABLE_SHARED)
     set(LIBCXX_DEFAULT_TEST_CONFIG "llvm-libc++-shared-clangcl.cfg.in")
@@ -870,7 +872,7 @@ if (DEFINED WIN32 AND LIBCXX_ENABLE_STATIC AND NOT LIBCXX_ENABLE_SHARED)
   config_define(ON _LIBCPP_DISABLE_VISIBILITY_ANNOTATIONS)
 endif()
 
-if (WIN32 AND LIBCXX_ENABLE_STATIC_ABI_LIBRARY)
+if ((WIN32 OR CYGWIN) AND LIBCXX_ENABLE_STATIC_ABI_LIBRARY)
   # If linking libcxxabi statically into libcxx, skip the dllimport attributes
   # on symbols we refer to from libcxxabi.
   add_definitions(-D_LIBCXXABI_DISABLE_VISIBILITY_ANNOTATIONS)
diff --git a/libcxx/test/configs/llvm-libc++-cygwin.cfg.in b/libcxx/test/configs/llvm-libc++-cygwin.cfg.in
new file mode 100644
index 0000000000000000000000000000000000000000..7e4953b3fd240ef18153dd508c680bd12afdbf52
--- /dev/null
+++ b/libcxx/test/configs/llvm-libc++-cygwin.cfg.in
@@ -0,0 +1,25 @@
+# This testing configuration handles running the test suite against LLVM's libc++
+# using either a DLL or a static library, with Cygwin.
+
+lit_config.load_config(config, '@CMAKE_CURRENT_BINARY_DIR@/cmake-bridge.cfg')
+
+config.substitutions.append(('%{flags}', '-pthread'))
+config.substitutions.append(('%{compile_flags}',
+    '-nostdinc++ -I %{target-include-dir} -I %{include-dir} -I %{libcxx-dir}/test/support'
+))
+config.substitutions.append(('%{link_flags}',
+    '-nostdlib++ -L %{lib-dir} -lc++'
+))
+config.substitutions.append(('%{exec}',
+    '%{executor} --execdir %{temp} --prepend_env PATH=%{install-prefix}/bin -- '
+))
+
+import os, site
+site.addsitedir(os.path.join('@LIBCXX_SOURCE_DIR@', 'utils'))
+import libcxx.test.params, libcxx.test.config
+libcxx.test.config.configure(
+    libcxx.test.params.DEFAULT_PARAMETERS,
+    libcxx.test.features.DEFAULT_FEATURES,
+    config,
+    lit_config
+)
diff --git a/libcxx/test/extensions/clang/clang_modules_include.gen.py b/libcxx/test/extensions/clang/clang_modules_include.gen.py
index 28661049d6e85c25547d2c63a53d89d31592f679..732de92f8b3b24c5f7ca23ab168b0fbed3859e86 100644
--- a/libcxx/test/extensions/clang/clang_modules_include.gen.py
+++ b/libcxx/test/extensions/clang/clang_modules_include.gen.py
@@ -20,6 +20,7 @@
 # The Windows headers don't appear to be compatible with modules
 # UNSUPPORTED: windows
 # UNSUPPORTED: buildhost=windows
+# UNSUPPORTED: LIBCXX-CYGWIN-FIXME
 
 # The Android headers don't appear to be compatible with modules yet
 # UNSUPPORTED: LIBCXX-ANDROID-FIXME
diff --git a/libcxx/test/libcxx/system_reserved_names.gen.py b/libcxx/test/libcxx/system_reserved_names.gen.py
index aaede220531d255e98e6d6f69d4f3d19ccb88afe..766b44e2e752d069a2e7d1653298a48c9b30fe27 100644
--- a/libcxx/test/libcxx/system_reserved_names.gen.py
+++ b/libcxx/test/libcxx/system_reserved_names.gen.py
@@ -122,7 +122,7 @@ for header in public_headers:
 #endif
 
 // Newlib & picolibc use __input as a parameter name of a64l & l64a
-#if !_LIBCPP_LIBC_NEWLIB
+#if !_LIBCPP_LIBC_NEWLIB && !defined(__CYGWIN__)
 # define __input SYSTEM_RESERVED_NAME
 #endif
 #define __output SYSTEM_RESERVED_NAME
@@ -177,8 +177,10 @@ for header in public_headers:
 #define Xs SYSTEM_RESERVED_NAME
 
 // The classic Windows min/max macros
+#ifndef __CYGWIN__
 #define min SYSTEM_RESERVED_NAME
 #define max SYSTEM_RESERVED_NAME
+#endif
 
 // Test to make sure curses has no conflicting macros with the standard library
 #define move SYSTEM_RESERVED_NAME
@@ -202,8 +204,10 @@ for header in public_headers:
 // Make sure we don't swallow the definition of the macros we push/pop
 #define STRINGIFY_IMPL(x) #x
 #define STRINGIFY(x) STRINGIFY_IMPL(x)
+#ifndef __CYGWIN__
 static_assert(__builtin_strcmp(STRINGIFY(min), STRINGIFY(SYSTEM_RESERVED_NAME)) == 0, "");
 static_assert(__builtin_strcmp(STRINGIFY(max), STRINGIFY(SYSTEM_RESERVED_NAME)) == 0, "");
+#endif
 static_assert(__builtin_strcmp(STRINGIFY(move), STRINGIFY(SYSTEM_RESERVED_NAME)) == 0, "");
 static_assert(__builtin_strcmp(STRINGIFY(erase), STRINGIFY(SYSTEM_RESERVED_NAME)) == 0, "");
 static_assert(__builtin_strcmp(STRINGIFY(refresh), STRINGIFY(SYSTEM_RESERVED_NAME)) == 0, "");
diff --git a/libcxx/utils/libcxx/test/features/platform.py b/libcxx/utils/libcxx/test/features/platform.py
index db9d3931da7fff16631984eb63cbc592889049b6..820dd75ae21e860551d4b89086878e8c6ae6f9ff 100644
--- a/libcxx/utils/libcxx/test/features/platform.py
+++ b/libcxx/utils/libcxx/test/features/platform.py
@@ -29,6 +29,7 @@ def _getAndroidDeviceApi(cfg):
 features = [
     Feature(name="darwin", when=lambda cfg: "__APPLE__" in compilerMacros(cfg)),
     Feature(name="windows", when=lambda cfg: "_WIN32" in compilerMacros(cfg)),
+    Feature(name="cygwin", when=lambda cfg: "__CYGWIN__" in compilerMacros(cfg)),
     Feature(
         name="windows-dll",
         when=lambda cfg: "_WIN32" in compilerMacros(cfg)
-- 
2.52.0

