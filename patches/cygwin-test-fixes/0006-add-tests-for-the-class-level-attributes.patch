From bdbeeac2ccefd653641ab115edf58408d8c12d91 Mon Sep 17 00:00:00 2001
From: kikairoya <kikairoya@gmail.com>
Date: Mon, 1 Dec 2025 21:15:38 +0900
Subject: [PATCH 06/61] add tests for the class-level attributes

---
 ...t_instantiation.exclude_from_dllexport.cpp | 32 +++++++++++++++++
 ...t_instantiation.exclude_from_dllimport.cpp | 34 +++++++++++++++++++
 2 files changed, 66 insertions(+)

diff --git a/clang/test/CodeGenCXX/attr-exclude_from_explicit_instantiation.exclude_from_dllexport.cpp b/clang/test/CodeGenCXX/attr-exclude_from_explicit_instantiation.exclude_from_dllexport.cpp
index a2d8e37acb626639f57f1b3db8121bcf255acb13..eba5f24f2d5ae823cc166783271fbcfad8bf1250 100644
--- a/clang/test/CodeGenCXX/attr-exclude_from_explicit_instantiation.exclude_from_dllexport.cpp
+++ b/clang/test/CodeGenCXX/attr-exclude_from_explicit_instantiation.exclude_from_dllexport.cpp
@@ -37,12 +37,29 @@ template <class T> void C<T>::to_be_exported_explicitly() noexcept {}
 template <class T> void C<T>::not_to_be_exported() noexcept {}
 template <class T> void C<T>::not_to_be_instantiated() noexcept {}
 
+// Attach the attribute to class template declaration instead of instantiation declaration.
+template <class T>
+struct __declspec(dllexport) D {
+  // This should be exported by the class-level attribute.
+  void to_be_exported() noexcept;
+
+  // This also should be exported by the class-level attribute but currently not.
+  EXCLUDE_FROM_EXPLICIT_INSTANTIATION void also_to_be_exported() noexcept;
+};
+
+template <class T> void D<T>::to_be_exported() noexcept {}
+template <class T> void D<T>::also_to_be_exported() noexcept {}
+
 // MSC: $"?to_be_exported@?$C@H@@QEAAXXZ" = comdat any
+// MSC: $"?to_be_exported@?$D@H@@QEAAXXZ" = comdat any
 // MSC: $"?to_be_exported_explicitly@?$C@H@@QEAAXXZ" = comdat any
 // MSC: $"?not_to_be_exported@?$C@H@@QEAAXXZ" = comdat any
+// MSC: $"?also_to_be_exported@?$D@H@@QEAAXXZ" = comdat any
 // GNU: $_ZN1CIiE14to_be_exportedEv = comdat any
+// GNU: $_ZN1DIiE14to_be_exportedEv = comdat any
 // GNU: $_ZN1CIiE25to_be_exported_explicitlyEv = comdat any
 // GNU: $_ZN1CIiE18not_to_be_exportedEv = comdat any
+// GNU: $_ZN1DIiE19also_to_be_exportedEv = comdat any
 
 // MSC: define weak_odr dso_local dllexport{{.*}} ptr @"??4?$C@H@@QEAAAEAU0@AEBU0@@Z"
 // MSC: define weak_odr dso_local dllexport{{.*}} void @"?to_be_exported@?$C@H@@QEAAXXZ"
@@ -50,6 +67,12 @@ template <class T> void C<T>::not_to_be_instantiated() noexcept {}
 // GNU: define weak_odr dso_local dllexport{{.*}} void @_ZN1CIiE14to_be_exportedEv
 template struct __declspec(dllexport) C<int>;
 
+// MSC: define weak_odr dso_local dllexport{{.*}} ptr @"??4?$D@H@@QEAAAEAU0@AEBU0@@Z"
+// MSC: define weak_odr dso_local dllexport{{.*}} void @"?to_be_exported@?$D@H@@QEAAXXZ"
+// GNU: define weak_odr dso_local dllexport{{.*}} ptr @_ZN1DIiEaSERKS0_
+// GNU: define weak_odr dso_local dllexport{{.*}} void @_ZN1DIiE14to_be_exportedEv
+template struct D<int>;
+
 void use() {
   C<int> c;
 
@@ -60,6 +83,12 @@ void use() {
   // MSC: call void @"?not_to_be_exported@?$C@H@@QEAAXXZ"
   // GNU: call void @_ZN1CIiE18not_to_be_exportedEv
   c.not_to_be_exported(); // implicitly instantiated here
+
+  D<int> d;
+
+  // MSC: call void @"?also_to_be_exported@?$D@H@@QEAAXXZ"
+  // GNU: call void @_ZN1DIiE19also_to_be_exportedEv
+  d.also_to_be_exported(); // implicitly instantiated here
 }
 
 // MSC: define weak_odr dso_local dllexport{{.*}} void @"?to_be_exported_explicitly@?$C@H@@QEAAXXZ"
@@ -67,3 +96,6 @@ void use() {
 
 // MSC: define linkonce_odr dso_local void @"?not_to_be_exported@?$C@H@@QEAAXXZ"
 // GNU: define linkonce_odr dso_local void @_ZN1CIiE18not_to_be_exportedEv
+
+// MSC: define linkonce_odr dso_local void @"?also_to_be_exported@?$D@H@@QEAAXXZ"
+// GNU: define linkonce_odr dso_local void @_ZN1DIiE19also_to_be_exportedEv
diff --git a/clang/test/CodeGenCXX/attr-exclude_from_explicit_instantiation.exclude_from_dllimport.cpp b/clang/test/CodeGenCXX/attr-exclude_from_explicit_instantiation.exclude_from_dllimport.cpp
index fa44f3aaa6e8a46c622e54c2f09e4d3f150d043d..f263ff070d8521f3692a5e27d9b445c214d8c5c4 100644
--- a/clang/test/CodeGenCXX/attr-exclude_from_explicit_instantiation.exclude_from_dllimport.cpp
+++ b/clang/test/CodeGenCXX/attr-exclude_from_explicit_instantiation.exclude_from_dllimport.cpp
@@ -36,10 +36,28 @@ template <class T> void C<T>::to_be_imported() noexcept {}
 template <class T> void C<T>::not_to_be_imported() noexcept {}
 template <class T> void C<T>::not_to_be_instantiated() noexcept {}
 
+// Attach the attribute to class template declaration instead of instantiation declaration.
+template <class T>
+struct __declspec(dllimport) D {
+  // This will be imported by the class-level attribute.
+  void to_be_imported() noexcept;
+
+  // This also should be imported by the class-level attribute but currently not.
+  EXCLUDE_FROM_EXPLICIT_INSTANTIATION void also_to_be_imported() noexcept;
+};
+
+template <class T> void D<T>::to_be_imported() noexcept {}
+template <class T> void D<T>::also_to_be_imported() noexcept {}
+
 // MSC: $"?not_to_be_imported@?$C@H@@QEAAXXZ" = comdat any
+// MSC: $"?also_to_be_imported@?$D@H@@QEAAXXZ" = comdat any
 // GNU: $_ZN1CIiE18not_to_be_importedEv = comdat any
+// GNU: $_ZN1DIiE19also_to_be_importedEv = comdat any
+
 extern template struct __declspec(dllimport) C<int>;
 
+extern template struct D<int>;
+
 void use() {
   C<int> c;
 
@@ -54,6 +72,16 @@ void use() {
   // MSC: call void @"?not_to_be_imported@?$C@H@@QEAAXXZ"
   // GNU: call void @_ZN1CIiE18not_to_be_importedEv
   c.not_to_be_imported(); // implicitly instantiated here
+
+  D<int> d;
+
+  // MSC: call void @"?to_be_imported@?$D@H@@QEAAXXZ"
+  // GNU: call void @_ZN1DIiE14to_be_importedEv
+  d.to_be_imported(); // implicitly instantiated here
+
+  // MSC: call void @"?also_to_be_imported@?$D@H@@QEAAXXZ"
+  // GNU: call void @_ZN1DIiE19also_to_be_importedEv
+  d.also_to_be_imported(); // implicitly instantiated here
 }
 
 // MSC: declare dllimport void @"?to_be_imported@?$C@H@@QEAAXXZ"
@@ -64,3 +92,9 @@ void use() {
 
 // MSC: define linkonce_odr dso_local void @"?not_to_be_imported@?$C@H@@QEAAXXZ"
 // GNU: define linkonce_odr dso_local void @_ZN1CIiE18not_to_be_importedEv
+
+// MSC: declare dllimport void @"?to_be_imported@?$D@H@@QEAAXXZ"
+// GNU: declare dllimport void @_ZN1DIiE14to_be_importedEv
+
+// MSC: define linkonce_odr dso_local void @"?also_to_be_imported@?$D@H@@QEAAXXZ"
+// GNU: define linkonce_odr dso_local void @_ZN1DIiE19also_to_be_importedEv
-- 
2.52.0

