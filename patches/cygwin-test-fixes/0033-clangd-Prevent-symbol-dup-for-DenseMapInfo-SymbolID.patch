From b3f00a2d52656140b6320e4261d02378a49f15c3 Mon Sep 17 00:00:00 2001
From: kikairoya <kikairoya@gmail.com>
Date: Sat, 24 Jan 2026 10:23:54 +0900
Subject: [PATCH 33/69] [clangd] Prevent symbol dup for DenseMapInfo<SymbolID>

Make member functions and their callees constexpr.
---
 clang-tools-extra/clangd/index/SymbolID.h | 13 +++++++------
 1 file changed, 7 insertions(+), 6 deletions(-)

diff --git a/clang-tools-extra/clangd/index/SymbolID.h b/clang-tools-extra/clangd/index/SymbolID.h
index e8aa462e96c177ab0972667f33b66f888e990177..34aa5eac24497206c59388bfb249fdab07d2ee64 100644
--- a/clang-tools-extra/clangd/index/SymbolID.h
+++ b/clang-tools-extra/clangd/index/SymbolID.h
@@ -58,6 +58,9 @@ public:
   explicit operator bool() const { return !isNull(); }
 
 private:
+  friend struct llvm::DenseMapInfo<clang::clangd::SymbolID>;
+  explicit constexpr SymbolID(uint8_t Key1, uint8_t Key2)
+      : HashValue{Key1, Key2} {}
   using IntTy = uint64_t;
   static_assert(sizeof(IntTy) == RawSize);
   std::array<uint8_t, RawSize> HashValue{};
@@ -81,13 +84,11 @@ llvm::raw_ostream &operator<<(llvm::raw_ostream &OS, const SymbolID &ID);
 namespace llvm {
 // Support SymbolIDs as DenseMap keys.
 template <> struct DenseMapInfo<clang::clangd::SymbolID> {
-  static inline clang::clangd::SymbolID getEmptyKey() {
-    static clang::clangd::SymbolID EmptyKey("EMPTYKEY");
-    return EmptyKey;
+  static constexpr clang::clangd::SymbolID getEmptyKey() {
+    return clang::clangd::SymbolID(0, 1);
   }
-  static inline clang::clangd::SymbolID getTombstoneKey() {
-    static clang::clangd::SymbolID TombstoneKey("TOMBSTONEKEY");
-    return TombstoneKey;
+  static constexpr clang::clangd::SymbolID getTombstoneKey() {
+    return clang::clangd::SymbolID(1, 0);
   }
   static unsigned getHashValue(const clang::clangd::SymbolID &Sym) {
     return hash_value(Sym);
-- 
2.52.0

