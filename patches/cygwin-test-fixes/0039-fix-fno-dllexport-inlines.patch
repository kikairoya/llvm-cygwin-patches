From 707e5ad79be0eb6610c7f26d456670e95ab60a1d Mon Sep 17 00:00:00 2001
From: kikairoya <kikairoya@gmail.com>
Date: Sun, 2 Nov 2025 12:42:37 +0900
Subject: [PATCH 39/62] fix -fno-dllexport-inlines

---
 clang/lib/Sema/SemaDecl.cpp                   | 30 +++++++++++++++++++
 .../dllexport-no-dllexport-inlines.cpp        |  6 ++--
 2 files changed, 33 insertions(+), 3 deletions(-)

diff --git a/clang/lib/Sema/SemaDecl.cpp b/clang/lib/Sema/SemaDecl.cpp
index db711ee08c8daf8fd39da85ee02d6f5f95acfc3d..15ddab5e37d0aa96d7953ebd6bddcf195df45517 100644
--- a/clang/lib/Sema/SemaDecl.cpp
+++ b/clang/lib/Sema/SemaDecl.cpp
@@ -3963,6 +3963,36 @@ bool Sema::MergeFunctionDecl(FunctionDecl *New, NamedDecl *&OldD, Scope *S,
     UndefinedButUsed.insert(std::make_pair(Old->getCanonicalDecl(),
                                            SourceLocation()));
 
+  if ((!Context.getTargetInfo().shouldDLLImportComdatSymbols() ||
+       !getLangOpts().DllExportInlines) &&
+      !Old->isInlined() && New->isInlined()) {
+    if (auto *MD = dyn_cast<CXXMethodDecl>(Old); MD) {
+      auto *Class = MD->getParent();
+      assert(Class && "MD->getParent() != nullptr");
+      auto *ClassAttr = getDLLAttr(Class);
+      auto *OldAttr = getDLLAttr(Old);
+      auto *NewAttr = getDLLAttr(New);
+      TemplateSpecializationKind TSK = Class->getTemplateSpecializationKind();
+      if (ClassAttr && !NewAttr && OldAttr && OldAttr->isInherited() &&
+          TSK != TSK_ExplicitInstantiationDeclaration &&
+          TSK != TSK_ExplicitInstantiationDefinition) {
+        if (Context.getTargetInfo().shouldDLLImportComdatSymbols()) {
+          InheritableAttr *NewAttr = nullptr;
+          if (ClassAttr->getKind() == attr::DLLExport) {
+            NewAttr = ::new (getASTContext())
+                DLLExportStaticLocalAttr(getASTContext(), *ClassAttr);
+          } else {
+            NewAttr = ::new (getASTContext())
+                DLLImportStaticLocalAttr(getASTContext(), *ClassAttr);
+          }
+          NewAttr->setInherited(true);
+          MD->addAttr(NewAttr);
+        }
+        MD->dropAttrs<DLLImportAttr, DLLExportAttr>();
+      }
+    }
+  }
+
   // If this redeclaration makes it newly gnu_inline, we don't want to warn
   // about it.
   if (New->hasAttr<GNUInlineAttr>() &&
diff --git a/clang/test/CodeGenCXX/dllexport-no-dllexport-inlines.cpp b/clang/test/CodeGenCXX/dllexport-no-dllexport-inlines.cpp
index 15ec6798563acc642d542075fea64db44a850fae..d97ca55c8689c2835f09157d5aacfa40232f449d 100644
--- a/clang/test/CodeGenCXX/dllexport-no-dllexport-inlines.cpp
+++ b/clang/test/CodeGenCXX/dllexport-no-dllexport-inlines.cpp
@@ -49,13 +49,13 @@ struct __declspec(dllexport) ExportedClass {
   // MINGW-DAG: define linkonce_odr dso_local noundef i32 @_ZN13ExportedClass39InlineOutclassDefFuncWithStaticVariableEv
   inline int InlineOutclassDefFuncWithStaticVariable();
 
-  // NOEXPORTINLINE-DAG: define weak_odr dso_local dllexport void @"?InlineLaterOutclassDefFunc@ExportedClass@@QEAAXXZ
+  // NOEXPORTINLINE-DAG: define linkonce_odr dso_local void @"?InlineLaterOutclassDefFunc@ExportedClass@@QEAAXXZ
   // EXPORTINLINE-DAG: define weak_odr dso_local dllexport void @"?InlineLaterOutclassDefFunc@ExportedClass@@QEAAXXZ
-  // MINGW-DAG: define weak_odr dso_local dllexport void @_ZN13ExportedClass26InlineLaterOutclassDefFuncEv
+  // MINGW-DAG: define linkonce_odr dso_local void @_ZN13ExportedClass26InlineLaterOutclassDefFuncEv
   void InlineLaterOutclassDefFunc();
 
   // CHECK-DAG: define weak_odr dso_local dllexport noundef i32 @"?InlineLaterOutclassDefFuncWithStaticVariable@ExportedClass@@QEAAHXZ"
-  // MINGW-DAG: define weak_odr dso_local dllexport noundef i32 @_ZN13ExportedClass44InlineLaterOutclassDefFuncWithStaticVariableEv
+  // MINGW-DAG: define linkonce_odr dso_local noundef i32 @_ZN13ExportedClass44InlineLaterOutclassDefFuncWithStaticVariableEv
   int InlineLaterOutclassDefFuncWithStaticVariable();
 
   // CHECK-DAG: define dso_local dllexport void @"?OutoflineDefFunc@ExportedClass@@QEAAXXZ"
-- 
2.52.0

