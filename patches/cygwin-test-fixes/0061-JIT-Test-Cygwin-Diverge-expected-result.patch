From 8995ab7f2bdd348e147d6cbdc0432cf5d5a93d3a Mon Sep 17 00:00:00 2001
From: kikairoya <kikairoya@gmail.com>
Date: Sun, 18 May 2025 12:04:02 +0900
Subject: [PATCH 61/69] [JIT][Test][Cygwin] Diverge expected result

Diverge Cygwin from other Unix-like systems.
---
 llvm/test/ExecutionEngine/MCJIT/remote/multi-module-a.ll     | 2 +-
 .../MCJIT/remote/test-global-init-nonzero-sm-pic.ll          | 2 +-
 .../ExecutionEngine/MCJIT/remote/test-ptr-reloc-sm-pic.ll    | 2 +-
 llvm/test/ExecutionEngine/MCJIT/stubs-sm-pic.ll              | 5 +++--
 llvm/test/ExecutionEngine/OrcLazy/comdat-functions.ll        | 2 +-
 llvm/test/ExecutionEngine/OrcLazy/emulated-tls.ll            | 1 +
 llvm/test/ExecutionEngine/RuntimeDyld/X86/coff-alignment.ll  | 2 +-
 llvm/test/lit.cfg.py                                         | 2 +-
 8 files changed, 10 insertions(+), 8 deletions(-)

diff --git a/llvm/test/ExecutionEngine/MCJIT/remote/multi-module-a.ll b/llvm/test/ExecutionEngine/MCJIT/remote/multi-module-a.ll
index ed1b9c62bdb663262a73d9afa5682a67caaf545a..584d383ac86482443f18c3a264ac2764c8ac2fd3 100644
--- a/llvm/test/ExecutionEngine/MCJIT/remote/multi-module-a.ll
+++ b/llvm/test/ExecutionEngine/MCJIT/remote/multi-module-a.ll
@@ -1,6 +1,6 @@
 ; RUN: %lli -jit-kind=mcjit -extra-module=%p/Inputs/multi-module-b.ll -extra-module=%p/Inputs/multi-module-c.ll -disable-lazy-compilation=true -remote-mcjit -mcjit-remote-process=lli-child-target %s > /dev/null
 ; REQUIRES: thread_support
-; XFAIL: target={{.*-windows-(gnu|msvc)}}
+; XFAIL: target={{.*-(windows-gnu|windows-msvc)}}
 ; UNSUPPORTED: target=powerpc64-unknown-linux-gnu
 ; Remove UNSUPPORTED for powerpc64-unknown-linux-gnu if problem caused by r266663 is fixed
 
diff --git a/llvm/test/ExecutionEngine/MCJIT/remote/test-global-init-nonzero-sm-pic.ll b/llvm/test/ExecutionEngine/MCJIT/remote/test-global-init-nonzero-sm-pic.ll
index 6bba022c6078e0038663eb8347eaadba33fe56b6..b2125cf2989e1132b797fed43f1c7911da6e127d 100644
--- a/llvm/test/ExecutionEngine/MCJIT/remote/test-global-init-nonzero-sm-pic.ll
+++ b/llvm/test/ExecutionEngine/MCJIT/remote/test-global-init-nonzero-sm-pic.ll
@@ -1,7 +1,7 @@
 ; RUN: %lli -jit-kind=mcjit -remote-mcjit -mcjit-remote-process=lli-child-target \
 ; RUN:   -relocation-model=pic -code-model=small %s > /dev/null
 ; XFAIL: target={{(mips|mipsel)-.*}}, target={{(aarch64|arm).*}}, target={{(i686|i386).*}}
-; XFAIL: target={{.*-windows-(gnu|msvc)}}
+; XFAIL: target={{.*-(windows-gnu|windows-msvc)}}
 ; REQUIRES: thread_support
 ; UNSUPPORTED: target=target=powerpc64-unknown-linux-gnu
 ; Remove UNSUPPORTED for powerpc64-unknown-linux-gnu if problem caused by r266663 is fixed
diff --git a/llvm/test/ExecutionEngine/MCJIT/remote/test-ptr-reloc-sm-pic.ll b/llvm/test/ExecutionEngine/MCJIT/remote/test-ptr-reloc-sm-pic.ll
index f2337f372ca01a4aa3dc6bb7dff92ed7f49ad281..3ef4dd88b1e02b229c60d30022ad0ca7b1c3317b 100644
--- a/llvm/test/ExecutionEngine/MCJIT/remote/test-ptr-reloc-sm-pic.ll
+++ b/llvm/test/ExecutionEngine/MCJIT/remote/test-ptr-reloc-sm-pic.ll
@@ -1,7 +1,7 @@
 ; RUN: %lli -jit-kind=mcjit -remote-mcjit -mcjit-remote-process=lli-child-target \
 ; RUN:   -O0 -relocation-model=pic -code-model=small %s
 ; XFAIL: target={{(mips|mipsel)-.*}}, target={{(aarch64|arm).*}}, target={{(i686|i386).*}}
-; XFAIL: target={{.*-windows-(gnu|msvc)}}
+; XFAIL: target={{.*-(windows-gnu|windows-msvc)}}
 ; REQUIRES: thread_support
 ; UNSUPPORTED: target=powerpc64-unknown-linux-gnu
 ; Remove UNSUPPORTED for powerpc64-unknown-linux-gnu if problem caused by r266663 is fixed
diff --git a/llvm/test/ExecutionEngine/MCJIT/stubs-sm-pic.ll b/llvm/test/ExecutionEngine/MCJIT/stubs-sm-pic.ll
index 9522bfa42a45663b3ae7392e00d516b56104605c..ad2270ab2e038e43d474925f180828ef26876dd9 100644
--- a/llvm/test/ExecutionEngine/MCJIT/stubs-sm-pic.ll
+++ b/llvm/test/ExecutionEngine/MCJIT/stubs-sm-pic.ll
@@ -1,7 +1,8 @@
 ; RUN: %lli -jit-kind=mcjit -disable-lazy-compilation=false -relocation-model=pic -code-model=small %s
-; XFAIL: target={{(mips|mipsel)-.*}}, target={{(i686|i386).*}}, target={{(aarch64|arm).*}}, target={{.*-(cygwin|windows-cygnus)}}
+; XFAIL: target={{(mips|mipsel)-.*}}, target={{(i686|i386).*}}, target={{(aarch64|arm).*}}
+; UNSUPPORTED: system-cygwin
 ; This test segfaults on cygwin, but succeeds with cygwin-elf.  Unfortunately,
-; cygwin-elf breaks the remote tests due to lack of __register_frame.
+; cygwin-elf breaks the remote tests due to lack of __register_frame unless using libunwind.
 
 define i32 @main() nounwind {
 entry:
diff --git a/llvm/test/ExecutionEngine/OrcLazy/comdat-functions.ll b/llvm/test/ExecutionEngine/OrcLazy/comdat-functions.ll
index 895410da98a11880df568d2ad0610d0cf1866fb1..5604818d82ee6e0f13451f4fb49e79f9edc732dc 100644
--- a/llvm/test/ExecutionEngine/OrcLazy/comdat-functions.ll
+++ b/llvm/test/ExecutionEngine/OrcLazy/comdat-functions.ll
@@ -1,4 +1,4 @@
-; REQUIRES: system-windows
+; REQUIRES: system-windows || system-cygwin
 ; RUN: lli -jit-kind=orc-lazy -extra-module %p/Inputs/comdat-functions.ll %s
 ; Check if crashing comdat any functions are not causing duplicate symbol error.
 
diff --git a/llvm/test/ExecutionEngine/OrcLazy/emulated-tls.ll b/llvm/test/ExecutionEngine/OrcLazy/emulated-tls.ll
index a70bc5f4ceb4216eec7e687f0dabb437e24e1a22..c0bd5ece36c6b666dd635196cb1d44fc2ff6787b 100644
--- a/llvm/test/ExecutionEngine/OrcLazy/emulated-tls.ll
+++ b/llvm/test/ExecutionEngine/OrcLazy/emulated-tls.ll
@@ -1,5 +1,6 @@
 ; LoongArch does not support emulated tls.
 ; UNSUPPORTED: target=loongarch{{.*}}
+; UNSUPPORTED: system-cygwin
 
 ; RUN: not lli -no-process-syms -lljit-platform=Inactive -emulated-tls \
 ; RUN:   -jit-kind=orc-lazy %s 2>&1 | FileCheck %s
diff --git a/llvm/test/ExecutionEngine/RuntimeDyld/X86/coff-alignment.ll b/llvm/test/ExecutionEngine/RuntimeDyld/X86/coff-alignment.ll
index 9a822fc7ed55654339252523d066568d1e89dc7c..d7898170739ae8cd602b0be2efd4ae75e3319b5e 100644
--- a/llvm/test/ExecutionEngine/RuntimeDyld/X86/coff-alignment.ll
+++ b/llvm/test/ExecutionEngine/RuntimeDyld/X86/coff-alignment.ll
@@ -1,4 +1,4 @@
-; REQUIRES: system-windows, target=x86_64-{{.*}}-windows-{{.*}}
+; REQUIRES: system-windows || system-cygwin, target=x86_64-{{.*}}-{{.*cyg.*|windows-.*}}
 ; RUN: opt -mtriple=x86_64-pc-win32-coff %s -o - | lli
 
 @o = common global i32 0, align 4
diff --git a/llvm/test/lit.cfg.py b/llvm/test/lit.cfg.py
index fe12936495be76cbcf342590306e3089728dfdd2..5ede4ab457c22cc2380f5259d9c224476cb201a6 100644
--- a/llvm/test/lit.cfg.py
+++ b/llvm/test/lit.cfg.py
@@ -704,7 +704,7 @@ def host_unwind_supports_jit():
         return True
 
     # Windows does not support frame info without the ORC runtime.
-    if platform.system() == "Windows":
+    if platform.system() == "Windows" or platform.system().startswith("CYGWIN"):
         return False
 
     # On Darwin/x86-64 clang produces both eh-frames and compact-unwind, and
-- 
2.52.0

