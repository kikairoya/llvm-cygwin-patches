From 4e6bd7f1d2372c9ae83ebd92ca617b893c976e87 Mon Sep 17 00:00:00 2001
From: kikairoya <kikairoya@gmail.com>
Date: Sun, 25 May 2025 14:11:29 +0900
Subject: [PATCH 40/46] [libunwind][Test][Cygwin] Make test runnable for Cygwin
 target

---
 libunwind/CMakeLists.txt                      | 10 ++++++--
 .../llvm-libunwind-shared-cygwin.cfg.in       | 25 +++++++++++++++++++
 .../llvm-libunwind-static-cygwin.cfg.in       | 25 +++++++++++++++++++
 3 files changed, 58 insertions(+), 2 deletions(-)
 create mode 100644 libunwind/test/configs/llvm-libunwind-shared-cygwin.cfg.in
 create mode 100644 libunwind/test/configs/llvm-libunwind-static-cygwin.cfg.in

diff --git a/libunwind/CMakeLists.txt b/libunwind/CMakeLists.txt
index fbef71f3f74467571e71cc0fde2a1a94c0c13f35..74c215a0110021a13fec324e521a787211d697ae 100644
--- a/libunwind/CMakeLists.txt
+++ b/libunwind/CMakeLists.txt
@@ -78,6 +78,12 @@ if(MINGW)
   else()
     set(LIBUNWIND_DEFAULT_TEST_CONFIG "llvm-libunwind-static-mingw.cfg.in")
   endif()
+elseif(CYGWIN)
+  if (LIBUNWIND_ENABLE_SHARED)
+    set(LIBUNWIND_DEFAULT_TEST_CONFIG "llvm-libunwind-shared-cygwin.cfg.in")
+  else()
+    set(LIBUNWIND_DEFAULT_TEST_CONFIG "llvm-libunwind-static-cygwin.cfg.in")
+  endif()
 elseif (LIBUNWIND_ENABLE_SHARED)
   set(LIBUNWIND_DEFAULT_TEST_CONFIG "llvm-libunwind-shared.cfg.in")
 else()
@@ -101,7 +107,7 @@ if (LIBUNWIND_ENABLE_CET AND MSVC)
   message(FATAL_ERROR "libunwind CET support is not available for MSVC!")
 endif()
 
-if (WIN32)
+if (WIN32 OR CYGWIN)
   set(LIBUNWIND_DEFAULT_HIDE_SYMBOLS TRUE)
 else()
   set(LIBUNWIND_DEFAULT_HIDE_SYMBOLS FALSE)
@@ -208,7 +214,7 @@ if (LIBUNWIND_ENABLE_GCS)
   endif()
 endif()
 
-if (WIN32)
+if (WIN32 OR CYGWIN)
   # The headers lack matching dllexport attributes (_LIBUNWIND_EXPORT);
   # silence the warning instead of cluttering the headers (which aren't
   # necessarily the ones that the callers will use anyway) with the
diff --git a/libunwind/test/configs/llvm-libunwind-shared-cygwin.cfg.in b/libunwind/test/configs/llvm-libunwind-shared-cygwin.cfg.in
new file mode 100644
index 0000000000000000000000000000000000000000..b01784665582d377e88c2dca60420589d65074b0
--- /dev/null
+++ b/libunwind/test/configs/llvm-libunwind-shared-cygwin.cfg.in
@@ -0,0 +1,25 @@
+# This testing configuration handles running the test suite against LLVM's libunwind
+# using a DLL with Cygwin.
+
+lit_config.load_config(config, '@CMAKE_CURRENT_BINARY_DIR@/cmake-bridge.cfg')
+
+config.substitutions.append(('%{flags}', ''))
+config.substitutions.append(('%{compile_flags}',
+    '-nostdinc++ -I %{include} -funwind-tables'
+))
+config.substitutions.append(('%{link_flags}',
+    '-L %{lib} -lunwind'
+))
+config.substitutions.append(('%{exec}',
+    '%{executor} --execdir %{temp} --prepend_env PATH=%{install-prefix}/bin -- '
+))
+
+import os, site
+site.addsitedir(os.path.join('@LIBUNWIND_LIBCXX_PATH@', 'utils'))
+import libcxx.test.params, libcxx.test.config
+libcxx.test.config.configure(
+    libcxx.test.params.DEFAULT_PARAMETERS,
+    libcxx.test.features.DEFAULT_FEATURES,
+    config,
+    lit_config
+)
diff --git a/libunwind/test/configs/llvm-libunwind-static-cygwin.cfg.in b/libunwind/test/configs/llvm-libunwind-static-cygwin.cfg.in
new file mode 100644
index 0000000000000000000000000000000000000000..dc490a08ba1a63389ccdc01a036020a06e805c49
--- /dev/null
+++ b/libunwind/test/configs/llvm-libunwind-static-cygwin.cfg.in
@@ -0,0 +1,25 @@
+# This testing configuration handles running the test suite against LLVM's libunwind
+# using a static library with Cygwin.
+
+lit_config.load_config(config, '@CMAKE_CURRENT_BINARY_DIR@/cmake-bridge.cfg')
+
+config.substitutions.append(('%{flags}', ''))
+config.substitutions.append(('%{compile_flags}',
+    '-nostdinc++ -I %{include} -funwind-tables'
+))
+config.substitutions.append(('%{link_flags}',
+    '-L %{lib} -lunwind'
+))
+config.substitutions.append(('%{exec}',
+    '%{executor} --execdir %{temp} --prepend_env PATH=%{lib} -- '
+))
+
+import os, site
+site.addsitedir(os.path.join('@LIBUNWIND_LIBCXX_PATH@', 'utils'))
+import libcxx.test.params, libcxx.test.config
+libcxx.test.config.configure(
+    libcxx.test.params.DEFAULT_PARAMETERS,
+    libcxx.test.features.DEFAULT_FEATURES,
+    config,
+    lit_config
+)
-- 
2.52.0

