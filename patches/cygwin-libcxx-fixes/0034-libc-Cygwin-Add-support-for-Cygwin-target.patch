From a4814bb70cb03984381353d440f6cb94a4fa0e1a Mon Sep 17 00:00:00 2001
From: kikairoya <kikairoya@gmail.com>
Date: Sun, 8 Jun 2025 22:25:26 +0900
Subject: [PATCH 34/46] [libc++][Cygwin] Add support for Cygwin target

---
 libcxx/CMakeLists.txt                       | 26 +++++++++++++++++++--
 libcxx/cmake/config-ix.cmake                | 11 +++++++++
 libcxx/include/__config                     |  5 ++++
 libcxx/include/__configuration/attributes.h |  5 ++--
 libcxx/include/__configuration/platform.h   |  2 +-
 libcxx/src/filesystem/posix_compat.h        |  4 +++-
 6 files changed, 47 insertions(+), 6 deletions(-)

diff --git a/libcxx/CMakeLists.txt b/libcxx/CMakeLists.txt
index 0ac582cb561a88f9873820efa4c334882cf48570..9e62db81483ae35f632ed90d24d8d2ae58fce920 100644
--- a/libcxx/CMakeLists.txt
+++ b/libcxx/CMakeLists.txt
@@ -275,7 +275,7 @@ if (LIBCXX_STATICALLY_LINK_ABI_IN_SHARED_LIBRARY
     OR NOT LIBCXX_ENABLE_SHARED
     OR LIBCXX_CXX_ABI STREQUAL "none")
   set(ENABLE_LINKER_SCRIPT_DEFAULT_VALUE OFF)
-elseif((UNIX OR FUCHSIA) AND NOT APPLE)
+elseif((UNIX OR FUCHSIA) AND NOT APPLE AND NOT CYGWIN)
   set(ENABLE_LINKER_SCRIPT_DEFAULT_VALUE ON)
 else()
   set(ENABLE_LINKER_SCRIPT_DEFAULT_VALUE OFF)
@@ -320,7 +320,7 @@ option(LIBCXX_ENABLE_PEDANTIC "Compile with pedantic enabled." OFF)
 option(LIBCXX_ENABLE_WERROR "Fail and stop if a warning is triggered." OFF)
 
 set(LIBCXX_HERMETIC_STATIC_LIBRARY_DEFAULT OFF)
-if (WIN32)
+if (WIN32 OR CYGWIN)
   set(LIBCXX_HERMETIC_STATIC_LIBRARY_DEFAULT ON)
 endif()
 option(LIBCXX_HERMETIC_STATIC_LIBRARY
@@ -509,6 +509,10 @@ function(cxx_add_basic_build_flags target)
     CXX_STANDARD 23
     CXX_STANDARD_REQUIRED OFF # TODO: Make this REQUIRED once we don't need to accommodate the LLVM documentation builders using an ancient CMake
     CXX_EXTENSIONS NO)
+  if (CYGWIN)
+    set_target_properties(${target} PROPERTIES
+      CXX_EXTENSIONS YES)
+  endif()
 
   # When building the dylib, don't warn for unavailable aligned allocation
   # functions based on the deployment target -- they are always available
@@ -688,6 +692,22 @@ function(cxx_link_system_libraries target)
   if (MINGW)
     target_link_libraries(${target} PRIVATE "${MINGW_LIBRARIES}")
   endif()
+  if (CYGWIN)
+    # Cygwin requires gcc_s or compiler-rt explicitly, which are dropped by the effect
+    # of "--unwindlib=none", for Emulated-TLS functionallity
+    if (CXX_SUPPORTS_UNWINDLIB_EQ_NONE_FLAG AND LIBCXXABI_USE_LLVM_UNWINDER AND NOT CYGWIN_LIBRARIES)
+      if (LIBCXX_USE_COMPILER_RT)
+        include(HandleCompilerRT)
+        find_compiler_rt_library(builtins LIBCXX_BUILTINS_LIBRARY
+          FLAGS ${LIBCXX_COMPILE_FLAGS})
+        target_link_libraries(${target} PRIVATE ${LIBCXX_BUILTINS_LIBRARY})
+      else()
+        target_link_libraries(${target} PRIVATE gcc_s)
+      endif()
+    else()
+      target_link_libraries(${target} PRIVATE "${CYGWIN_LIBRARIES}")
+    endif()
+  endif()
 
   if (MSVC)
     if ((NOT CMAKE_MSVC_RUNTIME_LIBRARY AND uppercase_CMAKE_BUILD_TYPE STREQUAL "DEBUG")
@@ -779,6 +799,8 @@ elseif (RUNTIMES_USE_LIBC STREQUAL "newlib")
   config_define(1 _LIBCPP_LIBC_NEWLIB)
 elseif (RUNTIMES_USE_LIBC STREQUAL "llvm-libc")
   config_define(1 _LIBCPP_LIBC_LLVM_LIBC)
+elseif (CYGWIN AND RUNTIMES_USE_LIBC STREQUAL "system")
+  config_define(1 _LIBCPP_LIBC_NEWLIB)
 endif()
 
 if (LIBCXX_HARDENING_MODE STREQUAL "none")
diff --git a/libcxx/cmake/config-ix.cmake b/libcxx/cmake/config-ix.cmake
index 270d80575adcfd4c0a4e49e4c68395a1d6f63b80..2219ad018e1797d0f5aa068cf0f63b66d7cc2044 100644
--- a/libcxx/cmake/config-ix.cmake
+++ b/libcxx/cmake/config-ix.cmake
@@ -79,6 +79,17 @@ if (NOT CXX_SUPPORTS_NOSTDLIBXX_FLAG AND C_SUPPORTS_NODEFAULTLIBS_FLAG)
                         moldname mingwex msvcrt)
     list(APPEND CMAKE_REQUIRED_LIBRARIES ${MINGW_LIBRARIES})
   endif()
+  if (CYGWIN)
+    if (LIBCXX_USE_COMPILER_RT)
+      set(CYGWIN_RUNTIME ${LIBCXX_BUILTINS_LIBRARY})
+    else ()
+      set(CYGWIN_RUNTIME gcc_s gcc)
+    endif()
+    set(CYGWIN_LIBRARIES cygwin ${CYGWIN_RUNTIME} advapi32
+                         shell32 user32 kernel32 ${CYGWIN_RUNTIME}
+                         cygwin)
+    list(APPEND CMAKE_REQUIRED_LIBRARIES ${CYGWIN_LIBRARIES})
+  endif()
 endif()
 
 if (CXX_SUPPORTS_NOSTDLIBXX_FLAG OR C_SUPPORTS_NODEFAULTLIBS_FLAG)
diff --git a/libcxx/include/__config b/libcxx/include/__config
index 9cb98bbb593411eb7136daa1af254ffddc1f9e01..82e7e50e65ce93f02f6d2a6ef76daf4f139e67d7 100644
--- a/libcxx/include/__config
+++ b/libcxx/include/__config
@@ -90,6 +90,10 @@
 #      define _LIBCPP_HAS_BITSCAN64 0
 #    endif
 #    define _LIBCPP_HAS_OPEN_WITH_WCHAR 1
+#  elif defined(__CYGWIN__)
+#    define _LIBCPP_SHORT_WCHAR 1
+#    define _LIBCPP_HAS_OPEN_WITH_WCHAR 0
+#    define _LIBCPP_HAS_BITSCAN64 1
 #  else
 #    define _LIBCPP_HAS_OPEN_WITH_WCHAR 0
 #    define _LIBCPP_HAS_BITSCAN64 0
@@ -382,6 +386,7 @@ typedef __char32_t char32_t;
         defined(__APPLE__) ||                                                                                          \
         defined(__MVS__) ||                                                                                            \
         defined(_AIX) ||                                                                                               \
+        defined(__CYGWIN__) ||                                                                                         \
         defined(__EMSCRIPTEN__)
 // clang-format on
 #      undef _LIBCPP_HAS_THREAD_API_PTHREAD
diff --git a/libcxx/include/__configuration/attributes.h b/libcxx/include/__configuration/attributes.h
index 7322995701ba29bf705cc69ebe3c0a321baad2db..b78269ff4fa8af07600090cde62979d144cba316 100644
--- a/libcxx/include/__configuration/attributes.h
+++ b/libcxx/include/__configuration/attributes.h
@@ -54,13 +54,14 @@
 #    define _LIBCPP_CRT_FUNC
 #  endif
 
-#  if defined(_LIBCPP_DISABLE_VISIBILITY_ANNOTATIONS) || (defined(__MINGW32__) && !defined(_LIBCPP_BUILDING_LIBRARY))
+#  if defined(_LIBCPP_DISABLE_VISIBILITY_ANNOTATIONS) ||                                                               \
+      ((defined(__MINGW32__) || defined(__CYGWIN__)) && !defined(_LIBCPP_BUILDING_LIBRARY))
 #    define _LIBCPP_EXTERN_TEMPLATE_TYPE_VIS
 #    define _LIBCPP_CLASS_TEMPLATE_INSTANTIATION_VIS
 #    define _LIBCPP_OVERRIDABLE_FUNC_VIS
 #    define _LIBCPP_EXPORTED_FROM_ABI
 #  elif defined(_LIBCPP_BUILDING_LIBRARY)
-#    if defined(__MINGW32__)
+#    if defined(__MINGW32__) || defined(__CYGWIN__)
 #      define _LIBCPP_EXTERN_TEMPLATE_TYPE_VIS __declspec(dllexport)
 #      define _LIBCPP_CLASS_TEMPLATE_INSTANTIATION_VIS
 #    else
diff --git a/libcxx/include/__configuration/platform.h b/libcxx/include/__configuration/platform.h
index 644fe1724e42edecc6d252c583e44d28d83c797f..4232cbba106e68eae1ab1931b3c777c0d89b08e7 100644
--- a/libcxx/include/__configuration/platform.h
+++ b/libcxx/include/__configuration/platform.h
@@ -20,7 +20,7 @@
 #  define _LIBCPP_OBJECT_FORMAT_ELF 1
 #elif defined(__MACH__)
 #  define _LIBCPP_OBJECT_FORMAT_MACHO 1
-#elif defined(_WIN32)
+#elif defined(_WIN32) || defined(__CYGWIN__)
 #  define _LIBCPP_OBJECT_FORMAT_COFF 1
 #elif defined(__wasm__)
 #  define _LIBCPP_OBJECT_FORMAT_WASM 1
diff --git a/libcxx/src/filesystem/posix_compat.h b/libcxx/src/filesystem/posix_compat.h
index ddd99d8aaf206fd8e87190a0205add560983f63f..27a22379c05f9da87ea895ef35c1524eac58eac8 100644
--- a/libcxx/src/filesystem/posix_compat.h
+++ b/libcxx/src/filesystem/posix_compat.h
@@ -475,7 +475,9 @@ using ::stat;
 using ::statvfs;
 using ::truncate;
 
-#  define O_BINARY 0
+#  ifndef __CYGWIN__
+#    define O_BINARY 0
+#  endif
 
 using StatVFS = struct statvfs;
 using ModeT   = ::mode_t;
-- 
2.52.0

