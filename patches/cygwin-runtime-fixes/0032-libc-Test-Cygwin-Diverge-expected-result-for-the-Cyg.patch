From c054d97112dcd2b1aeffc6c85d16b9821ee5c24a Mon Sep 17 00:00:00 2001
From: kikairoya <kikairoya@gmail.com>
Date: Sat, 7 Jun 2025 17:45:43 +0900
Subject: [PATCH 32/39] [libc++][Test][Cygwin] Diverge expected result for the
 Cygwin target (part 1/5 - test setup)

---
 libcxx/CMakeLists.txt                     | 4 +++-
 libcxx/include/__config                   | 2 +-
 libcxx/utils/libcxx/test/features/misc.py | 4 ++--
 3 files changed, 6 insertions(+), 4 deletions(-)

diff --git a/libcxx/CMakeLists.txt b/libcxx/CMakeLists.txt
index e77f4d8d4642d57c88ed20252a7f32d9a7c53729..3924164bc74b768747dc375a106bd9af6d027d7e 100644
--- a/libcxx/CMakeLists.txt
+++ b/libcxx/CMakeLists.txt
@@ -537,7 +537,9 @@ function(cxx_add_basic_build_flags target)
 
   # Build with -fsized-deallocation, which is default in recent versions of Clang.
   # TODO(LLVM 21): This can be dropped once we only support Clang >= 19.
-  target_add_compile_flags_if_supported(${target} PRIVATE -fsized-deallocation)
+  if (NOT CYGWIN)
+    target_add_compile_flags_if_supported(${target} PRIVATE -fsized-deallocation)
+  endif()
 
   # Let the library headers know they are currently being used to build the
   # library.
diff --git a/libcxx/include/__config b/libcxx/include/__config
index 456485928008e12c54e36a3c7a3dcd2773cab902..54b66663cbff9dabb3dfbe1e8727967a703a4fea 100644
--- a/libcxx/include/__config
+++ b/libcxx/include/__config
@@ -831,7 +831,7 @@ typedef __char32_t char32_t;
 // the latter depends on internal GNU libc details that are not appropriate
 // to depend on here, so any declarations present when __cpp_char8_t is not
 // defined are ignored.
-#  if _LIBCPP_GLIBC_PREREQ(2, 36) && defined(__cpp_char8_t)
+#  if (_LIBCPP_GLIBC_PREREQ(2, 36) || defined(__CYGWIN__)) && defined(__cpp_char8_t)
 #    define _LIBCPP_HAS_C8RTOMB_MBRTOC8 1
 #  else
 #    define _LIBCPP_HAS_C8RTOMB_MBRTOC8 0
diff --git a/libcxx/utils/libcxx/test/features/misc.py b/libcxx/utils/libcxx/test/features/misc.py
index 738e3d8bb207cc641e8f890cddbc4bbc7cf68c71..b079013d0d9c2b4bb9b47cf6f9261baef0c703eb 100644
--- a/libcxx/utils/libcxx/test/features/misc.py
+++ b/libcxx/utils/libcxx/test/features/misc.py
@@ -133,7 +133,7 @@ features = [
         name="win32-broken-utf8-wchar-ctype",
         when=lambda cfg: not "_LIBCPP_HAS_LOCALIZATION" in compilerMacros(cfg)
         or compilerMacros(cfg)["_LIBCPP_HAS_LOCALIZATION"] == "1"
-        and "_WIN32" in compilerMacros(cfg)
+        and ("_WIN32" in compilerMacros(cfg) or "__CYGWIN__" in compilerMacros(cfg))
         and not programSucceeds(
             cfg,
             """
@@ -150,7 +150,7 @@ features = [
     # https://developercommunity.visualstudio.com/t/printf-formatting-with-g-outputs-too/1660837
     Feature(
         name="win32-broken-printf-g-precision",
-        when=lambda cfg: "_WIN32" in compilerMacros(cfg)
+        when=lambda cfg: ("_WIN32" in compilerMacros(cfg) or "__CYGWIN__" in compilerMacros(cfg))
         and not programSucceeds(
             cfg,
             """
-- 
2.52.0

