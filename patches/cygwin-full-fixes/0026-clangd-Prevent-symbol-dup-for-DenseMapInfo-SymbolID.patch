From 30fde2e6fc5284d2b4e4e8120b30b56528ea9994 Mon Sep 17 00:00:00 2001
From: kikairoya <kikairoya@gmail.com>
Date: Thu, 25 Dec 2025 21:50:15 +0900
Subject: [PATCH 26/56] [clangd] Prevent symbol dup for DenseMapInfo<SymbolID>

Make member functions and their callees constexpr.
---
 clang-tools-extra/clangd/index/SymbolID.h | 23 +++++++++++++----------
 1 file changed, 13 insertions(+), 10 deletions(-)

diff --git a/clang-tools-extra/clangd/index/SymbolID.h b/clang-tools-extra/clangd/index/SymbolID.h
index e8aa462e96c177ab0972667f33b66f888e990177..0e6ab4f0e207e5764f75c91a25782257daacb2a2 100644
--- a/clang-tools-extra/clangd/index/SymbolID.h
+++ b/clang-tools-extra/clangd/index/SymbolID.h
@@ -34,10 +34,12 @@ public:
   SymbolID() = default;
   explicit SymbolID(llvm::StringRef USR);
 
-  bool operator==(const SymbolID &Sym) const {
+  constexpr bool operator==(const SymbolID &Sym) const {
     return HashValue == Sym.HashValue;
   }
-  bool operator!=(const SymbolID &Sym) const { return !(*this == Sym); }
+  constexpr bool operator!=(const SymbolID &Sym) const {
+    return !(*this == Sym);
+  }
   bool operator<(const SymbolID &Sym) const {
     // Avoid lexicographic compare which requires swapping bytes or even memcmp!
     return llvm::bit_cast<IntTy>(HashValue) <
@@ -58,6 +60,9 @@ public:
   explicit operator bool() const { return !isNull(); }
 
 private:
+  friend struct llvm::DenseMapInfo<clang::clangd::SymbolID>;
+  explicit constexpr SymbolID(uint8_t Key1, uint8_t Key2)
+      : HashValue{Key1, Key2} {}
   using IntTy = uint64_t;
   static_assert(sizeof(IntTy) == RawSize);
   std::array<uint8_t, RawSize> HashValue{};
@@ -81,19 +86,17 @@ llvm::raw_ostream &operator<<(llvm::raw_ostream &OS, const SymbolID &ID);
 namespace llvm {
 // Support SymbolIDs as DenseMap keys.
 template <> struct DenseMapInfo<clang::clangd::SymbolID> {
-  static inline clang::clangd::SymbolID getEmptyKey() {
-    static clang::clangd::SymbolID EmptyKey("EMPTYKEY");
-    return EmptyKey;
+  static constexpr clang::clangd::SymbolID getEmptyKey() {
+    return clang::clangd::SymbolID(0, 1);
   }
-  static inline clang::clangd::SymbolID getTombstoneKey() {
-    static clang::clangd::SymbolID TombstoneKey("TOMBSTONEKEY");
-    return TombstoneKey;
+  static constexpr clang::clangd::SymbolID getTombstoneKey() {
+    return clang::clangd::SymbolID(1, 0);
   }
   static unsigned getHashValue(const clang::clangd::SymbolID &Sym) {
     return hash_value(Sym);
   }
-  static bool isEqual(const clang::clangd::SymbolID &LHS,
-                      const clang::clangd::SymbolID &RHS) {
+  static constexpr bool isEqual(const clang::clangd::SymbolID &LHS,
+                                const clang::clangd::SymbolID &RHS) {
     return LHS == RHS;
   }
 };
-- 
2.52.0

