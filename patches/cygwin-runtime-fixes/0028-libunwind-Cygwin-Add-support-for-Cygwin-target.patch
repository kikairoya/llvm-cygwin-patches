From 441d82cd171845f2f6babfe482effd36a2f150d1 Mon Sep 17 00:00:00 2001
From: kikairoya <kikairoya@gmail.com>
Date: Sat, 31 May 2025 23:08:39 +0900
Subject: [PATCH 28/39] [libunwind][Cygwin] Add support for Cygwin target

---
 libunwind/include/__libunwind_config.h |  2 +-
 libunwind/include/libunwind.h          |  2 +-
 libunwind/include/unwind.h             |  3 ++-
 libunwind/src/AddressSpace.hpp         | 20 ++++++++++++--------
 libunwind/src/CMakeLists.txt           |  3 +++
 libunwind/src/Registers.hpp            | 10 +++++-----
 libunwind/src/Unwind-seh.cpp           |  4 ++--
 libunwind/src/UnwindCursor.hpp         | 14 ++++++++------
 libunwind/src/UnwindRegistersRestore.S |  4 ++--
 libunwind/src/UnwindRegistersSave.S    |  4 ++--
 libunwind/src/assembly.h               | 10 ++++++++--
 libunwind/src/config.h                 |  8 ++++++--
 libunwind/test/signal_frame.pass.cpp   |  1 +
 13 files changed, 53 insertions(+), 32 deletions(-)

diff --git a/libunwind/include/__libunwind_config.h b/libunwind/include/__libunwind_config.h
index 980d11ef5d4f237f7ad10af086cc6cf711acadaf..3147ed5fba6737d70e4c59f0ddb1113ceaa1c7a4 100644
--- a/libunwind/include/__libunwind_config.h
+++ b/libunwind/include/__libunwind_config.h
@@ -46,7 +46,7 @@
 #  define _LIBUNWIND_HIGHEST_DWARF_REGISTER _LIBUNWIND_HIGHEST_DWARF_REGISTER_X86
 # elif defined(__x86_64__)
 #  define _LIBUNWIND_TARGET_X86_64 1
-#  if defined(_WIN64)
+#if defined(_WIN64) || defined(__CYGWIN__)
 #    define _LIBUNWIND_CONTEXT_SIZE 54
 #    ifdef __SEH__
 #      define _LIBUNWIND_CURSOR_SIZE 204
diff --git a/libunwind/include/libunwind.h b/libunwind/include/libunwind.h
index 56ca7110274a30c842d845a4c1ab8761bcd57388..427b8f0f12d59b38fd5e0f2eb4e2c5417264af4a 100644
--- a/libunwind/include/libunwind.h
+++ b/libunwind/include/libunwind.h
@@ -146,7 +146,7 @@
 
 #endif
 
-#if defined(_WIN32) && defined(__SEH__)
+#if (defined(_WIN32) || defined(__CYGWIN__)) && defined(__SEH__)
   #define LIBUNWIND_CURSOR_ALIGNMENT_ATTR __attribute__((__aligned__(16)))
 #else
   #define LIBUNWIND_CURSOR_ALIGNMENT_ATTR
diff --git a/libunwind/include/unwind.h b/libunwind/include/unwind.h
index b1775d3a3decc76e1a0916fead1aafbc6fa0fb51..94dda313cc4b6640a4a772e871152480c7bd5752 100644
--- a/libunwind/include/unwind.h
+++ b/libunwind/include/unwind.h
@@ -18,7 +18,8 @@
 #include <stdint.h>
 #include <stddef.h>
 
-#if defined(__SEH__) && !defined(__USING_SJLJ_EXCEPTIONS__) && defined(_WIN32)
+#if defined(__SEH__) && !defined(__USING_SJLJ_EXCEPTIONS__) &&                 \
+    (defined(_WIN32) || defined(__CYGWIN__))
 #include <windows.h>
 #include <ntverp.h>
 #endif
diff --git a/libunwind/src/AddressSpace.hpp b/libunwind/src/AddressSpace.hpp
index 63f9cb367ec0c742c5082b90e49113604a4d93e3..5f7aa94905d0285dcb55223b650779ae18925d78 100644
--- a/libunwind/src/AddressSpace.hpp
+++ b/libunwind/src/AddressSpace.hpp
@@ -24,11 +24,12 @@
 #include "Registers.hpp"
 
 #ifndef _LIBUNWIND_USE_DLADDR
-  #if !(defined(_LIBUNWIND_IS_BAREMETAL) || defined(_WIN32) || defined(_AIX))
-    #define _LIBUNWIND_USE_DLADDR 1
-  #else
-    #define _LIBUNWIND_USE_DLADDR 0
-  #endif
+#if !(defined(_LIBUNWIND_IS_BAREMETAL) || defined(_WIN32) || defined(_AIX) ||  \
+      defined(__CYGWIN__))
+#define _LIBUNWIND_USE_DLADDR 1
+#else
+#define _LIBUNWIND_USE_DLADDR 0
+#endif
 #endif
 
 #if _LIBUNWIND_USE_DLADDR
@@ -109,7 +110,8 @@ extern char __eh_frame_hdr_end;
 extern char __exidx_start;
 extern char __exidx_end;
 
-#elif defined(_LIBUNWIND_SUPPORT_DWARF_UNWIND) && defined(_WIN32)
+#elif defined(_LIBUNWIND_SUPPORT_DWARF_UNWIND) &&                              \
+    (defined(_WIN32) || defined(__CYGWIN__))
 
 #include <windows.h>
 #include <psapi.h>
@@ -551,7 +553,8 @@ inline bool LocalAddressSpace::findUnwindSections(pint_t targetAddr,
                              (void *)info.arm_section, (void *)info.arm_section_length);
   if (info.arm_section && info.arm_section_length)
     return true;
-#elif defined(_LIBUNWIND_SUPPORT_DWARF_UNWIND) && defined(_WIN32)
+#elif defined(_LIBUNWIND_SUPPORT_DWARF_UNWIND) &&                              \
+    (defined(_WIN32) || defined(__CYGWIN__))
   HMODULE mods[1024];
   HANDLE process = GetCurrentProcess();
   DWORD needed;
@@ -591,7 +594,8 @@ inline bool LocalAddressSpace::findUnwindSections(pint_t targetAddr,
     }
   }
   return false;
-#elif defined(_LIBUNWIND_SUPPORT_SEH_UNWIND) && defined(_WIN32)
+#elif defined(_LIBUNWIND_SUPPORT_SEH_UNWIND) &&                                \
+    (defined(_WIN32) || defined(__CYGWIN__))
   // Don't even bother, since Windows has functions that do all this stuff
   // for us.
   (void)targetAddr;
diff --git a/libunwind/src/CMakeLists.txt b/libunwind/src/CMakeLists.txt
index 6e947039fb0d52f1b388a7a1236790ce83e169a4..dfe4ebee49e5844c2d20d95356eb2ed75b9414ba 100644
--- a/libunwind/src/CMakeLists.txt
+++ b/libunwind/src/CMakeLists.txt
@@ -89,6 +89,9 @@ add_link_flags_if(CXX_SUPPORTS_UNWINDLIB_EQ_NONE_FLAG --unwindlib=none)
 # MINGW_LIBRARIES is defined in config-ix.cmake
 add_library_flags_if(MINGW "${MINGW_LIBRARIES}")
 
+# CYGWIN_LIBRARIES is defined in config-ix.cmake
+add_library_flags_if(CYGWIN "${CYGWIN_LIBRARIES}")
+
 if (LIBUNWIND_ENABLE_SHARED AND
     NOT (CXX_SUPPORTS_FNO_EXCEPTIONS_FLAG AND
          CXX_SUPPORTS_FUNWIND_TABLES_FLAG))
diff --git a/libunwind/src/Registers.hpp b/libunwind/src/Registers.hpp
index 45a2b0921ea3b4c538440c6ee59f6389fdb54313..1b6467af3b6e579cf1ec161fd83257f05d19e68a 100644
--- a/libunwind/src/Registers.hpp
+++ b/libunwind/src/Registers.hpp
@@ -346,12 +346,12 @@ private:
     uint64_t __cs;
     uint64_t __fs;
     uint64_t __gs;
-#if defined(_WIN64)
+#if defined(_WIN64) || defined(__CYGWIN__) && defined(__x86_64__)
     uint64_t __padding; // 16-byte align
 #endif
   };
   GPRs _registers;
-#if defined(_WIN64)
+#if defined(_WIN64) || defined(__CYGWIN__) && defined(__x86_64__)
   v128 _xmm[16];
 #endif
 };
@@ -567,7 +567,7 @@ inline void Registers_x86_64::setFloatRegister(int, double) {
 }
 
 inline bool Registers_x86_64::validVectorRegister(int regNum) const {
-#if defined(_WIN64)
+#if defined(_WIN64) || defined(__CYGWIN__) && defined(__x86_64__)
   if (regNum < UNW_X86_64_XMM0)
     return false;
   if (regNum > UNW_X86_64_XMM15)
@@ -580,7 +580,7 @@ inline bool Registers_x86_64::validVectorRegister(int regNum) const {
 }
 
 inline v128 Registers_x86_64::getVectorRegister(int regNum) const {
-#if defined(_WIN64)
+#if defined(_WIN64) || defined(__CYGWIN__) && defined(__x86_64__)
   assert(validVectorRegister(regNum));
   return _xmm[regNum - UNW_X86_64_XMM0];
 #else
@@ -590,7 +590,7 @@ inline v128 Registers_x86_64::getVectorRegister(int regNum) const {
 }
 
 inline void Registers_x86_64::setVectorRegister(int regNum, v128 value) {
-#if defined(_WIN64)
+#if defined(_WIN64) || defined(__CYGWIN__) && defined(__x86_64__)
   assert(validVectorRegister(regNum));
   _xmm[regNum - UNW_X86_64_XMM0] = value;
 #else
diff --git a/libunwind/src/Unwind-seh.cpp b/libunwind/src/Unwind-seh.cpp
index 110c5987c3f1ab4cb555deb0dcd3cf5c1483156c..6783bdccd33a1fe29dc181d92f8ac75cc3fc4468 100644
--- a/libunwind/src/Unwind-seh.cpp
+++ b/libunwind/src/Unwind-seh.cpp
@@ -93,7 +93,7 @@ _GCC_specific_handler(PEXCEPTION_RECORD ms_exc, PVOID frame, PCONTEXT ms_ctx,
   bool ours = false;
 
   _LIBUNWIND_TRACE_UNWINDING("_GCC_specific_handler(%#010lx(%lx), %p)",
-                             ms_exc->ExceptionCode, ms_exc->ExceptionFlags,
+                             (unsigned long)ms_exc->ExceptionCode, (unsigned long)ms_exc->ExceptionFlags,
                              (void *)frame);
   if (ms_exc->ExceptionCode == STATUS_GCC_UNWIND) {
     if (IS_TARGET_UNWIND(ms_exc->ExceptionFlags)) {
@@ -148,7 +148,7 @@ _GCC_specific_handler(PEXCEPTION_RECORD ms_exc, PVOID frame, PCONTEXT ms_ctx,
 
   _LIBUNWIND_TRACE_UNWINDING("_GCC_specific_handler() calling personality "
                              "function %p(1, %d, %llx, %p, %p)",
-                             (void *)pers, action, exc->exception_class,
+                             (void *)pers, action, (unsigned long long)exc->exception_class,
                              (void *)exc, (void *)ctx);
   urc = pers(1, action, exc->exception_class, exc, ctx);
   _LIBUNWIND_TRACE_UNWINDING("_GCC_specific_handler() personality returned %d", urc);
diff --git a/libunwind/src/UnwindCursor.hpp b/libunwind/src/UnwindCursor.hpp
index afa0cae79037793dbf8e9188477ee94065fa08b5..28dbf1cec7fa442d1f5912c3a16f5582870477ab 100644
--- a/libunwind/src/UnwindCursor.hpp
+++ b/libunwind/src/UnwindCursor.hpp
@@ -17,9 +17,9 @@
 #include <stdlib.h>
 #include <unwind.h>
 
-#ifdef _WIN32
-  #include <windows.h>
-  #include <ntverp.h>
+#if defined(_WIN32) || defined(__CYGWIN__)
+#include <windows.h>
+#include <ntverp.h>
 #endif
 #ifdef __APPLE__
   #include <mach-o/dyld.h>
@@ -511,7 +511,8 @@ public:
 #endif
 };
 
-#if defined(_LIBUNWIND_SUPPORT_SEH_UNWIND) && defined(_WIN32)
+#if defined(_LIBUNWIND_SUPPORT_SEH_UNWIND) &&                                  \
+    (defined(_WIN32) || defined(__CYGWIN__))
 
 /// \c UnwindCursor contains all state (including all register values) during
 /// an unwind.  This is normally stack-allocated inside a unw_cursor_t.
@@ -2091,7 +2092,7 @@ bool UnwindCursor<A, R>::getInfoFromSEH(pint_t pc) {
   pint_t base;
   RUNTIME_FUNCTION *unwindEntry = lookUpSEHUnwindInfo(pc, &base);
   if (!unwindEntry) {
-    _LIBUNWIND_DEBUG_LOG("\tpc not in table, pc=0x%llX", (uint64_t) pc);
+    _LIBUNWIND_DEBUG_LOG("\tpc not in table, pc=0x%llX", (unsigned long long) pc);
     return false;
   }
   _info.gp = 0;
@@ -2762,7 +2763,8 @@ void UnwindCursor<A, R>::setInfoBasedOnIPRegister(bool isReturnAddress) {
     --pc;
 #endif
 
-#if !(defined(_LIBUNWIND_SUPPORT_SEH_UNWIND) && defined(_WIN32)) &&            \
+#if !(defined(_LIBUNWIND_SUPPORT_SEH_UNWIND) &&                                \
+      (defined(_WIN32) || defined(__CYGWIN__))) &&                             \
     !defined(_LIBUNWIND_SUPPORT_TBTAB_UNWIND)
   // In case of this is frame of signal handler, the IP saved in the signal
   // handler points to first non-executed instruction, while FDE/CIE expects IP
diff --git a/libunwind/src/UnwindRegistersRestore.S b/libunwind/src/UnwindRegistersRestore.S
index 76a80344034f7175e08a189e42a2dc2592845735..8fc6c81f0adbe22df9741888974ad2b920036930 100644
--- a/libunwind/src/UnwindRegistersRestore.S
+++ b/libunwind/src/UnwindRegistersRestore.S
@@ -79,7 +79,7 @@ DEFINE_LIBUNWIND_FUNCTION(__libunwind_Registers_x86_64_jumpto)
 #
 # extern "C" void __libunwind_Registers_x86_64_jumpto(Registers_x86_64 *);
 #
-#if defined(_WIN64)
+#if defined(_WIN64) || defined(__CYGWIN__)
 # On entry, thread_state pointer is in rcx; move it into rdi
 # to share restore code below. Since this routine restores and
 # overwrites all registers, we can use the same registers for
@@ -120,7 +120,7 @@ DEFINE_LIBUNWIND_FUNCTION(__libunwind_Registers_x86_64_jumpto)
   # skip fs
   # skip gs
 
-#if defined(_WIN64)
+#if defined(_WIN64) || defined(__CYGWIN__)
   movdqu 176(%rdi),%xmm0
   movdqu 192(%rdi),%xmm1
   movdqu 208(%rdi),%xmm2
diff --git a/libunwind/src/UnwindRegistersSave.S b/libunwind/src/UnwindRegistersSave.S
index f988fd461def170a20b8cb2828533fb32191e84d..956c79fc509978040ec1a989f90989b64b55224a 100644
--- a/libunwind/src/UnwindRegistersSave.S
+++ b/libunwind/src/UnwindRegistersSave.S
@@ -121,7 +121,7 @@ DEFINE_LIBUNWIND_FUNCTION("#__unw_getcontext")
 #  thread_state pointer is in rdi
 #
 DEFINE_LIBUNWIND_FUNCTION(__unw_getcontext)
-#if defined(_WIN64)
+#if defined(_WIN64) || defined(__CYGWIN__)
 #define PTR %rcx
 #define TMP %rdx
 #else
@@ -154,7 +154,7 @@ DEFINE_LIBUNWIND_FUNCTION(__unw_getcontext)
   # skip fs
   # skip gs
 
-#if defined(_WIN64)
+#if defined(_WIN64) || defined(__CYGWIN__)
   movdqu %xmm0,176(PTR)
   movdqu %xmm1,192(PTR)
   movdqu %xmm2,208(PTR)
diff --git a/libunwind/src/assembly.h b/libunwind/src/assembly.h
index 84c9d526f1d7594e456b5a31c11adff57f79551a..e222ea9fb2180c53d4104b78ae5a5eb5b3b55f90 100644
--- a/libunwind/src/assembly.h
+++ b/libunwind/src/assembly.h
@@ -165,6 +165,7 @@
 #endif
 #define WEAK_SYMBOL(name) .weak name
 
+// clang-format off
 #if defined(__hexagon__)
 #define WEAK_ALIAS(name, aliasname)                                            \
   EXPORT_SYMBOL(SYMBOL_NAME(aliasname)) SEPARATOR                              \
@@ -176,6 +177,7 @@
   WEAK_SYMBOL(SYMBOL_NAME(aliasname)) SEPARATOR                                \
   SYMBOL_NAME(aliasname) = SYMBOL_NAME(name)
 #endif
+// clang-format on
 
 #if defined(__GNU__) || defined(__FreeBSD__) || defined(__Fuchsia__) || \
     defined(__linux__)
@@ -184,8 +186,9 @@
 #define NO_EXEC_STACK_DIRECTIVE
 #endif
 
-#elif defined(_WIN32)
+#elif defined(_WIN32) || defined(__CYGWIN__)
 
+// clang-format off
 #define SYMBOL_IS_FUNC(name)                                                   \
   .def name SEPARATOR                                                          \
     .scl 2 SEPARATOR                                                           \
@@ -201,8 +204,10 @@
 #define EXPORT_SYMBOL(name) EXPORT_SYMBOL2(name)
 #endif
 #define HIDDEN_SYMBOL(name)
+// clang-format off
 
-#if defined(__MINGW32__)
+// clang-format off
+#if defined(__MINGW32__) || defined(__CYGWIN__)
 #define WEAK_ALIAS(name, aliasname)                                            \
   .globl SYMBOL_NAME(aliasname) SEPARATOR                                      \
   EXPORT_SYMBOL(aliasname) SEPARATOR                                           \
@@ -218,6 +223,7 @@
   EXPORT_SYMBOL(SYMBOL_NAME(aliasname)) SEPARATOR                              \
   WEAK_ALIAS2(SYMBOL_NAME(name), SYMBOL_NAME(aliasname))
 #endif
+// clang-format on
 
 #define NO_EXEC_STACK_DIRECTIVE
 
diff --git a/libunwind/src/config.h b/libunwind/src/config.h
index f017403fa2234f7234e784eefeafe8eae6b1a59b..c0870efd8b993808ecb1495d3e832d20339c8c30 100644
--- a/libunwind/src/config.h
+++ b/libunwind/src/config.h
@@ -31,7 +31,7 @@
   #if defined(__aarch64__) || defined(__arm64__) || defined(__arm64e__)
     #define _LIBUNWIND_TRACE_RET_INJECT 1
   #endif
-#elif defined(_WIN32)
+#elif defined(_WIN32) || defined(__CYGWIN__)
   #ifdef __SEH__
     #define _LIBUNWIND_SUPPORT_SEH_UNWIND 1
   #else
@@ -113,6 +113,10 @@
                                              SYMBOL_NAME(name)))               \
   extern "C" _LIBUNWIND_EXPORT __typeof(name) aliasname;
 #endif
+#elif defined(__CYGWIN__)
+#define _LIBUNWIND_WEAK_ALIAS(name, aliasname)                                 \
+  extern "C" _LIBUNWIND_EXPORT __typeof(name) aliasname                        \
+      __attribute__((alias(#name)));
 #else
 #error Unsupported target
 #endif
@@ -135,7 +139,7 @@
 #ifndef _LIBUNWIND_REMEMBER_HEAP_ALLOC
 #if defined(_LIBUNWIND_REMEMBER_STACK_ALLOC) || defined(__APPLE__) ||          \
     defined(__linux__) || defined(__ANDROID__) || defined(__MINGW32__) ||      \
-    defined(_LIBUNWIND_IS_BAREMETAL)
+    defined(_LIBUNWIND_IS_BAREMETAL) || defined(__CYGWIN__)
 #define _LIBUNWIND_REMEMBER_ALLOC(_size) __builtin_alloca(_size)
 #define _LIBUNWIND_REMEMBER_FREE(_ptr)                                         \
   do {                                                                         \
diff --git a/libunwind/test/signal_frame.pass.cpp b/libunwind/test/signal_frame.pass.cpp
index 004029cfe1e90b27d3672ca5403fa23f2b24c115..0bc9dfacb5364bbdbc770c2f1922fed0707d687a 100644
--- a/libunwind/test/signal_frame.pass.cpp
+++ b/libunwind/test/signal_frame.pass.cpp
@@ -24,6 +24,7 @@
 // Windows doesn't generally use CFI directives. However, i686
 // mingw targets do use DWARF (where CFI directives are supported).
 // UNSUPPORTED: target={{x86_64|arm.*|aarch64}}-{{.*}}-windows-{{.*}}
+// UNSUPPORTED: cygwin
 
 #undef NDEBUG
 #include <assert.h>
-- 
2.52.0

