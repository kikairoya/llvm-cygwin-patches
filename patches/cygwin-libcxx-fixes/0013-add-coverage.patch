From 8a7e7a1eb273ff2c9a30480acf9fc2ecfbdb29a0 Mon Sep 17 00:00:00 2001
From: kikairoya <kikairoya@gmail.com>
Date: Fri, 5 Dec 2025 23:40:07 +0900
Subject: [PATCH 13/42] add coverage

---
 ...licit_instantiation.exclude_from_dllexport.cpp | 15 +++++++++++++++
 ...licit_instantiation.exclude_from_dllimport.cpp | 15 +++++++++++++++
 2 files changed, 30 insertions(+)

diff --git a/clang/test/CodeGenCXX/attr-exclude_from_explicit_instantiation.exclude_from_dllexport.cpp b/clang/test/CodeGenCXX/attr-exclude_from_explicit_instantiation.exclude_from_dllexport.cpp
index c955c932a3619a03bd0d9f89a0ede5088c496b84..f9cbd1760707f907b1efd53bfca43c264c395caa 100644
--- a/clang/test/CodeGenCXX/attr-exclude_from_explicit_instantiation.exclude_from_dllexport.cpp
+++ b/clang/test/CodeGenCXX/attr-exclude_from_explicit_instantiation.exclude_from_dllexport.cpp
@@ -30,12 +30,18 @@ struct C {
 
   // This won't be instantiated.
   EXCLUDE_FROM_EXPLICIT_INSTANTIATION void not_to_be_instantiated();
+
+  struct EXCLUDE_FROM_EXPLICIT_INSTANTIATION inner {
+    // This will be instantiated implicitly but won't be exported.
+    static void inner_not_to_be_exported();
+  };
 };
 
 template <class T> void C<T>::to_be_exported() {}
 template <class T> void C<T>::to_be_exported_explicitly() {}
 template <class T> void C<T>::not_to_be_exported() {}
 template <class T> void C<T>::not_to_be_instantiated() {}
+template <class T> void C<T>::inner::inner_not_to_be_exported() {}
 
 // Attach the attribute to class template declaration instead of instantiation declaration.
 template <class T>
@@ -70,6 +76,7 @@ template <class T> void E<T>::to_be_exported_explicitly() {}
 // MSC: $"?to_be_exported@?$E@I@@UEAAXXZ" = comdat any
 // MSC: $"?to_be_exported_explicitly@?$C@H@@QEAAXXZ" = comdat any
 // MSC: $"?not_to_be_exported@?$C@H@@QEAAXXZ" = comdat any
+// MSC: $"?inner_not_to_be_exported@inner@?$C@H@@SAXXZ" = comdat any
 // MSC: $"?to_be_exported_iff_no_explicit_instantiation@?$D@H@@QEAAXXZ" = comdat any
 // MSC: $"?to_be_exported_iff_no_explicit_instantiation@?$D@I@@QEAAXXZ" = comdat any
 // MSC: $"?to_be_instantiated@?$E@H@@UEAAXXZ" = comdat any
@@ -81,6 +88,7 @@ template <class T> void E<T>::to_be_exported_explicitly() {}
 // GNU: $_ZN1EIjE14to_be_exportedEv = comdat any
 // GNU: $_ZN1CIiE25to_be_exported_explicitlyEv = comdat any
 // GNU: $_ZN1CIiE18not_to_be_exportedEv = comdat any
+// GNU: $_ZN1CIiE5inner24inner_not_to_be_exportedEv = comdat any
 // GNU: $_ZN1DIiE44to_be_exported_iff_no_explicit_instantiationEv = comdat any
 // GNU: $_ZN1DIjE44to_be_exported_iff_no_explicit_instantiationEv = comdat any
 // GNU: $_ZN1EIiE18to_be_instantiatedEv = comdat any
@@ -145,6 +153,10 @@ void use() {
   // GNU: call void @_ZN1CIiE18not_to_be_exportedEv
   c.not_to_be_exported(); // implicitly instantiated here
 
+  // MSC: call void @"?inner_not_to_be_exported@inner@?$C@H@@SAXXZ"
+  // GNU: call void @_ZN1CIiE5inner24inner_not_to_be_exportedEv
+  C<int>::inner::inner_not_to_be_exported(); // implicitly instanciated here
+
   D<int> di;
 
   // MSC: call void @"?to_be_exported_iff_no_explicit_instantiation@?$D@H@@QEAAXXZ"
@@ -164,6 +176,9 @@ void use() {
 // MSC: define linkonce_odr dso_local void @"?not_to_be_exported@?$C@H@@QEAAXXZ"
 // GNU: define linkonce_odr dso_local void @_ZN1CIiE18not_to_be_exportedEv
 
+// MSC: define linkonce_odr dso_local void @"?inner_not_to_be_exported@inner@?$C@H@@SAXXZ"
+// GNU: define linkonce_odr dso_local void @_ZN1CIiE5inner24inner_not_to_be_exportedEv
+
 // MSC: define linkonce_odr dso_local void @"?to_be_exported_iff_no_explicit_instantiation@?$D@H@@QEAAXXZ"
 // MSC: define weak_odr dso_local dllexport void @"?to_be_exported_iff_no_explicit_instantiation@?$D@I@@QEAAXXZ"
 // GNU: define linkonce_odr dso_local void @_ZN1DIiE44to_be_exported_iff_no_explicit_instantiationEv
diff --git a/clang/test/CodeGenCXX/attr-exclude_from_explicit_instantiation.exclude_from_dllimport.cpp b/clang/test/CodeGenCXX/attr-exclude_from_explicit_instantiation.exclude_from_dllimport.cpp
index 492a83767c7e5dae1f47c58ef705ced13609e33e..ce75746acf78ef0e3472ea59a5428e5d4b8ad220 100644
--- a/clang/test/CodeGenCXX/attr-exclude_from_explicit_instantiation.exclude_from_dllimport.cpp
+++ b/clang/test/CodeGenCXX/attr-exclude_from_explicit_instantiation.exclude_from_dllimport.cpp
@@ -30,11 +30,17 @@ struct C {
 
   // This won't be instantiated.
   EXCLUDE_FROM_EXPLICIT_INSTANTIATION void not_to_be_instantiated();
+
+  struct EXCLUDE_FROM_EXPLICIT_INSTANTIATION inner {
+    // This will be instantiated implicitly but won't be imported.
+    static void inner_not_to_be_imported();
+  };
 };
 
 template <class T> void C<T>::to_be_imported() {}
 template <class T> void C<T>::not_to_be_imported() {}
 template <class T> void C<T>::not_to_be_instantiated() {}
+template <class T> void C<T>::inner::inner_not_to_be_imported() {}
 
 // Attach the attribute to class template declaration instead of instantiation declaration.
 template <class T>
@@ -78,10 +84,12 @@ template <class T> void E<T>::to_be_imported() {}
 template <class T> void E<T>::to_be_instantiated() {}
 
 // MSC: $"?not_to_be_imported@?$C@H@@QEAAXXZ" = comdat any
+// MSC: $"?inner_not_to_be_imported@inner@?$C@H@@SAXXZ" = comdat any
 // MSC: $"?to_be_imported_iff_no_explicit_instantiation@?$D@H@@QEAAXXZ" = comdat any
 // MSC: $"?to_be_instantiated@?$E@H@@UEAAXXZ" = comdat any
 // MSC: $"?to_be_instantiated@?$E@I@@UEAAXXZ" = comdat any
 // GNU: $_ZN1CIiE18not_to_be_importedEv = comdat any
+// GNU: $_ZN1CIiE5inner24inner_not_to_be_importedEv = comdat any
 // GNU: $_ZN1DIiE44to_be_imported_iff_no_explicit_instantiationEv = comdat any
 // GNU: @_ZTV1EIiE = external dllimport unnamed_addr
 // GNU: @_ZTV1EIjE = external unnamed_addr
@@ -116,6 +124,10 @@ void use() {
   // GNU: call void @_ZN1CIiE18not_to_be_importedEv
   c.not_to_be_imported(); // implicitly instantiated here
 
+  // MSC: call void @"?inner_not_to_be_imported@inner@?$C@H@@SAXXZ"
+  // GNU: call void @_ZN1CIiE5inner24inner_not_to_be_importedEv
+  C<int>::inner::inner_not_to_be_imported(); // implicitly instantiated here
+
   D<int> di;
 
   // MSC: call void @"?to_be_imported_iff_no_explicit_instantiation@?$D@H@@QEAAXXZ"
@@ -146,6 +158,9 @@ void use() {
 // MSC: define linkonce_odr dso_local void @"?not_to_be_imported@?$C@H@@QEAAXXZ"
 // GNU: define linkonce_odr dso_local void @_ZN1CIiE18not_to_be_importedEv
 
+// MSC: define linkonce_odr dso_local void @"?inner_not_to_be_imported@inner@?$C@H@@SAXXZ"
+// GNU: define linkonce_odr dso_local void @_ZN1CIiE5inner24inner_not_to_be_importedEv
+
 // MSC: define linkonce_odr dso_local void @"?to_be_imported_iff_no_explicit_instantiation@?$D@H@@QEAAXXZ"
 // MSC: declare dllimport void @"?to_be_imported_iff_no_explicit_instantiation@?$D@I@@QEAAXXZ"
 // GNU: define linkonce_odr dso_local void @_ZN1DIiE44to_be_imported_iff_no_explicit_instantiationEv
-- 
2.52.0

