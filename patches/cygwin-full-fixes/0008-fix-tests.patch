From 5a16b110f4efc41bb1c64d601061d9abff5a472c Mon Sep 17 00:00:00 2001
From: kikairoya <kikairoya@gmail.com>
Date: Fri, 5 Dec 2025 21:49:19 +0900
Subject: [PATCH 08/59] fix tests

---
 ...t_instantiation.exclude_from_dllexport.cpp | 46 +++++++++++--------
 ...t_instantiation.exclude_from_dllimport.cpp | 44 +++++++++---------
 2 files changed, 47 insertions(+), 43 deletions(-)

diff --git a/clang/test/CodeGenCXX/attr-exclude_from_explicit_instantiation.exclude_from_dllexport.cpp b/clang/test/CodeGenCXX/attr-exclude_from_explicit_instantiation.exclude_from_dllexport.cpp
index 4bff5a828f34ca2457c408b4f1c1a73490c57aed..2f6767bc96142d23430d2b4e0c60b1bd6141ee2a 100644
--- a/clang/test/CodeGenCXX/attr-exclude_from_explicit_instantiation.exclude_from_dllexport.cpp
+++ b/clang/test/CodeGenCXX/attr-exclude_from_explicit_instantiation.exclude_from_dllexport.cpp
@@ -40,15 +40,11 @@ template <class T> void C<T>::not_to_be_instantiated() noexcept {}
 // Attach the attribute to class template declaration instead of instantiation declaration.
 template <class T>
 struct __declspec(dllexport) D {
-  // This should be exported by the class-level attribute.
-  void to_be_exported() noexcept;
-
-  // This also should be exported by the class-level attribute but currently not.
-  EXCLUDE_FROM_EXPLICIT_INSTANTIATION void also_to_be_exported() noexcept;
+  // This will be exported if and only if no explicit instantiations are provided.
+  EXCLUDE_FROM_EXPLICIT_INSTANTIATION void to_be_exported_iff_no_explicit_instantiation() noexcept;
 };
 
-template <class T> void D<T>::to_be_exported() noexcept {}
-template <class T> void D<T>::also_to_be_exported() noexcept {}
+template <class T> void D<T>::to_be_exported_iff_no_explicit_instantiation() noexcept {}
 
 // Interaction with VTables.
 template <class T>
@@ -70,23 +66,23 @@ template <class T> void E<T>::to_be_instantiated() noexcept {}
 template <class T> void E<T>::to_be_exported_explicitly() noexcept {}
 
 // MSC: $"?to_be_exported@?$C@H@@QEAAXXZ" = comdat any
-// MSC: $"?to_be_exported@?$D@H@@QEAAXXZ" = comdat any
 // MSC: $"?to_be_exported@?$E@H@@UEAAXXZ" = comdat any
 // MSC: $"?to_be_exported@?$E@I@@UEAAXXZ" = comdat any
 // MSC: $"?to_be_exported_explicitly@?$C@H@@QEAAXXZ" = comdat any
 // MSC: $"?not_to_be_exported@?$C@H@@QEAAXXZ" = comdat any
-// MSC: $"?also_to_be_exported@?$D@H@@QEAAXXZ" = comdat any
+// MSC: $"?to_be_exported_iff_no_explicit_instantiation@?$D@H@@QEAAXXZ" = comdat any
+// MSC: $"?to_be_exported_iff_no_explicit_instantiation@?$D@I@@QEAAXXZ" = comdat any
 // MSC: $"?to_be_instantiated@?$E@H@@UEAAXXZ" = comdat any
 // MSC: $"?to_be_exported_explicitly@?$E@H@@UEAAXXZ" = comdat any
 // MSC: $"?to_be_instantiated@?$E@I@@UEAAXXZ" = comdat any
 // MSC: $"?to_be_exported_explicitly@?$E@I@@UEAAXXZ" = comdat any
 // GNU: $_ZN1CIiE14to_be_exportedEv = comdat any
-// GNU: $_ZN1DIiE14to_be_exportedEv = comdat any
 // GNU: $_ZN1EIiE14to_be_exportedEv = comdat any
 // GNU: $_ZN1EIjE14to_be_exportedEv = comdat any
 // GNU: $_ZN1CIiE25to_be_exported_explicitlyEv = comdat any
 // GNU: $_ZN1CIiE18not_to_be_exportedEv = comdat any
-// GNU: $_ZN1DIiE19also_to_be_exportedEv = comdat any
+// GNU: $_ZN1DIiE44to_be_exported_iff_no_explicit_instantiationEv = comdat any
+// GNU: $_ZN1DIjE44to_be_exported_iff_no_explicit_instantiationEv = comdat any
 // GNU: $_ZN1EIiE18to_be_instantiatedEv = comdat any
 // GNU: $_ZN1EIiE25to_be_exported_explicitlyEv = comdat any
 // GNU: $_ZN1EIjE18to_be_instantiatedEv = comdat any
@@ -106,10 +102,10 @@ template <class T> void E<T>::to_be_exported_explicitly() noexcept {}
 template struct __declspec(dllexport) C<int>;
 
 // MSC: define weak_odr dso_local dllexport{{.*}} ptr @"??4?$D@H@@QEAAAEAU0@AEBU0@@Z"
-// MSC: define weak_odr dso_local dllexport{{.*}} void @"?to_be_exported@?$D@H@@QEAAXXZ"
 // GNU: define weak_odr dso_local dllexport{{.*}} ptr @_ZN1DIiEaSERKS0_
-// GNU: define weak_odr dso_local dllexport{{.*}} void @_ZN1DIiE14to_be_exportedEv
-template struct D<int>;
+template struct D<int>; // No dllexport here.
+// Don't provide explicit instantiation for D<unsigned>.
+
 
 // MSC: define weak_odr dso_local dllexport{{.*}} ptr @"??4?$E@H@@QEAAAEAU0@AEBU0@@Z"
 // MSC: define weak_odr dso_local dllexport{{.*}} ptr @"??0?$E@H@@QEAA@XZ"
@@ -127,6 +123,8 @@ template struct __declspec(dllexport) E<int>;
 // GNU: define weak_odr dso_local{{.*}} void @_ZN1EIjE14to_be_exportedEv
 template struct E<unsigned int>;
 
+// MSC: define weak_odr dso_local dllexport{{.*}} ptr @"??4?$D@I@@QEAAAEAU0@AEBU0@@Z"
+
 void use() {
   C<int> c;
 
@@ -138,11 +136,17 @@ void use() {
   // GNU: call void @_ZN1CIiE18not_to_be_exportedEv
   c.not_to_be_exported(); // implicitly instantiated here
 
-  D<int> d;
+  D<int> di;
+
+  // MSC: call void @"?to_be_exported_iff_no_explicit_instantiation@?$D@H@@QEAAXXZ"
+  // GNU: call void @_ZN1DIiE44to_be_exported_iff_no_explicit_instantiationEv
+  di.to_be_exported_iff_no_explicit_instantiation(); // implicitly instantiated here
+
+  D<unsigned> dj;
 
-  // MSC: call void @"?also_to_be_exported@?$D@H@@QEAAXXZ"
-  // GNU: call void @_ZN1DIiE19also_to_be_exportedEv
-  d.also_to_be_exported(); // implicitly instantiated here
+  // MSC: call void @"?to_be_exported_iff_no_explicit_instantiation@?$D@I@@QEAAXXZ"
+  // GNU: call void @_ZN1DIjE44to_be_exported_iff_no_explicit_instantiationEv
+  dj.to_be_exported_iff_no_explicit_instantiation(); // implicitly instantiated here
 }
 
 // MSC: define weak_odr dso_local dllexport{{.*}} void @"?to_be_exported_explicitly@?$C@H@@QEAAXXZ"
@@ -151,8 +155,10 @@ void use() {
 // MSC: define linkonce_odr dso_local void @"?not_to_be_exported@?$C@H@@QEAAXXZ"
 // GNU: define linkonce_odr dso_local void @_ZN1CIiE18not_to_be_exportedEv
 
-// MSC: define linkonce_odr dso_local void @"?also_to_be_exported@?$D@H@@QEAAXXZ"
-// GNU: define linkonce_odr dso_local void @_ZN1DIiE19also_to_be_exportedEv
+// MSC: define linkonce_odr dso_local void @"?to_be_exported_iff_no_explicit_instantiation@?$D@H@@QEAAXXZ"
+// MSC: define weak_odr dso_local dllexport void @"?to_be_exported_iff_no_explicit_instantiation@?$D@I@@QEAAXXZ"
+// GNU: define linkonce_odr dso_local void @_ZN1DIiE44to_be_exported_iff_no_explicit_instantiationEv
+// GNU: define weak_odr dso_local dllexport void @_ZN1DIjE44to_be_exported_iff_no_explicit_instantiationEv
 
 // MSC: define linkonce_odr dso_local void @"?to_be_instantiated@?$E@H@@UEAAXXZ"
 // MSC: define weak_odr dso_local dllexport void @"?to_be_exported_explicitly@?$E@H@@UEAAXXZ"
diff --git a/clang/test/CodeGenCXX/attr-exclude_from_explicit_instantiation.exclude_from_dllimport.cpp b/clang/test/CodeGenCXX/attr-exclude_from_explicit_instantiation.exclude_from_dllimport.cpp
index 6cb169bb5a4d8e034316c05d69dc2ae1b1ffbc1e..ff5298ec56605c9e7990a22e1ed4dbb790387fc6 100644
--- a/clang/test/CodeGenCXX/attr-exclude_from_explicit_instantiation.exclude_from_dllimport.cpp
+++ b/clang/test/CodeGenCXX/attr-exclude_from_explicit_instantiation.exclude_from_dllimport.cpp
@@ -39,15 +39,11 @@ template <class T> void C<T>::not_to_be_instantiated() noexcept {}
 // Attach the attribute to class template declaration instead of instantiation declaration.
 template <class T>
 struct __declspec(dllimport) D {
-  // This will be imported by the class-level attribute.
-  void to_be_imported() noexcept;
-
-  // This also should be imported by the class-level attribute but currently not.
-  EXCLUDE_FROM_EXPLICIT_INSTANTIATION void also_to_be_imported() noexcept;
+  // This will be imported if and only if no explicit instantiations are provided.
+  EXCLUDE_FROM_EXPLICIT_INSTANTIATION void to_be_imported_iff_no_explicit_instantiation() noexcept;
 };
 
-template <class T> void D<T>::to_be_imported() noexcept {}
-template <class T> void D<T>::also_to_be_imported() noexcept {}
+template <class T> void D<T>::to_be_imported_iff_no_explicit_instantiation() noexcept {}
 
 // Interaction with VTables.
 template <class T>
@@ -82,9 +78,9 @@ template <class T> void E<T>::to_be_imported() noexcept {}
 template <class T> void E<T>::to_be_instantiated() noexcept {}
 
 // MSC: $"?not_to_be_imported@?$C@H@@QEAAXXZ" = comdat any
-// MSC: $"?also_to_be_imported@?$D@H@@QEAAXXZ" = comdat any
+// MSC: $"?to_be_imported_iff_no_explicit_instantiation@?$D@H@@QEAAXXZ" = comdat any
 // GNU: $_ZN1CIiE18not_to_be_importedEv = comdat any
-// GNU: $_ZN1DIiE19also_to_be_importedEv = comdat any
+// GNU: $_ZN1DIiE44to_be_imported_iff_no_explicit_instantiationEv = comdat any
 // GNU: @_ZTV1EIiE = external dllimport unnamed_addr
 // GNU: @_ZTV1EIjE = external unnamed_addr
 
@@ -95,7 +91,8 @@ template <class T> void E<T>::to_be_instantiated() noexcept {}
 
 extern template struct __declspec(dllimport) C<int>;
 
-extern template struct D<int>;
+extern template struct D<int>; // No dllimport here.
+// Don't provide explicit instantiation for D<unsigned>.
 
 extern template struct __declspec(dllimport) E<int>;      // $E@H, 1EIiE
 extern template struct E<unsigned>;                       // $E@I, 1EIjE
@@ -117,15 +114,17 @@ void use() {
   // GNU: call void @_ZN1CIiE18not_to_be_importedEv
   c.not_to_be_imported(); // implicitly instantiated here
 
-  D<int> d;
+  D<int> di;
 
-  // MSC: call void @"?to_be_imported@?$D@H@@QEAAXXZ"
-  // GNU: call void @_ZN1DIiE14to_be_importedEv
-  d.to_be_imported(); // implicitly instantiated here
+  // MSC: call void @"?to_be_imported_iff_no_explicit_instantiation@?$D@H@@QEAAXXZ"
+  // GNU: call void @_ZN1DIiE44to_be_imported_iff_no_explicit_instantiationEv
+  di.to_be_imported_iff_no_explicit_instantiation(); // implicitly instantiated here
 
-  // MSC: call void @"?also_to_be_imported@?$D@H@@QEAAXXZ"
-  // GNU: call void @_ZN1DIiE19also_to_be_importedEv
-  d.also_to_be_imported(); // implicitly instantiated here
+  D<unsigned> dj;
+
+  // MSC: call void @"?to_be_imported_iff_no_explicit_instantiation@?$D@I@@QEAAXXZ"
+  // GNU: call void @_ZN1DIjE44to_be_imported_iff_no_explicit_instantiationEv
+  dj.to_be_imported_iff_no_explicit_instantiation(); // implicitly instantiated here
 
   E<int> ei{1};
 
@@ -133,7 +132,7 @@ void use() {
 
   E<long int> el{1L};
 
-  E<unsigned long int> eu{1L};
+  E<unsigned long int> em{1L};
 }
 
 // MSC: declare dllimport void @"?to_be_imported@?$C@H@@QEAAXXZ"
@@ -145,11 +144,10 @@ void use() {
 // MSC: define linkonce_odr dso_local void @"?not_to_be_imported@?$C@H@@QEAAXXZ"
 // GNU: define linkonce_odr dso_local void @_ZN1CIiE18not_to_be_importedEv
 
-// MSC: declare dllimport void @"?to_be_imported@?$D@H@@QEAAXXZ"
-// GNU: declare dllimport void @_ZN1DIiE14to_be_importedEv
-
-// MSC: define linkonce_odr dso_local void @"?also_to_be_imported@?$D@H@@QEAAXXZ"
-// GNU: define linkonce_odr dso_local void @_ZN1DIiE19also_to_be_importedEv
+// MSC: define linkonce_odr dso_local void @"?to_be_imported_iff_no_explicit_instantiation@?$D@H@@QEAAXXZ"
+// MSC: declare dllimport void @"?to_be_imported_iff_no_explicit_instantiation@?$D@I@@QEAAXXZ"
+// GNU: define linkonce_odr dso_local void @_ZN1DIiE44to_be_imported_iff_no_explicit_instantiationEv
+// GNU: declare dllimport void @_ZN1DIjE44to_be_imported_iff_no_explicit_instantiationEv
 
 // MSC: declare dllimport noundef ptr @"??0?$E@J@@QEAA@J@Z"
 // MSC: declare dso_local noundef ptr @"??0?$E@K@@QEAA@J@Z"
-- 
2.52.0

