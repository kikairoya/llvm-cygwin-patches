From 9c8b003bd0330a302760cf5c3bbb7dad2017788a Mon Sep 17 00:00:00 2001
From: kikairoya <kikairoya@gmail.com>
Date: Sat, 13 Sep 2025 19:32:51 +0900
Subject: [PATCH 2/6] [compiler-rt][Cygwin] Add support for Cygwin target

---
 compiler-rt/cmake/config-ix.cmake               | 15 ++++++++++++++-
 compiler-rt/lib/builtins/CMakeLists.txt         | 17 +++++++++++------
 compiler-rt/lib/profile/InstrProfilingMerge.c   |  2 +-
 .../lib/profile/InstrProfilingPlatformOther.c   |  2 +-
 .../lib/profile/InstrProfilingPlatformWindows.c |  3 ++-
 compiler-rt/lib/profile/InstrProfilingWriter.c  |  2 +-
 6 files changed, 30 insertions(+), 11 deletions(-)

diff --git a/compiler-rt/cmake/config-ix.cmake b/compiler-rt/cmake/config-ix.cmake
index 1f82ff3cf75312d58c1a28547a75174fc09df536..b32dadab445856595bbc39470208f0b1aab32b29 100644
--- a/compiler-rt/cmake/config-ix.cmake
+++ b/compiler-rt/cmake/config-ix.cmake
@@ -66,6 +66,19 @@ if (C_SUPPORTS_NODEFAULTLIBS_FLAG)
                         moldname mingwex msvcrt)
     list(APPEND CMAKE_REQUIRED_LIBRARIES ${MINGW_LIBRARIES})
   endif()
+  if (CYGWIN)
+    # Cygwin requires quite a few "C" runtime libraries in order for basic
+    # programs to link successfully with -nodefaultlibs.
+    if (COMPILER_RT_USE_BUILTINS_LIBRARY)
+      set(CYGWIN_RUNTIME ${COMPILER_RT_BUILTINS_LIBRARY})
+    else ()
+      set(CYGWIN_RUNTIME gcc_s gcc)
+    endif()
+    set(CYGWIN_LIBRARIES cygwin ${CYGWIN_RUNTIME} advapi32
+                         shell32 user32 kernel32 ${CYGWIN_RUNTIME}
+                         cygwin)
+    list(APPEND CMAKE_REQUIRED_LIBRARIES ${CYGWIN_LIBRARIES})
+  endif()
   if (NOT TARGET unwind)
     # Don't check for a library named unwind, if there's a target with that name within
     # the same build.
@@ -842,7 +855,7 @@ else()
 endif()
 
 if (PROFILE_SUPPORTED_ARCH AND NOT LLVM_USE_SANITIZER AND
-    (OS_NAME MATCHES "Darwin|Linux|FreeBSD|Windows|Android|Fuchsia|SunOS|NetBSD|AIX|WASI|Haiku" OR COMPILER_RT_PROFILE_BAREMETAL))
+    (OS_NAME MATCHES "Darwin|Linux|FreeBSD|Windows|Android|Fuchsia|SunOS|NetBSD|AIX|WASI|Haiku|CYGWIN" OR COMPILER_RT_PROFILE_BAREMETAL))
   set(COMPILER_RT_HAS_PROFILE TRUE)
 else()
   set(COMPILER_RT_HAS_PROFILE FALSE)
diff --git a/compiler-rt/lib/builtins/CMakeLists.txt b/compiler-rt/lib/builtins/CMakeLists.txt
index c3dbd65998f153bef7edfa874550da439d988670..6761be89b52895740400fd0f9366a06ebe5636ef 100644
--- a/compiler-rt/lib/builtins/CMakeLists.txt
+++ b/compiler-rt/lib/builtins/CMakeLists.txt
@@ -45,6 +45,11 @@ if (CMAKE_SOURCE_DIR STREQUAL CMAKE_CURRENT_SOURCE_DIR)
     set(MINGW_LIBRARIES mingw32 moldname mingwex msvcrt advapi32 shell32
                         user32 kernel32 mingw32 moldname mingwex msvcrt)
    endif()
+  if(CYGWIN)
+    # Simplified version of what's set in cmake/config-ix.cmake; not including
+    # builtins, which are linked separately.
+    set(CYGWIN_LIBRARIES cygwin advapi32 shell32 user32 kernel32 cygwin)
+   endif()
 endif()
 
 if (COMPILER_RT_STANDALONE_BUILD)
@@ -328,7 +333,7 @@ if (NOT MSVC)
     x86_64/floatdidf.c
     x86_64/floatdisf.c
   )
-  if (NOT WIN32)
+  if (NOT WIN32 AND NOT CYGWIN)
     set(x86_64_SOURCES
       ${x86_64_SOURCES}
       x86_64/floatundidf.S
@@ -342,7 +347,7 @@ if (NOT MSVC)
       ${x86_80_BIT_SOURCES}
       x86_64/floatdixf.c
     )
-    if (NOT WIN32)
+    if (NOT WIN32 AND NOT CYGWIN)
       set(x86_64_SOURCES
         ${x86_64_SOURCES}
         x86_64/floatundixf.S
@@ -353,7 +358,7 @@ if (NOT MSVC)
   # Darwin x86_64 Haswell
   set(x86_64h_SOURCES ${x86_64_SOURCES})
 
-  if (WIN32)
+  if (WIN32 OR CYGWIN)
     set(x86_64_SOURCES
       ${x86_64_SOURCES}
       x86_64/chkstk.S
@@ -386,7 +391,7 @@ if (NOT MSVC)
     )
   endif()
 
-  if (WIN32)
+  if (WIN32 OR CYGWIN)
     set(i386_SOURCES
       ${i386_SOURCES}
       i386/chkstk.S
@@ -605,7 +610,7 @@ set(arm_min_SOURCES
   ${arm_EABI_SOURCES}
 )
 
-if(MINGW)
+if(MINGW OR CYGWIN)
   set(arm_SOURCES
     arm/aeabi_idivmod.S
     arm/aeabi_ldivmod.S
@@ -716,7 +721,7 @@ foreach(pat cas swp ldadd ldclr ldeor ldset)
   endforeach(size)
 endforeach(pat)
 
-if (MINGW)
+if (MINGW OR CYGWIN)
   set(aarch64_SOURCES
     ${aarch64_SOURCES}
     aarch64/chkstk.S
diff --git a/compiler-rt/lib/profile/InstrProfilingMerge.c b/compiler-rt/lib/profile/InstrProfilingMerge.c
index 681abda0188ac957b1927aa3413387a3cbe7f560..9b88a10c976cf4cac2b9aac79ffabdf49bf7dfdd 100644
--- a/compiler-rt/lib/profile/InstrProfilingMerge.c
+++ b/compiler-rt/lib/profile/InstrProfilingMerge.c
@@ -99,7 +99,7 @@ int __llvm_profile_check_compatibility(const char *ProfileData,
 }
 
 static uintptr_t signextIfWin64(void *V) {
-#ifdef _WIN64
+#if defined(_WIN64) || defined(__CYGWIN64__)
   return (uintptr_t)(int32_t)(uintptr_t)V;
 #else
   return (uintptr_t)V;
diff --git a/compiler-rt/lib/profile/InstrProfilingPlatformOther.c b/compiler-rt/lib/profile/InstrProfilingPlatformOther.c
index f5d1c74f1011532f19c25cbb395edccc0e07217a..a83c5d867e4da9da699a94f9946fc839c266c56a 100644
--- a/compiler-rt/lib/profile/InstrProfilingPlatformOther.c
+++ b/compiler-rt/lib/profile/InstrProfilingPlatformOther.c
@@ -16,7 +16,7 @@
 #if !defined(__APPLE__) && !defined(__linux__) && !defined(__FreeBSD__) &&     \
     !defined(__Fuchsia__) && !(defined(__sun__) && defined(__svr4__)) &&       \
     !defined(__NetBSD__) && !defined(_WIN32) && !defined(_AIX) &&              \
-    !defined(__wasm__) && !defined(__HAIKU__) &&                               \
+    !defined(__wasm__) && !defined(__HAIKU__) && !defined(__CYGWIN__) &&       \
     !defined(COMPILER_RT_PROFILE_BAREMETAL)
 
 #include <stdlib.h>
diff --git a/compiler-rt/lib/profile/InstrProfilingPlatformWindows.c b/compiler-rt/lib/profile/InstrProfilingPlatformWindows.c
index d1b347e861411872b6d48a2dfdd082e0c1df0b7f..3dde4a25e68f55282b557dfe422909144b689731 100644
--- a/compiler-rt/lib/profile/InstrProfilingPlatformWindows.c
+++ b/compiler-rt/lib/profile/InstrProfilingPlatformWindows.c
@@ -7,11 +7,12 @@
 \*===----------------------------------------------------------------------===*/
 
 #include <stddef.h>
+#include <string.h>
 
 #include "InstrProfiling.h"
 #include "InstrProfilingInternal.h"
 
-#if defined(_WIN32)
+#if defined(_WIN32) || defined(__CYGWIN__)
 
 #if defined(_MSC_VER)
 /* Merge read-write sections into .data. */
diff --git a/compiler-rt/lib/profile/InstrProfilingWriter.c b/compiler-rt/lib/profile/InstrProfilingWriter.c
index 633fdb966116275eca4949fdf0fb4cf15ef19ff1..4762c8e3d4a8f83d94685c554233824a3124729f 100644
--- a/compiler-rt/lib/profile/InstrProfilingWriter.c
+++ b/compiler-rt/lib/profile/InstrProfilingWriter.c
@@ -312,7 +312,7 @@ COMPILER_RT_VISIBILITY int lprofWriteDataImpl(
 
   /* On WIN64, label differences are truncated 32-bit values. Truncate
    * CountersDelta to match. */
-#ifdef _WIN64
+#if defined(_WIN64) || defined(__CYGWIN64__)
   Header.CountersDelta = (uint32_t)Header.CountersDelta;
   Header.BitmapDelta = (uint32_t)Header.BitmapDelta;
 #endif
-- 
2.52.0

