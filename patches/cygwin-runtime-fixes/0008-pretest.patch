From 64153d42e39eb35cb5754abf5dcb2a2bf5bdc269 Mon Sep 17 00:00:00 2001
From: kikairoya <kikairoya@gmail.com>
Date: Sun, 30 Nov 2025 07:37:12 +0900
Subject: [PATCH 08/37] pretest

---
 ...t_instantiation.exclude_from_dllexport.cpp | 63 +++++++++++++++++
 ...t_instantiation.exclude_from_dllimport.cpp | 69 +++++++++++++++++++
 2 files changed, 132 insertions(+)

diff --git a/clang/test/CodeGenCXX/attr-exclude_from_explicit_instantiation.exclude_from_dllexport.cpp b/clang/test/CodeGenCXX/attr-exclude_from_explicit_instantiation.exclude_from_dllexport.cpp
index a2d8e37acb626639f57f1b3db8121bcf255acb13..91d9a5987dd409b0abcffc70adce5ed4f1f523b5 100644
--- a/clang/test/CodeGenCXX/attr-exclude_from_explicit_instantiation.exclude_from_dllexport.cpp
+++ b/clang/test/CodeGenCXX/attr-exclude_from_explicit_instantiation.exclude_from_dllexport.cpp
@@ -37,12 +37,49 @@ template <class T> void C<T>::to_be_exported_explicitly() noexcept {}
 template <class T> void C<T>::not_to_be_exported() noexcept {}
 template <class T> void C<T>::not_to_be_instantiated() noexcept {}
 
+template <class T>
+struct D {
+  // This will be instanciated by the explicit template instantiation definition.
+  virtual void to_be_exported() noexcept;
+
+  // This will be instantiated by the VTable definition, regardless of
+  // `exclude_from_explicit_instantiation`.
+  // The dllexport attribute won't be inherited.
+  EXCLUDE_FROM_EXPLICIT_INSTANTIATION virtual void to_be_instantiated() noexcept;
+
+  // This too, but will be exported by the member attribute.
+  EXCLUDE_FROM_EXPLICIT_INSTANTIATION __declspec(dllexport) virtual void to_be_exported_explicitly() noexcept;
+};
+
+template <class T> void D<T>::to_be_exported() noexcept {}
+template <class T> void D<T>::to_be_instantiated() noexcept {}
+template <class T> void D<T>::to_be_exported_explicitly() noexcept {}
+
 // MSC: $"?to_be_exported@?$C@H@@QEAAXXZ" = comdat any
+// MSC: $"?to_be_exported@?$D@H@@UEAAXXZ" = comdat any
+// MSC: $"?to_be_exported@?$D@I@@UEAAXXZ" = comdat any
 // MSC: $"?to_be_exported_explicitly@?$C@H@@QEAAXXZ" = comdat any
 // MSC: $"?not_to_be_exported@?$C@H@@QEAAXXZ" = comdat any
+// MSC: $"?to_be_instantiated@?$D@H@@UEAAXXZ" = comdat any
+// MSC: $"?to_be_exported_explicitly@?$D@H@@UEAAXXZ" = comdat any
+// MSC: $"?to_be_instantiated@?$D@I@@UEAAXXZ" = comdat any
+// MSC: $"?to_be_exported_explicitly@?$D@I@@UEAAXXZ" = comdat any
 // GNU: $_ZN1CIiE14to_be_exportedEv = comdat any
+// GNU: $_ZN1DIiE14to_be_exportedEv = comdat any
+// GNU: $_ZN1DIjE14to_be_exportedEv = comdat any
 // GNU: $_ZN1CIiE25to_be_exported_explicitlyEv = comdat any
 // GNU: $_ZN1CIiE18not_to_be_exportedEv = comdat any
+// GNU: $_ZN1DIiE18to_be_instantiatedEv = comdat any
+// GNU: $_ZN1DIiE25to_be_exported_explicitlyEv = comdat any
+// GNU: $_ZN1DIjE18to_be_instantiatedEv = comdat any
+// GNU: $_ZN1DIjE25to_be_exported_explicitlyEv = comdat any
+
+// MSC: @0 = private unnamed_addr constant {{.*}}, comdat($"??_7?$D@H@@6B@")
+// MSC: @1 = private unnamed_addr constant {{.*}}, comdat($"??_7?$D@I@@6B@")
+// MSC: @"??_7?$D@H@@6B@" = dllexport unnamed_addr
+// MSC: @"??_7?$D@I@@6B@" = unnamed_addr
+// GNU:@_ZTV1DIiE = weak_odr dso_local dllexport unnamed_addr constant {{.*}}, comdat
+// GNU:@_ZTV1DIjE = weak_odr dso_local unnamed_addr constant {{.*}}, comdat
 
 // MSC: define weak_odr dso_local dllexport{{.*}} ptr @"??4?$C@H@@QEAAAEAU0@AEBU0@@Z"
 // MSC: define weak_odr dso_local dllexport{{.*}} void @"?to_be_exported@?$C@H@@QEAAXXZ"
@@ -50,6 +87,22 @@ template <class T> void C<T>::not_to_be_instantiated() noexcept {}
 // GNU: define weak_odr dso_local dllexport{{.*}} void @_ZN1CIiE14to_be_exportedEv
 template struct __declspec(dllexport) C<int>;
 
+// MSC: define weak_odr dso_local dllexport{{.*}} ptr @"??4?$D@H@@QEAAAEAU0@AEBU0@@Z"
+// MSC: define weak_odr dso_local dllexport{{.*}} ptr @"??0?$D@H@@QEAA@XZ"
+// MSC: define weak_odr dso_local dllexport{{.*}} ptr @"??0?$D@H@@QEAA@AEBU0@@Z"
+// MSC: define weak_odr dso_local dllexport{{.*}} void @"?to_be_exported@?$D@H@@UEAAXXZ"
+// GNU: define weak_odr dso_local dllexport{{.*}} ptr @_ZN1DIiEaSERKS0_
+// GNU: define weak_odr dso_local dllexport{{.*}} void @_ZN1DIiEC2Ev
+// GNU: define weak_odr dso_local dllexport{{.*}} void @_ZN1DIiEC1Ev
+// GNU: define weak_odr dso_local dllexport{{.*}} void @_ZN1DIiEC2ERKS0_
+// GNU: define weak_odr dso_local dllexport{{.*}} void @_ZN1DIiEC1ERKS0_
+// GNU: define weak_odr dso_local dllexport{{.*}} void @_ZN1DIiE14to_be_exportedEv
+template struct __declspec(dllexport) D<int>;
+
+// MSC: define weak_odr dso_local{{.*}} void @"?to_be_exported@?$D@I@@UEAAXXZ"
+// GNU: define weak_odr dso_local{{.*}} void @_ZN1DIjE14to_be_exportedEv
+template struct D<unsigned int>;
+
 void use() {
   C<int> c;
 
@@ -67,3 +120,13 @@ void use() {
 
 // MSC: define linkonce_odr dso_local void @"?not_to_be_exported@?$C@H@@QEAAXXZ"
 // GNU: define linkonce_odr dso_local void @_ZN1CIiE18not_to_be_exportedEv
+
+// MSC: define linkonce_odr dso_local void @"?to_be_instantiated@?$D@H@@UEAAXXZ"
+// MSC: define weak_odr dso_local dllexport void @"?to_be_exported_explicitly@?$D@H@@UEAAXXZ"
+// GNU: define linkonce_odr dso_local void @_ZN1DIiE18to_be_instantiatedEv
+// GNU: define weak_odr dso_local dllexport void @_ZN1DIiE25to_be_exported_explicitlyEv
+
+// MSC: define linkonce_odr dso_local void @"?to_be_instantiated@?$D@I@@UEAAXXZ"
+// MSC: define weak_odr dso_local dllexport void @"?to_be_exported_explicitly@?$D@I@@UEAAXXZ"
+// GNU: define linkonce_odr dso_local void @_ZN1DIjE18to_be_instantiatedEv
+// GNU: define weak_odr dso_local dllexport void @_ZN1DIjE25to_be_exported_explicitlyEv
diff --git a/clang/test/CodeGenCXX/attr-exclude_from_explicit_instantiation.exclude_from_dllimport.cpp b/clang/test/CodeGenCXX/attr-exclude_from_explicit_instantiation.exclude_from_dllimport.cpp
index fa44f3aaa6e8a46c622e54c2f09e4d3f150d043d..c80c60c4dd443741943da8d3c226b720b9e9ca4a 100644
--- a/clang/test/CodeGenCXX/attr-exclude_from_explicit_instantiation.exclude_from_dllimport.cpp
+++ b/clang/test/CodeGenCXX/attr-exclude_from_explicit_instantiation.exclude_from_dllimport.cpp
@@ -36,10 +36,54 @@ template <class T> void C<T>::to_be_imported() noexcept {}
 template <class T> void C<T>::not_to_be_imported() noexcept {}
 template <class T> void C<T>::not_to_be_instantiated() noexcept {}
 
+template <class T>
+struct D {
+  // For the MSVC ABI: this constructor causes implicit instantiation of
+  // the VTable, which triggers instantiating all virtual member functions
+  // regardless `exclude_from_explicit_instantiation` (currently not).
+  // For the Itanium ABI: Emitting the VTable is suppressed by implicit
+  // instantiation declaration so virtual member functions won't be instantiated.
+  EXCLUDE_FROM_EXPLICIT_INSTANTIATION explicit D(int);
+
+  // This constructor doesn't trigger the instantiation of the VTable.
+  // In this case, declaration of virtual member functions are absent too.
+  explicit D(long);
+
+  // The body of this shouldn't be emitted since instantiation is suppressed
+  // by the explicit instantiation declaration.
+  virtual void to_be_imported() noexcept;
+
+  // The body of this should be emitted if the VTable is instantiated, even if
+  // the instantiation of this class template is declared with dllimport.
+  EXCLUDE_FROM_EXPLICIT_INSTANTIATION virtual void to_be_instantiated() noexcept;
+
+  // The body of this shouldn't be emitted since that comes from an external DLL.
+  EXCLUDE_FROM_EXPLICIT_INSTANTIATION __declspec(dllimport) virtual void to_be_imported_explicitly() noexcept;
+
+};
+
+template <class T> D<T>::D(int) {}
+template <class T> D<T>::D(long) {}
+template <class T> void D<T>::to_be_imported() noexcept {}
+template <class T> void D<T>::to_be_instantiated() noexcept {}
+
 // MSC: $"?not_to_be_imported@?$C@H@@QEAAXXZ" = comdat any
 // GNU: $_ZN1CIiE18not_to_be_importedEv = comdat any
+// GNU: @_ZTV1DIiE = external dllimport unnamed_addr
+// GNU: @_ZTV1DIjE = external unnamed_addr
+
+// MSC: @0 = private unnamed_addr constant {{.*}}, comdat($"??_S?$D@H@@6B@")
+// MSC: @1 = private unnamed_addr constant {{.*}}, comdat($"??_7?$D@I@@6B@")
+// MSC: @"??_S?$D@H@@6B@" =
+// MSC: @"??_7?$D@I@@6B@" =
+
 extern template struct __declspec(dllimport) C<int>;
 
+extern template struct __declspec(dllimport) D<int>;      // $D@H, 1DIiE
+extern template struct D<unsigned>;                       // $D@I, 1DIjE
+extern template struct __declspec(dllimport) D<long int>; // $D@J, 1DIlE
+extern template struct D<unsigned long int>;              // $D@K, 1DImE
+
 void use() {
   C<int> c;
 
@@ -54,6 +98,14 @@ void use() {
   // MSC: call void @"?not_to_be_imported@?$C@H@@QEAAXXZ"
   // GNU: call void @_ZN1CIiE18not_to_be_importedEv
   c.not_to_be_imported(); // implicitly instantiated here
+
+  D<int> di{1};
+
+  D<unsigned> dj{1};
+
+  D<long int> dl{1L};
+
+  D<unsigned long int> du{1L};
 }
 
 // MSC: declare dllimport void @"?to_be_imported@?$C@H@@QEAAXXZ"
@@ -64,3 +116,20 @@ void use() {
 
 // MSC: define linkonce_odr dso_local void @"?not_to_be_imported@?$C@H@@QEAAXXZ"
 // GNU: define linkonce_odr dso_local void @_ZN1CIiE18not_to_be_importedEv
+
+// MSC: declare dllimport noundef ptr @"??0?$D@J@@QEAA@J@Z"
+// MSC: declare dso_local noundef ptr @"??0?$D@K@@QEAA@J@Z"
+// GNU: define linkonce_odr dso_local void @_ZN1DIiEC1Ei
+// GNU: define linkonce_odr dso_local void @_ZN1DIjEC1Ei
+// GNU: declare dllimport void @_ZN1DIlEC1El
+// GNU: declare dso_local void @_ZN1DImEC1El
+// GNU: define linkonce_odr dso_local void @_ZN1DIiEC2Ei
+// GNU: define linkonce_odr dso_local void @_ZN1DIjEC2Ei
+
+// MSC: declare dllimport void @"?to_be_imported@?$D@H@@UEAAXXZ"
+// MSC: declare dso_local void @"?to_be_instantiated@?$D@H@@UEAAXXZ"
+// MSC: declare dllimport void @"?to_be_imported_explicitly@?$D@H@@UEAAXXZ"
+
+// MSC: declare dso_local void @"?to_be_imported@?$D@I@@UEAAXXZ"
+// MSC: declare dso_local void @"?to_be_instantiated@?$D@I@@UEAAXXZ"
+// MSC: declare dllimport void @"?to_be_imported_explicitly@?$D@I@@UEAAXXZ"
-- 
2.51.2

