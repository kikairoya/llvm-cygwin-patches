name: Build LLVM Cygwin binary with patches
on:
  schedule:
    - cron: '18 22 * * *'
    - cron: '19 17 * * 1'
    - cron: '20 17 * * 5'
    - cron: '21 17 * * 0'
    - cron: '22  8 * * 1'
    - cron: '23  8 * * 2'
    - cron: '24  8 * * 3'
    - cron: '25  8 * * 4'
    - cron: '26  8 * * 5'
  workflow_dispatch:
    inputs:
      config-name:
        description: 'Build config name'
        type: string
        required: false
        default: ''
      save-cache-name:
        description: 'Save built package to cache'
        type: string
        required: false
        default: ''
      use-cache-name:
        description: 'Reuse built package from cache'
        type: string
        required: false
        default: ''
      install-prefix:
        type: string
        required: false
        default: ''
  workflow_call:
    inputs:
      config-name:
        description: 'Build config name'
        type: string
        required: false
        default: ''
      prereq-artifacts:
        description: Additional artifacts to be used
        type: string
        required: false
        default: ''
      install-prefix:
        description: The path prefixed in package archive
        type: string
        required: false
        default: ''
      build-name:
        type: string
        required: false
        default: ''
      patch-commit:
        type: string
        required: false
        default: ''
      source-artifact:
        type: string
        required: false
        default: ''
      source-retention-days:
        type: number
        required: false
        default: 0
      build-retention-days:
        type: number
        required: false
        default: 0
      install-retention-days:
        type: number
        required: false
        default: 0
      save-cache-name:
        type: string
        required: false
        default: ''
      use-cache-name:
        type: string
        required: false
        default: ''
      source-artifact-suffix:
        type: string
        description: Suffix to source and patch artifacts
        required: false
        default: ''
      assume-patchset:
        type: string
        required: false
        default: '.'
    outputs:
      config-name:
        value: ${{ jobs.select.outputs.config-name }}
      patch-path:
        value: ${{ jobs.select.outputs.patch-path }}
      patch-commit:
        value: ${{ jobs.select.outputs.patch-commit }}
      build-name:
        value: ${{ jobs.select.outputs.build-name }}
      source-artifact:
        value: ${{ jobs.select.outputs.source-artifact }}
      build-artifacts:
        value: ${{ jobs.collect-results.outputs.build-artifacts }}
      install-artifacts:
        value: ${{ jobs.collect-results.outputs.install-artifacts }}

run-name: >-
  Build LLVM binary with Cygwin patches ${{
    (startsWith(github.event.schedule, '18') && 'scheduled cygwin-dylib') ||
    (startsWith(github.event.schedule, '19') && 'scheduled cygwin-runtimes') ||
    (startsWith(github.event.schedule, '20') && 'scheduled cygwin-stage1') ||
    (startsWith(github.event.schedule, '21') && 'scheduled linux-stage1') ||
    (startsWith(github.event.schedule, '22') && 'scheduled linux-dylib') ||
    (startsWith(github.event.schedule, '23') && 'scheduled cross-builddylib-buildonly') ||
    (startsWith(github.event.schedule, '24') && 'scheduled cross-dylib-vanilla-buildonly') ||
    (startsWith(github.event.schedule, '25') && 'scheduled cross-shared-buildonly') ||
    (startsWith(github.event.schedule, '26') && 'scheduled cross-static-buildonly') ||
    inputs.config-name || 'cygwin-dylib'
  }}

jobs:
  select:
    runs-on: ubuntu-latest
    name: Select target

    outputs:
      patch-path: 'patches'
      llvm-path: 'llvm-project'
      config-name: ${{ steps.config.outputs.config-name }}
      build-host: ${{ steps.config.outputs.build-host }}
      enable-llvm: ${{ steps.config.outputs.enable-llvm }}
      #disable-llvm-test: ${{ steps.config.outputs.disable-llvm-test }}
      #enable-clang: ${{ steps.config.outputs.enable-clang }}
      #disable-clang-test: ${{ steps.config.outputs.disable-clang-test }}
      #enable-lld: ${{ steps.config.outputs.enable-lld }}
      #disable-lld-test: ${{ steps.config.outputs.disable-lld-test }}
      enable-runtimes: ${{ steps.config.outputs.enable-runtimes }}
      #disable-runtimes-test: ${{ steps.config.outputs.disable-runtimes-test }}
      build-name: ${{ inputs.build-name || steps.prepare-tree.outputs.build-name }}
      patch-commit: ${{ inputs.patch-commit || steps.prepare-tree.outputs.patch-commit }}
      source-artifact: ${{ inputs.source-artifact || steps.prepare-tree.outputs.source-artifact }}
      prereq-artifacts: ${{ inputs.source-artifact || steps.prepare-tree.outputs.source-artifact }}${{ steps.config.outputs.prereq-artifacts }}
      save-cache-name: ${{ inputs.save-cache-name || steps.config.outputs.save-cache-name }}
      use-cache-name: ${{ inputs.use-cache-name || steps.config.outputs.use-cache-name }}
      install-prefix: ${{ inputs.install-prefix || steps.config.outputs.save-cache-name || steps.config.outputs.config-name || '/' }}
      save-instrument: ${{ steps.config.outputs.save-instrument }}

    steps:
      - name: prepare patches
        id: checkout-self
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          path: self

      - run: |
          echo "$ALL_INPUTS"
          if [ -n "$SOURCE_ARTIFACT" ]; then
            [ "$BUILD_NAME" ]
            [ "$PATCH_COMMIT" ]
          fi
          if [ -n "$PREREQ_ARTIFACTS" ]; then
            echo "prereq-artifacts=,$PREREQ_ARTIFACTS" >> "$GITHUB_OUTPUT"
          fi
          [ "$GITHUB_EVENT_SCHEDULE$CONFIG_NAME" ]
          map=(
            [18]=cygwin-dylib
            [19]=cygwin-runtimes
            [20]=cygwin-stage1
            [21]=linux-stage1
            [22]=linux-dylib
            [23]=cross-builddylib-buildonly
            [24]=cross-dylib-vanilla-buildonly
            [25]=cross-shared-buildonly
            [26]=cross-static-buildonly
          )
          sched="$(echo $GITHUB_EVENT_SCHEDULE | cut -b1-2)"
          conf=${map[$sched]:-${CONFIG_NAME:-cygwin-dylib}}
          echo "config-name=$conf" >> "$GITHUB_OUTPUT"
          cat "self/config/$conf/conf.txt" >> "$GITHUB_OUTPUT"
          echo -n "::notice title=building with $conf::"
          sed -e 's/$/%0A/g' < "self/config/$conf/conf.txt" | tr -d '\n'
        env:
          CONFIG_NAME: ${{ inputs.config-name }}
          GITHUB_EVENT_SCHEDULE: ${{ github.event.schedule }}
          SOURCE_ARTIFACT: ${{ inputs.source-artifact }}
          PREREQ_ARTIFACTS: ${{ inputs.prereq-artifacts }}
          BUILD_NAME: ${{ inputs.build-name }}
          PATCH_COMMIT: ${{ inputs.patch-commit }}
          ALL_INPUTS: ${{ toJson(inputs) }}
          GITHUB_EVENT: ${{ toJson(github.event) }}
          INSTALL_PREFIX: ${{ inputs.install-prefix }}
          SAVE_CACHE_NAME: ${{ inputs.save-cache-name }}
        id: config

      - name: prepare build tree
        id: prepare-tree
        if: ${{ ! inputs.source-artifact }}
        uses: ./self/.github/actions/prepare-llvm-tree
        with:
          llvm-path: 'llvm-project'
          remote-ref: ${{ steps.config.outputs.upstream-branch }}
          patch-path: 'patches'
          patch-ref: ''
          patch-series: ${{ steps.config.outputs.patch-series }}
          cygwin-root: ''
          source-retention-days: ${{ inputs.source-retention-days }}
          name-suffix: ${{ inputs.source-artifact-suffix }}

      - name: check patchset
        run: |
          if [ -n "$SOURCE_ARTIFACT" ]; then
            test "$ASSUME_PATCHSET" = "$PATCH_SERIES"
          else
            echo -n "::notice title=$(git -C llvm-project show --format='format:%H (%ci) %s' -s "${UPSTREAM_COMMIT}" | sed 's/::/%3A%3A/g')::"
            git -C llvm-project show -s "${UPSTREAM_COMMIT}" | sed 's/$/%0A/g' | tr -d '\n'
          fi
        shell: bash
        env:
          SOURCE_ARTIFACT: ${{ inputs.source-artifact }}
          ASSUME_PATCHSET: ${{ inputs.assume-patchset }}
          PATCH_SERIES: ${{ steps.config.outputs.patch-series }}
          UPSTREAM_COMMIT: ${{ steps.prepare-tree.outputs.upstream-commit }}

  build-llvm:
    needs: select
    runs-on: ${{ needs.select.outputs.build-host }}
    if: ${{ needs.select.outputs.enable-llvm }}
    name: Build LLVM

    outputs:
      artifacts: ${{ needs.select.outputs.prereq-artifacts }},${{ steps.build.outputs.build-artifact }}
      build-artifact: ${{ steps.build.outputs.build-artifact }}
      install-artifact: ${{ steps.build.outputs.install-artifact }}
      check-target: ${{ steps.build.outputs.check-target }}

    steps:
      - name: Maximize build disk space
        if: ${{ runner.os == 'Linux' }}
        uses: easimon/maximize-build-space@fc881a613ad2a34aca9c9624518214ebc21dfc0c # v10

      - name: configure Pagefile
        if: ${{ runner.os == 'Windows' }}
        uses: al-cheb/configure-pagefile-action@a3b6ebd6b634da88790d9c58d4b37a7f4a7b8708 # v1.4
        with:
          minimum-size: 16GB
          disk-root: 'C:'

      - run: git config --global core.autocrlf input

      - name: prepare patches
        id: checkout-self
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          path: self

      - name: prepare Cygwin
        id: prepare-cygwin
        uses: ./self/.github/actions/prepare-cygwin-root

      - name: restore build tree
        id: prepare-tree
        uses: ./self/.github/actions/restore-llvm-tree
        with:
          config-name: ${{ needs.select.outputs.config-name }}
          patch-path: ${{ needs.select.outputs.patch-path }}
          patch-ref: ${{ needs.select.outputs.patch-commit }}
          cygwin-root: ${{ steps.prepare-cygwin.outputs.root }}
          artifact-ids: ${{ needs.select.outputs.prereq-artifacts }}
          use-cache-name: ${{ needs.select.outputs.use-cache-name }}

      - name: build llvm
        id: build
        uses: ./self/.github/actions/build-llvm
        with:
          llvm-path: ${{ needs.select.outputs.llvm-path }}
          patch-path: ${{ needs.select.outputs.patch-path }}
          config-name: ${{ needs.select.outputs.config-name }}
          cygwin-root: ${{ steps.prepare-cygwin.outputs.root }}
          build-project: llvm
          build-target: 'all,-check'
          check-target: check
          build-name: ${{ needs.select.outputs.build-name }}
          install-prefix: ${{ needs.select.outputs.install-prefix }}
          save-instrument: ${{ needs.select.outputs.save-instrument }}
          build-retention-days: ${{ inputs.build-retention-days }}
          install-retention-days: ${{ inputs.install-retention-days }}

  check-llvm:
    needs: [select, build-llvm]
    runs-on: ${{ needs.select.outputs.build-host }}
    if: ${{ needs.build-llvm.outputs.check-target }}
    name: Check LLVM

    steps:
      - name: Maximize build disk space
        if: ${{ runner.os == 'Linux' }}
        uses: easimon/maximize-build-space@fc881a613ad2a34aca9c9624518214ebc21dfc0c # v10

      - name: configure Pagefile
        if: ${{ runner.os == 'Windows' }}
        uses: al-cheb/configure-pagefile-action@a3b6ebd6b634da88790d9c58d4b37a7f4a7b8708 # v1.4
        with:
          minimum-size: 16GB
          disk-root: 'C:'

      - run: git config --global core.autocrlf input

      - name: prepare patches
        id: checkout-self
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          path: self

      - name: prepare Cygwin
        id: prepare-cygwin
        uses: ./self/.github/actions/prepare-cygwin-root

      - name: restore build tree
        id: prepare-tree
        uses: ./self/.github/actions/restore-llvm-tree
        with:
          config-name: ${{ needs.select.outputs.config-name }}
          patch-path: ${{ needs.select.outputs.patch-path }}
          patch-ref: ${{ needs.select.outputs.patch-commit }}
          cygwin-root: ${{ steps.prepare-cygwin.outputs.root }}
          artifact-ids: ${{ needs.build-llvm.outputs.artifacts }}
          use-cache-name: ${{ needs.select.outputs.use-cache-name }}

      - name: check llvm
        id: check
        uses: ./self/.github/actions/build-llvm
        with:
          llvm-path: ${{ needs.select.outputs.llvm-path }}
          patch-path: ${{ needs.select.outputs.patch-path }}
          config-name: ${{ needs.select.outputs.config-name }}
          cygwin-root: ${{ steps.prepare-cygwin.outputs.root }}
          build-project: llvm
          build-target: ${{ needs.build-llvm.outputs.check-target }}
          build-name: ${{ needs.select.outputs.build-name }}

  # build-clang:
  #   needs: [select, build-llvm]
  #   runs-on: ${{ needs.select.outputs.build-host }}
  #   if: ${{ needs.select.outputs.enable-clang }}
  #   name: Build Clang

  #   outputs:
  #     artifacts: ${{ needs.build-llvm.outputs.artifacts }},${{ steps.build.outputs.build-artifact }}
  #     build-artifact: ${{ steps.build.outputs.build-artifact }}
  #     install-artifact: ${{ steps.build.outputs.install-artifact }}
  #     check-target: ${{ steps.build.outputs.check-target }}

  #   steps:
  #     - name: Maximize build disk space
  #       if: ${{ runner.os == 'Linux' }}
  #       uses: easimon/maximize-build-space@fc881a613ad2a34aca9c9624518214ebc21dfc0c # v10

  #     - name: configure Pagefile
  #       if: ${{ runner.os == 'Windows' }}
  #       uses: al-cheb/configure-pagefile-action@a3b6ebd6b634da88790d9c58d4b37a7f4a7b8708 # v1.4
  #       with:
  #         minimum-size: 16GB
  #         disk-root: 'C:'

  #     - run: git config --global core.autocrlf input

  #     - name: prepare patches
  #       id: checkout-self
  #       uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
  #       with:
  #         path: self

  #     - name: prepare Cygwin
  #       id: prepare-cygwin
  #       uses: ./self/.github/actions/prepare-cygwin-root

  #     - name: restore build tree
  #       id: prepare-tree
  #       uses: ./self/.github/actions/restore-llvm-tree
  #       with:
  #         patch-path: ${{ needs.select.outputs.patch-path }}
  #         config-name: ${{ needs.select.outputs.config-name }}
  #         patch-ref: ${{ needs.select.outputs.patch-commit }}
  #         cygwin-root: ${{ steps.prepare-cygwin.outputs.root }}
  #         artifact-ids: ${{ needs.build-llvm.outputs.artifacts }}
  #         use-cache-name: ${{ needs.select.outputs.use-cache-name }}

  #     - name: build clang
  #       id: build
  #       uses: ./self/.github/actions/build-llvm
  #       with:
  #         llvm-path: ${{ needs.select.outputs.llvm-path }}
  #         patch-path: ${{ needs.select.outputs.patch-path }}
  #         config-name: ${{ needs.select.outputs.config-name }}
  #         cygwin-root: ${{ steps.prepare-cygwin.outputs.root }}
  #         build-project: clang
  #         build-target: 'all,-check-all'
  #         check-target: check-all
  #         build-name: ${{ needs.select.outputs.build-name }}
  #         install-prefix: ${{ needs.select.outputs.install-prefix }}

  # check-clang:
  #   needs: [select, build-clang]
  #   runs-on: ${{ needs.select.outputs.build-host }}
  #   if: ${{ needs.build-clang.outputs.check-target }}
  #   name: Check Clang

  #   steps:
  #     - name: Maximize build disk space
  #       if: ${{ runner.os == 'Linux' }}
  #       uses: easimon/maximize-build-space@fc881a613ad2a34aca9c9624518214ebc21dfc0c # v10

  #     - run: git config --global core.autocrlf input

  #     - name: prepare patches
  #       id: checkout-self
  #       uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
  #       with:
  #         path: self

  #     - name: prepare Cygwin
  #       id: prepare-cygwin
  #       uses: ./self/.github/actions/prepare-cygwin-root

  #     - name: restore build tree
  #       id: prepare-tree
  #       uses: ./self/.github/actions/restore-llvm-tree
  #       with:
  #         config-name: ${{ needs.select.outputs.config-name }}
  #         patch-path: ${{ needs.select.outputs.patch-path }}
  #         patch-ref: ${{ needs.select.outputs.patch-commit }}
  #         cygwin-root: ${{ steps.prepare-cygwin.outputs.root }}
  #         artifact-ids: ${{ needs.build-clang.outputs.artifacts }}
  #         use-cache-name: ${{ needs.select.outputs.use-cache-name }}

  #     - name: check clang
  #       id: check
  #       uses: ./self/.github/actions/build-llvm
  #       with:
  #         llvm-path: ${{ needs.select.outputs.llvm-path }}
  #         patch-path: ${{ needs.select.outputs.patch-path }}
  #         config-name: ${{ needs.select.outputs.config-name }}
  #         cygwin-root: ${{ steps.prepare-cygwin.outputs.root }}
  #         build-project: clang
  #         build-target: ${{ steps.build-clang.outputs.check-target }}
  #         build-name: ${{ needs.select.outputs.build-name }}

  # build-lld:
  #   needs: [select, build-llvm]
  #   runs-on: ${{ needs.select.outputs.build-host }}
  #   if: ${{ needs.select.outputs.enable-lld }}
  #   name: Build LLD

  #   outputs:
  #     artifacts: ${{ needs.build-llvm.outputs.artifacts }},${{ steps.build.outputs.build-artifact }}
  #     build-artifact: ${{ steps.build.outputs.build-artifact }}
  #     install-artifact: ${{ steps.build.outputs.install-artifact }}
  #     check-target: ${{ steps.build.outputs.check-target }}

  #   steps:
  #     - name: Maximize build disk space
  #       if: ${{ runner.os == 'Linux' }}
  #       uses: easimon/maximize-build-space@fc881a613ad2a34aca9c9624518214ebc21dfc0c # v10

  #     - run: git config --global core.autocrlf input

  #     - name: prepare patches
  #       id: checkout-self
  #       uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
  #       with:
  #         path: self

  #     - name: prepare Cygwin
  #       id: prepare-cygwin
  #       uses: ./self/.github/actions/prepare-cygwin-root

  #     - name: restore build tree
  #       id: prepare-tree
  #       uses: ./self/.github/actions/restore-llvm-tree
  #       with:
  #         config-name: ${{ needs.select.outputs.config-name }}
  #         patch-path: ${{ needs.select.outputs.patch-path }}
  #         patch-ref: ${{ needs.select.outputs.patch-commit }}
  #         cygwin-root: ${{ steps.prepare-cygwin.outputs.root }}
  #         artifact-ids: ${{ needs.build-llvm.outputs.artifacts }}
  #         use-cache-name: ${{ needs.select.outputs.use-cache-name }}

  #     - name: build lld
  #       id: build
  #       uses: ./self/.github/actions/build-llvm
  #       with:
  #         llvm-path: ${{ needs.select.outputs.llvm-path }}
  #         patch-path: ${{ needs.select.outputs.patch-path }}
  #         config-name: ${{ needs.select.outputs.config-name }}
  #         cygwin-root: ${{ steps.prepare-cygwin.outputs.root }}
  #         build-project: lld
  #         build-target: 'lld,-check-lld'
  #         check-target: check-lld
  #         build-name: ${{ needs.select.outputs.build-name }}
  #         install-prefix: ${{ needs.select.outputs.install-prefix }}

  # check-lld:
  #   needs: [select, build-lld]
  #   runs-on: ${{ needs.select.outputs.build-host }}
  #   if: ${{ needs.build-lld.outputs.check-target  }}
  #   name: Check LLD

  #   steps:
  #     - name: Maximize build disk space
  #       if: ${{ runner.os == 'Linux' }}
  #       uses: easimon/maximize-build-space@fc881a613ad2a34aca9c9624518214ebc21dfc0c # v10

  #     - run: git config --global core.autocrlf input

  #     - name: prepare patches
  #       id: checkout-self
  #       uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
  #       with:
  #         path: self

  #     - name: prepare Cygwin
  #       id: prepare-cygwin
  #       uses: ./self/.github/actions/prepare-cygwin-root

  #     - name: restore build tree
  #       id: prepare-tree
  #       uses: ./self/.github/actions/restore-llvm-tree
  #       with:
  #         config-name: ${{ needs.select.outputs.config-name }}
  #         patch-path: ${{ needs.select.outputs.patch-path }}
  #         patch-ref: ${{ needs.select.outputs.patch-commit }}
  #         cygwin-root: ${{ steps.prepare-cygwin.outputs.root }}
  #         artifact-ids: ${{ needs.build-lld.outputs.artifacts }}
  #         use-cache-name: ${{ needs.select.outputs.use-cache-name }}

  #     - name: check lld
  #       id: check
  #       uses: ./self/.github/actions/build-llvm
  #       with:
  #         llvm-path: ${{ needs.select.outputs.llvm-path }}
  #         patch-path: ${{ needs.select.outputs.patch-path }}
  #         config-name: ${{ needs.select.outputs.config-name }}
  #         cygwin-root: ${{ steps.prepare-cygwin.outputs.root }}
  #         build-project: lld
  #         build-target: ${{ needs.build-lld.outputs.check-target }}
  #         build-name: ${{ needs.select.outputs.build-name }}

  build-runtimes:
    needs: select
    runs-on: ${{ needs.select.outputs.build-host }}
    if: ${{ needs.select.outputs.enable-runtimes }}
    name: Build Runtimes

    outputs:
      artifacts: ${{ needs.select.outputs.prereq-artifacts }},${{ steps.build.outputs.build-artifact }}
      build-artifact: ${{ steps.build.outputs.build-artifact }}
      install-artifact: ${{ steps.build.outputs.install-artifact }}
      check-target: ${{ steps.build.outputs.check-target }}

    steps:
      - name: Maximize build disk space
        if: ${{ runner.os == 'Linux' }}
        uses: easimon/maximize-build-space@fc881a613ad2a34aca9c9624518214ebc21dfc0c # v10

      - run: git config --global core.autocrlf input

      - name: prepare patches
        id: checkout-self
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          path: self

      - name: prepare Cygwin
        id: prepare-cygwin
        uses: ./self/.github/actions/prepare-cygwin-root

      - name: restore build tree
        id: prepare-tree
        uses: ./self/.github/actions/restore-llvm-tree
        with:
          patch-path: ${{ needs.select.outputs.patch-path }}
          config-name: ${{ needs.select.outputs.config-name }}
          patch-ref: ${{ needs.select.outputs.patch-commit }}
          cygwin-root: ${{ steps.prepare-cygwin.outputs.root }}
          artifact-ids: ${{ needs.select.outputs.prereq-artifacts }}
          use-cache-name: ${{ needs.select.outputs.use-cache-name }}

      - name: build runtimes
        id: build
        uses: ./self/.github/actions/build-llvm
        with:
          llvm-path: ${{ needs.select.outputs.llvm-path }}
          patch-path: ${{ needs.select.outputs.patch-path }}
          config-name: ${{ needs.select.outputs.config-name }}
          cygwin-root: ${{ steps.prepare-cygwin.outputs.root }}
          build-project: runtimes
          check-target: check-runtimes
          build-name: ${{ needs.select.outputs.build-name }}
          install-prefix: ${{ needs.select.outputs.install-prefix }}

  check-runtimes:
    needs: [select, build-runtimes]
    runs-on: ${{ needs.select.outputs.build-host }}
    if: ${{ needs.build-runtimes.outputs.check-target }}
    name: Check Runtimes

    steps:
      - name: Maximize build disk space
        if: ${{ runner.os == 'Linux' }}
        uses: easimon/maximize-build-space@fc881a613ad2a34aca9c9624518214ebc21dfc0c # v10

      - run: git config --global core.autocrlf input

      - name: prepare patches
        id: checkout-self
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          path: self

      - name: prepare Cygwin
        id: prepare-cygwin
        uses: ./self/.github/actions/prepare-cygwin-root

      - name: restore build tree
        id: prepare-tree
        uses: ./self/.github/actions/restore-llvm-tree
        with:
          config-name: ${{ needs.select.outputs.config-name }}
          patch-path: ${{ needs.select.outputs.patch-path }}
          patch-ref: ${{ needs.select.outputs.patch-commit }}
          cygwin-root: ${{ steps.prepare-cygwin.outputs.root }}
          artifact-ids: ${{ needs.build-runtimes.outputs.artifacts }}
          use-cache-name: ${{ needs.select.outputs.use-cache-name }}

      - name: check runtimes
        id: check
        uses: ./self/.github/actions/build-llvm
        with:
          llvm-path: ${{ needs.select.outputs.llvm-path }}
          patch-path: ${{ needs.select.outputs.patch-path }}
          config-name: ${{ needs.select.outputs.config-name }}
          cygwin-root: ${{ steps.prepare-cygwin.outputs.root }}
          build-project: runtimes
          build-target: ${{ needs.build-runtimes.outputs.check-target }}
          build-name: ${{ needs.select.outputs.build-name }}

  collect-results:
    #needs: [select, collect-results, build-llvm, check-llvm, build-clang, check-clang, build-lld, check-lld, build-runtimes, check-runtimes]
    needs: [select, build-llvm, check-llvm, build-runtimes, check-runtimes]
    runs-on: ubuntu-latest
    if: ${{ always() && ! cancelled() && ! failure()}}

    outputs:
      build-artifacts: ${{ steps.collect.outputs.build-artifacts }}
      install-artifacts: ${{ steps.collect.outputs.install-artifacts }}

    steps:
      - id: collect
        env:
          LLVM_BUILD: ${{ needs.build-llvm.outputs.build-artifact }}
          LLVM_INSTALL: ${{ needs.build-llvm.outputs.install-artifact }}
          #CLANG_BUILD: ${{ needs.build-clang.outputs.build-artifact }}
          #CLANG_INSTALL: ${{ needs.build-clang.outputs.install-artifact }}
          #LLD_BUILD: ${{ needs.build-lld.outputs.build-artifact }}
          #LLD_INSTALL: ${{ needs.build-lld.outputs.install-artifact }}
          RUNTIMES_BUILD: ${{ needs.build-runtimes.outputs.build-artifact }}
          RUNTIMES_INSTALL: ${{ needs.build-runtimes.outputs.install-artifact }}
          SAVE_NAME: ${{ needs.select.outputs.save-cache-name }}
        run: |
          echo build-artifacts=$(echo $LLVM_BUILD $CLANG_BUILD $LLD_BUILD $RUNTIMES_BUILD | sed 's/  */,/g;s/ //g') >> "$GITHUB_OUTPUT"
          ia="$(echo $LLVM_INSTALL $CLANG_INSTALL $LLD_INSTALL $RUNTIMES_INSTALL | sed 's/  */,/g;s/ //g')"
          echo "install-artifacts=$ia" >> "$GITHUB_OUTPUT"
          if [ -n "$SAVE_NAME" ] && [ -n "$ia" ]; then
            echo cache-key=$SAVE_NAME-${ia//,/_} >> "$GITHUB_OUTPUT"
          fi
        shell: bash

      - uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0 # v5.0.0
        if: ${{ steps.collect.outputs.cache-key }}
        with:
          artifact-ids: ${{ steps.collect.outputs.install-artifacts }}
          merge-multiple: true

      - uses: actions/cache/save@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        if: ${{ steps.collect.outputs.cache-key }}
        with:
          key: ${{ steps.collect.outputs.cache-key }}
          enableCrossOsArchive: true
          path: 'package-*.tar'
