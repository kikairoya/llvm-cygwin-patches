From e0c90d47047e77533b851ae93e8e09f7cfce3bba Mon Sep 17 00:00:00 2001
From: kikairoya <kikairoya@gmail.com>
Date: Fri, 16 May 2025 18:24:46 +0900
Subject: [PATCH 19/28] [Clang-Tools] Use `clang_target_link_libraries` for
 c-index-test and libclang

`target_link_libraries` shouldn't be used to link clang libraries because
that may cause symbol dup when CLANG_LINK_CLANG_DYLIB=ON.
`clang_target_link_libraries` correctly handles both of static and dylib builds.
---
 clang/tools/c-index-test/CMakeLists.txt |  6 +++++
 clang/tools/libclang/CMakeLists.txt     | 29 +++++++++++++------------
 2 files changed, 21 insertions(+), 14 deletions(-)

diff --git a/clang/tools/c-index-test/CMakeLists.txt b/clang/tools/c-index-test/CMakeLists.txt
index 24e7c9692ca56e6c160d5164b627e87c60a13a6c..3b38a22e1180c4d66a01acfd08ddd37f327aae32 100644
--- a/clang/tools/c-index-test/CMakeLists.txt
+++ b/clang/tools/c-index-test/CMakeLists.txt
@@ -18,6 +18,9 @@ if (LLVM_BUILD_STATIC)
   target_link_libraries(c-index-test
     PRIVATE
     libclang_static
+  )
+  clang_target_link_libraries(c-index-test
+    PRIVATE
     clangCodeGen
     clangIndex
   )
@@ -25,6 +28,9 @@ else()
   target_link_libraries(c-index-test
     PRIVATE
     libclang
+  )
+  clang_target_link_libraries(c-index-test
+    PRIVATE
     clangAST
     clangBasic
     clangFrontend
diff --git a/clang/tools/libclang/CMakeLists.txt b/clang/tools/libclang/CMakeLists.txt
index e0ff7605b68b8e3a1fe04b2cdcd1a01f7dd82b41..9571598f9987a796e1eda2417925ca46b58314c5 100644
--- a/clang/tools/libclang/CMakeLists.txt
+++ b/clang/tools/libclang/CMakeLists.txt
@@ -57,20 +57,6 @@ set(SOURCES
   ../../include/clang-c/Index.h
   )
 
-set(LIBS
-  clangAST
-  clangBasic
-  clangDriver
-  clangExtractAPI
-  clangFrontend
-  clangIndex
-  clangLex
-  clangRewrite
-  clangSema
-  clangSerialization
-  clangTooling
-)
-
 if (HAVE_LIBDL)
   list(APPEND LIBS ${CMAKE_DL_LIBS})
 elseif (CLANG_BUILT_STANDALONE)
@@ -149,6 +135,21 @@ add_clang_library(libclang ${ENABLE_SHARED} ${ENABLE_STATIC} INSTALL_WITH_TOOLCH
   TargetParser
   )
 
+clang_target_link_libraries(libclang
+  PRIVATE
+  clangAST
+  clangBasic
+  clangDriver
+  clangExtractAPI
+  clangFrontend
+  clangIndex
+  clangLex
+  clangRewrite
+  clangSema
+  clangSerialization
+  clangTooling
+)
+
 if(ENABLE_STATIC)
   foreach(name libclang obj.libclang libclang_static)
     if (TARGET ${name})
-- 
2.51.2

