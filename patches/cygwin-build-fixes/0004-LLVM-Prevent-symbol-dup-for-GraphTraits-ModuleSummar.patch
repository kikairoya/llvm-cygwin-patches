From 43b69ef1c6e23382aad8c1cd78a9a3cfb25682af Mon Sep 17 00:00:00 2001
From: kikairoya <kikairoya@gmail.com>
Date: Fri, 5 Dec 2025 20:06:12 +0900
Subject: [PATCH 04/19] [LLVM] Prevent symbol dup for
 GraphTraits<ModuleSummaryIndex *>::getEntryNode

---
 llvm/include/llvm/IR/ModuleSummaryIndex.h | 10 +---------
 llvm/lib/IR/ModuleSummaryIndex.cpp        | 11 +++++++++++
 2 files changed, 12 insertions(+), 9 deletions(-)

diff --git a/llvm/include/llvm/IR/ModuleSummaryIndex.h b/llvm/include/llvm/IR/ModuleSummaryIndex.h
index 31c2f13a63e5f3754ca01c9887ba05cdf325a120..e3bb6420ea6a308718fa868e077b9a374d5c29b6 100644
--- a/llvm/include/llvm/IR/ModuleSummaryIndex.h
+++ b/llvm/include/llvm/IR/ModuleSummaryIndex.h
@@ -2055,15 +2055,7 @@ template <> struct GraphTraits<ValueInfo> {
 
 template <>
 struct GraphTraits<ModuleSummaryIndex *> : public GraphTraits<ValueInfo> {
-  static NodeRef getEntryNode(ModuleSummaryIndex *I) {
-    std::unique_ptr<GlobalValueSummary> Root =
-        std::make_unique<FunctionSummary>(I->calculateCallGraphRoot());
-    GlobalValueSummaryInfo G(I->haveGVs());
-    G.addSummary(std::move(Root));
-    static auto P =
-        GlobalValueSummaryMapTy::value_type(GlobalValue::GUID(0), std::move(G));
-    return ValueInfo(I->haveGVs(), &P);
-  }
+  LLVM_ABI static NodeRef getEntryNode(ModuleSummaryIndex *I);
 };
 } // end namespace llvm
 
diff --git a/llvm/lib/IR/ModuleSummaryIndex.cpp b/llvm/lib/IR/ModuleSummaryIndex.cpp
index 9a3bb970494a2ae37f33f38db68dd6e45543beed..46fb2b0f05932fdd547480eb27130c5d740ea949 100644
--- a/llvm/lib/IR/ModuleSummaryIndex.cpp
+++ b/llvm/lib/IR/ModuleSummaryIndex.cpp
@@ -741,3 +741,14 @@ void ModuleSummaryIndex::exportToDot(
 
   OS << "}";
 }
+
+GraphTraits<ValueInfo>::NodeRef
+GraphTraits<ModuleSummaryIndex *>::getEntryNode(ModuleSummaryIndex *I) {
+  std::unique_ptr<GlobalValueSummary> Root =
+      std::make_unique<FunctionSummary>(I->calculateCallGraphRoot());
+  GlobalValueSummaryInfo G(I->haveGVs());
+  G.addSummary(std::move(Root));
+  static auto P =
+      GlobalValueSummaryMapTy::value_type(GlobalValue::GUID(0), std::move(G));
+  return ValueInfo(I->haveGVs(), &P);
+}
-- 
2.52.0

